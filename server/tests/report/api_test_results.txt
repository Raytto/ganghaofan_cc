============================= test session starts ==============================
platform linux -- Python 3.11.13, pytest-7.4.3, pluggy-1.6.0 -- /home/pp/miniconda3/envs/ganghaofan_test/bin/python
cachedir: .pytest_cache
rootdir: /home/pp/mp/ganghaofan_cc/server
plugins: asyncio-0.21.1, anyio-3.7.1
asyncio: mode=Mode.STRICT
collecting ... collected 63 items

tests/test_api/test_admin.py::TestAdminAddons::test_create_addon_success FAILED [  1%]
tests/test_api/test_admin.py::TestAdminAddons::test_create_addon_duplicate_name PASSED [  3%]
tests/test_api/test_admin.py::TestAdminAddons::test_create_addon_unauthorized FAILED [  4%]
tests/test_api/test_admin.py::TestAdminAddons::test_deactivate_addon_success FAILED [  6%]
tests/test_api/test_admin.py::TestAdminAddons::test_deactivate_addon_nonexistent FAILED [  7%]
tests/test_api/test_admin.py::TestAdminMeals::test_publish_meal_success FAILED [  9%]
tests/test_api/test_admin.py::TestAdminMeals::test_publish_meal_duplicate_slot PASSED [ 11%]
tests/test_api/test_admin.py::TestAdminMeals::test_lock_meal_success FAILED [ 12%]
tests/test_api/test_admin.py::TestAdminMeals::test_complete_meal_success FAILED [ 14%]
tests/test_api/test_admin.py::TestAdminMeals::test_cancel_meal_success FAILED [ 15%]
tests/test_api/test_admin.py::TestAdminUsers::test_get_users_list PASSED [ 17%]
tests/test_api/test_admin.py::TestAdminUsers::test_get_users_list_with_filters PASSED [ 19%]
tests/test_api/test_admin.py::TestAdminUsers::test_set_user_admin_status ERROR [ 20%]
tests/test_api/test_admin.py::TestAdminUsers::test_set_user_status ERROR [ 22%]
tests/test_api/test_admin.py::TestAdminUsers::test_adjust_user_balance ERROR [ 23%]
tests/test_api/test_admin.py::TestAdminPermissions::test_non_admin_access_denied FAILED [ 25%]
tests/test_api/test_admin.py::TestAdminPermissions::test_unauthenticated_access_denied FAILED [ 26%]
tests/test_api/test_auth.py::TestAuthRoutes::test_wechat_auth_success FAILED [ 28%]
tests/test_api/test_auth.py::TestAuthRoutes::test_wechat_auth_missing_code PASSED [ 30%]
tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh FAILED   [ 31%]
tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh_invalid_token PASSED [ 33%]
tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh_missing_token FAILED [ 34%]
tests/test_api/test_auth.py::TestTokenValidation::test_valid_token_access PASSED [ 36%]
tests/test_api/test_auth.py::TestTokenValidation::test_invalid_token_access PASSED [ 38%]
tests/test_api/test_auth.py::TestTokenValidation::test_missing_token_access FAILED [ 39%]
tests/test_api/test_meals.py::TestMealsList::test_get_meals_list PASSED  [ 41%]
tests/test_api/test_meals.py::TestMealsList::test_get_meals_list_with_pagination PASSED [ 42%]
tests/test_api/test_meals.py::TestMealsList::test_get_meals_missing_dates FAILED [ 44%]
tests/test_api/test_meals.py::TestMealsList::test_get_meals_invalid_date_range FAILED [ 46%]
tests/test_api/test_meals.py::TestMealsList::test_get_meals_unauthorized FAILED [ 47%]
tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail FAILED [ 49%]
tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail_nonexistent FAILED [ 50%]
tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail_unauthorized FAILED [ 52%]
tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order FAILED [ 53%]
tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order_nonexistent_meal FAILED [ 55%]
tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order_unauthorized FAILED [ 57%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_success FAILED [ 58%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_missing_meal_id PASSED [ 60%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_nonexistent_meal FAILED [ 61%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_insufficient_balance FAILED [ 63%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_duplicate PASSED [ 65%]
tests/test_api/test_orders.py::TestOrderCreation::test_create_order_unauthorized FAILED [ 66%]
tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_success ERROR [ 68%]
tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_nonexistent ERROR [ 69%]
tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_not_owned ERROR [ 71%]
tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_missing_reason ERROR [ 73%]
tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_unauthorized FAILED [ 74%]
tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail ERROR [ 76%]
tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail_nonexistent ERROR [ 77%]
tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail_unauthorized FAILED [ 79%]
tests/test_api/test_users.py::TestUserProfile::test_get_profile_success ERROR [ 80%]
tests/test_api/test_users.py::TestUserProfile::test_get_profile_unauthorized FAILED [ 82%]
tests/test_api/test_users.py::TestUserBalance::test_get_balance ERROR    [ 84%]
tests/test_api/test_users.py::TestUserBalance::test_get_balance_unauthorized FAILED [ 85%]
tests/test_api/test_users.py::TestUserLedger::test_get_ledger_history ERROR [ 87%]
tests/test_api/test_users.py::TestUserLedger::test_get_ledger_history_with_pagination ERROR [ 88%]
tests/test_api/test_users.py::TestUserLedger::test_get_ledger_unauthorized FAILED [ 90%]
tests/test_api/test_users.py::TestUserOrders::test_get_user_orders ERROR [ 92%]
tests/test_api/test_users.py::TestUserOrders::test_get_user_orders_with_pagination ERROR [ 93%]
tests/test_api/test_users.py::TestUserOrders::test_get_user_orders_unauthorized FAILED [ 95%]
tests/test_api/test_users.py::TestUserStatistics::test_get_order_statistics ERROR [ 96%]
tests/test_api/test_users.py::TestUserStatistics::test_get_transaction_statistics ERROR [ 98%]
tests/test_api/test_users.py::TestUserStatistics::test_get_statistics_unauthorized FAILED [100%]

==================================== ERRORS ====================================
_________ ERROR at setup of TestAdminUsers.test_set_user_admin_status __________
tests/test_api/conftest.py:138: in sample_user_id
    return response.json()["data"]["user_info"]["user_id"]
E   KeyError: 'user_info'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:53,168 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,168 - api.middleware.logging - INFO - [logging.py:31] - [c5dfa718] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,176 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,177 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,178 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,178 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,178 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:53,185 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:53,186 - api.middleware.logging - INFO - [logging.py:44] - [c5dfa718] 200 - Time: 0.018s
2025-08-30 11:52:53,211 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,216 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,217 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,218 - api.middleware.logging - INFO - [logging.py:31] - [f3ad3605] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,228 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,232 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,233 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,233 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,233 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:53,239 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:53,240 - api.middleware.logging - INFO - [logging.py:44] - [f3ad3605] 200 - Time: 0.022s
2025-08-30 11:52:53,254 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,256 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,257 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,258 - api.middleware.logging - INFO - [logging.py:31] - [60d144b7] GET /api/users/profile - Client: testclient
2025-08-30 11:52:53,266 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,267 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,268 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,268 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:53,271 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:53,271 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:53,275 - DatabaseManager - ERROR - [query_operations.py:526] - 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,277 - DatabaseManager - ERROR - [query_operations.py:577] - 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,278 - api.middleware.logging - INFO - [logging.py:44] - [60d144b7] 200 - Time: 0.020s
2025-08-30 11:52:53,280 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,282 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c5dfa718] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [c5dfa718] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [f3ad3605] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [f3ad3605] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [60d144b7] GET /api/users/profile - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    DatabaseManager:query_operations.py:526 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
ERROR    DatabaseManager:query_operations.py:577 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
INFO     api.middleware.logging:logging.py:44 [60d144b7] 200 - Time: 0.020s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
____________ ERROR at setup of TestAdminUsers.test_set_user_status _____________
tests/test_api/conftest.py:138: in sample_user_id
    return response.json()["data"]["user_info"]["user_id"]
E   KeyError: 'user_info'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:53,287 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,288 - api.middleware.logging - INFO - [logging.py:31] - [c0320932] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,297 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,298 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,298 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,298 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,298 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:53,305 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:53,306 - api.middleware.logging - INFO - [logging.py:44] - [c0320932] 200 - Time: 0.018s
2025-08-30 11:52:53,336 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,339 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,339 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,340 - api.middleware.logging - INFO - [logging.py:31] - [e75afd70] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,349 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,349 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,350 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,350 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,350 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:53,356 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:53,357 - api.middleware.logging - INFO - [logging.py:44] - [e75afd70] 200 - Time: 0.017s
2025-08-30 11:52:53,375 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,377 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,378 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,379 - api.middleware.logging - INFO - [logging.py:31] - [6d3ba5fd] GET /api/users/profile - Client: testclient
2025-08-30 11:52:53,388 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,389 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,389 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,389 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:53,392 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:53,392 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:53,396 - DatabaseManager - ERROR - [query_operations.py:526] - 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,398 - DatabaseManager - ERROR - [query_operations.py:577] - 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,399 - api.middleware.logging - INFO - [logging.py:44] - [6d3ba5fd] 200 - Time: 0.021s
2025-08-30 11:52:53,401 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,403 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c0320932] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [c0320932] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [e75afd70] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [e75afd70] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [6d3ba5fd] GET /api/users/profile - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    DatabaseManager:query_operations.py:526 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
ERROR    DatabaseManager:query_operations.py:577 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
INFO     api.middleware.logging:logging.py:44 [6d3ba5fd] 200 - Time: 0.021s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
__________ ERROR at setup of TestAdminUsers.test_adjust_user_balance ___________
tests/test_api/conftest.py:138: in sample_user_id
    return response.json()["data"]["user_info"]["user_id"]
E   KeyError: 'user_info'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:53,412 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,419 - api.middleware.logging - INFO - [logging.py:31] - [7658516b] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,428 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,429 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,430 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,430 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,430 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:53,437 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:53,438 - api.middleware.logging - INFO - [logging.py:44] - [7658516b] 200 - Time: 0.020s
2025-08-30 11:52:53,458 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,461 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,462 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,462 - api.middleware.logging - INFO - [logging.py:31] - [e4846df2] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,472 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,475 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,475 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,475 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,475 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:53,484 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:53,484 - api.middleware.logging - INFO - [logging.py:44] - [e4846df2] 200 - Time: 0.022s
2025-08-30 11:52:53,510 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,512 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,513 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,516 - api.middleware.logging - INFO - [logging.py:31] - [8cf7e186] GET /api/users/profile - Client: testclient
2025-08-30 11:52:53,524 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,525 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,526 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,526 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:53,528 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:53,528 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:53,534 - DatabaseManager - ERROR - [query_operations.py:526] - 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,536 - DatabaseManager - ERROR - [query_operations.py:577] - 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
2025-08-30 11:52:53,538 - api.middleware.logging - INFO - [logging.py:44] - [8cf7e186] 200 - Time: 0.022s
2025-08-30 11:52:53,540 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,542 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7658516b] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [7658516b] 200 - Time: 0.020s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [e4846df2] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [e4846df2] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [8cf7e186] GET /api/users/profile - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    DatabaseManager:query_operations.py:526 查询用户订单统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
ERROR    DatabaseManager:query_operations.py:577 查询用户交易统计失败: unsupported operand type(s) for /: 'NoneType' and 'float'
INFO     api.middleware.logging:logging.py:44 [8cf7e186] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 200 OK"
______ ERROR at setup of TestOrderCancellation.test_cancel_order_success _______
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:55,702 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,705 - api.middleware.logging - INFO - [logging.py:31] - [24e664ab] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,705 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:55,705 - api.middleware.logging - ERROR - [logging.py:57] - [24e664ab] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [24e664ab] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [24e664ab] ERROR -  - Time: 0.000s
____ ERROR at setup of TestOrderCancellation.test_cancel_order_nonexistent _____
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:55,835 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,836 - api.middleware.logging - INFO - [logging.py:31] - [92181d88] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,836 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:55,836 - api.middleware.logging - ERROR - [logging.py:57] - [92181d88] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [92181d88] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [92181d88] ERROR -  - Time: 0.000s
_____ ERROR at setup of TestOrderCancellation.test_cancel_order_not_owned ______
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:55,987 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,988 - api.middleware.logging - INFO - [logging.py:31] - [0d365ef7] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,988 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:55,989 - api.middleware.logging - ERROR - [logging.py:57] - [0d365ef7] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [0d365ef7] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [0d365ef7] ERROR -  - Time: 0.000s
___ ERROR at setup of TestOrderCancellation.test_cancel_order_missing_reason ___
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:56,106 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,107 - api.middleware.logging - INFO - [logging.py:31] - [4956f7ef] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:56,107 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,107 - api.middleware.logging - ERROR - [logging.py:57] - [4956f7ef] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [4956f7ef] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [4956f7ef] ERROR -  - Time: 0.000s
___________ ERROR at setup of TestOrderDetail.test_get_order_detail ____________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:56,264 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,264 - api.middleware.logging - INFO - [logging.py:31] - [2e53c02d] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:56,265 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,265 - api.middleware.logging - ERROR - [logging.py:57] - [2e53c02d] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [2e53c02d] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [2e53c02d] ERROR -  - Time: 0.000s
_____ ERROR at setup of TestOrderDetail.test_get_order_detail_nonexistent ______
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:56,383 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,384 - api.middleware.logging - INFO - [logging.py:31] - [b146a080] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:56,384 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,384 - api.middleware.logging - ERROR - [logging.py:57] - [b146a080] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b146a080] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [b146a080] ERROR -  - Time: 0.000s
__________ ERROR at setup of TestUserProfile.test_get_profile_success __________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:56,677 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,678 - api.middleware.logging - INFO - [logging.py:31] - [5675897e] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:56,678 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,678 - api.middleware.logging - ERROR - [logging.py:57] - [5675897e] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [5675897e] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [5675897e] ERROR -  - Time: 0.000s
______________ ERROR at setup of TestUserBalance.test_get_balance ______________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:56,965 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,965 - api.middleware.logging - INFO - [logging.py:31] - [40bc55d8] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:56,965 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,966 - api.middleware.logging - ERROR - [logging.py:57] - [40bc55d8] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [40bc55d8] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [40bc55d8] ERROR -  - Time: 0.000s
___________ ERROR at setup of TestUserLedger.test_get_ledger_history ___________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:57,242 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,243 - api.middleware.logging - INFO - [logging.py:31] - [fd621937] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:57,243 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,243 - api.middleware.logging - ERROR - [logging.py:57] - [fd621937] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [fd621937] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [fd621937] ERROR -  - Time: 0.000s
___ ERROR at setup of TestUserLedger.test_get_ledger_history_with_pagination ___
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:57,404 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,405 - api.middleware.logging - INFO - [logging.py:31] - [4493a861] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:57,405 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,405 - api.middleware.logging - ERROR - [logging.py:57] - [4493a861] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [4493a861] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [4493a861] ERROR -  - Time: 0.000s
____________ ERROR at setup of TestUserOrders.test_get_user_orders _____________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:57,681 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,682 - api.middleware.logging - INFO - [logging.py:31] - [702c4a3d] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:57,682 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,683 - api.middleware.logging - ERROR - [logging.py:57] - [702c4a3d] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [702c4a3d] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [702c4a3d] ERROR -  - Time: 0.000s
____ ERROR at setup of TestUserOrders.test_get_user_orders_with_pagination _____
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:57,802 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,803 - api.middleware.logging - INFO - [logging.py:31] - [82a4568f] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:57,803 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,803 - api.middleware.logging - ERROR - [logging.py:57] - [82a4568f] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [82a4568f] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [82a4568f] ERROR -  - Time: 0.000s
________ ERROR at setup of TestUserStatistics.test_get_order_statistics ________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:58,081 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:58,085 - api.middleware.logging - INFO - [logging.py:31] - [101b6b30] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:58,085 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:58,085 - api.middleware.logging - ERROR - [logging.py:57] - [101b6b30] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [101b6b30] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [101b6b30] ERROR -  - Time: 0.000s
_____ ERROR at setup of TestUserStatistics.test_get_transaction_statistics _____
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/conftest.py:28: in auth_token
    response = client.post("/api/auth/wechat/login", json=auth_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:58,243 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:58,244 - api.middleware.logging - INFO - [logging.py:31] - [6aaccffc] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:58,244 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:58,244 - api.middleware.logging - ERROR - [logging.py:57] - [6aaccffc] ERROR -  - Time: 0.000s
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [6aaccffc] POST /api/auth/wechat/login - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [6aaccffc] ERROR -  - Time: 0.000s
=================================== FAILURES ===================================
__________________ TestAdminAddons.test_create_addon_success ___________________
tests/test_api/test_admin.py:27: in test_create_addon_success
    assert response.status_code == 201
E   assert 200 == 201
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,156 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,157 - api.middleware.logging - INFO - [logging.py:31] - [7f184722] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,168 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,169 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,170 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,170 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,170 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,173 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252173054，包含 1 个操作
2025-08-30 11:52:52,173 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252173054 中的操作 1/1
2025-08-30 11:52:52,174 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,174 - DatabaseManager - DEBUG - [supporting_operations.py:74] - 开发模式: __any__ 存在于白名单，mock_openid_3b77fd501946df1a 设为管理员
2025-08-30 11:52:52,184 - DatabaseManager - INFO - [manager.py:156] - 事务 20250830115252173054 提交成功
2025-08-30 11:52:52,184 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,185 - api.middleware.logging - INFO - [logging.py:44] - [7f184722] 200 - Time: 0.028s
2025-08-30 11:52:52,205 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,210 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7f184722] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252173054，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252173054 中的操作 1/1
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
DEBUG    DatabaseManager:supporting_operations.py:74 开发模式: __any__ 存在于白名单，mock_openid_3b77fd501946df1a 设为管理员
INFO     DatabaseManager:manager.py:156 事务 20250830115252173054 提交成功
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [7f184722] 200 - Time: 0.028s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,212 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,213 - api.middleware.logging - INFO - [logging.py:31] - [c76cc2ea] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,222 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,224 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,227 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,227 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,229 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,229 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,231 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252231592，包含 1 个操作
2025-08-30 11:52:52,232 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252231592 中的操作 1/1
2025-08-30 11:52:52,233 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252231592 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,233 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252231592 已回滚
2025-08-30 11:52:52,233 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,234 - api.middleware.logging - INFO - [logging.py:44] - [c76cc2ea] 200 - Time: 0.021s
2025-08-30 11:52:52,236 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,238 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c76cc2ea] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252231592，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252231592 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252231592 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252231592 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [c76cc2ea] 200 - Time: 0.021s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
________________ TestAdminAddons.test_create_addon_unauthorized ________________
tests/test_api/test_admin.py:76: in test_create_addon_unauthorized
    assert response.status_code == 403
E   assert 200 == 403
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,341 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,342 - api.middleware.logging - INFO - [logging.py:31] - [7e053007] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,352 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,373 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,373 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,373 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,374 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:52,375 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252375889，包含 1 个操作
2025-08-30 11:52:52,376 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252375889 中的操作 1/1
2025-08-30 11:52:52,377 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,377 - DatabaseManager - DEBUG - [supporting_operations.py:74] - 开发模式: __any__ 存在于白名单，mock_openid_520202aa9e114da5 设为管理员
2025-08-30 11:52:52,384 - DatabaseManager - INFO - [manager.py:156] - 事务 20250830115252375889 提交成功
2025-08-30 11:52:52,384 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:52,385 - api.middleware.logging - INFO - [logging.py:44] - [7e053007] 200 - Time: 0.043s
2025-08-30 11:52:52,401 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,403 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7e053007] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252375889，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252375889 中的操作 1/1
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
DEBUG    DatabaseManager:supporting_operations.py:74 开发模式: __any__ 存在于白名单，mock_openid_520202aa9e114da5 设为管理员
INFO     DatabaseManager:manager.py:156 事务 20250830115252375889 提交成功
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [7e053007] 200 - Time: 0.043s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,404 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,405 - api.middleware.logging - INFO - [logging.py:31] - [ab7bd1fc] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,414 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,415 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,416 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,416 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:52,418 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:52,418 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:52,418 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252418893，包含 1 个操作
2025-08-30 11:52:52,419 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252418893 中的操作 1/1
2025-08-30 11:52:52,420 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252418893 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,420 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252418893 已回滚
2025-08-30 11:52:52,421 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,421 - api.middleware.logging - INFO - [logging.py:44] - [ab7bd1fc] 200 - Time: 0.016s
2025-08-30 11:52:52,423 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,425 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ab7bd1fc] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252418893，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252418893 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252418893 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252418893 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [ab7bd1fc] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
________________ TestAdminAddons.test_deactivate_addon_success _________________
tests/test_api/test_admin.py:87: in test_deactivate_addon_success
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,430 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,431 - api.middleware.logging - INFO - [logging.py:31] - [66ee48ea] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,441 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,447 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,448 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,448 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,448 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,456 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,457 - api.middleware.logging - INFO - [logging.py:44] - [66ee48ea] 200 - Time: 0.026s
2025-08-30 11:52:52,470 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,473 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:52,473 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,474 - api.middleware.logging - INFO - [logging.py:31] - [f77c1e02] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,483 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,485 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,485 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,485 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,488 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,488 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,488 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252488700，包含 1 个操作
2025-08-30 11:52:52,489 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252488700 中的操作 1/1
2025-08-30 11:52:52,490 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252488700 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,490 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252488700 已回滚
2025-08-30 11:52:52,490 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,491 - api.middleware.logging - INFO - [logging.py:44] - [f77c1e02] 200 - Time: 0.017s
2025-08-30 11:52:52,492 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,495 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [66ee48ea] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [66ee48ea] 200 - Time: 0.026s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [f77c1e02] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252488700，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252488700 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252488700 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252488700 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [f77c1e02] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,496 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,497 - api.middleware.logging - INFO - [logging.py:31] - [e97e66ee] PATCH /api/admin/addons/1/deactivate - Client: testclient
2025-08-30 11:52:52,498 - api.middleware.logging - INFO - [logging.py:44] - [e97e66ee] 404 - Time: 0.001s
2025-08-30 11:52:52,500 - httpx - INFO - [_client.py:1013] - HTTP Request: PATCH http://testserver/api/admin/addons/1/deactivate "HTTP/1.1 404 Not Found"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [e97e66ee] PATCH /api/admin/addons/1/deactivate - Client: testclient
INFO     api.middleware.logging:logging.py:44 [e97e66ee] 404 - Time: 0.001s
INFO     httpx:_client.py:1013 HTTP Request: PATCH http://testserver/api/admin/addons/1/deactivate "HTTP/1.1 404 Not Found"
______________ TestAdminAddons.test_deactivate_addon_nonexistent _______________
tests/test_api/test_admin.py:103: in test_deactivate_addon_nonexistent
    assert data["success"] is False
E   KeyError: 'success'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,505 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,506 - api.middleware.logging - INFO - [logging.py:31] - [323de3b7] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,516 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,521 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,524 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,524 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,524 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,531 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,532 - api.middleware.logging - INFO - [logging.py:44] - [323de3b7] 200 - Time: 0.027s
2025-08-30 11:52:52,544 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,546 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [323de3b7] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [323de3b7] 200 - Time: 0.027s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,547 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,548 - api.middleware.logging - INFO - [logging.py:31] - [09859544] PATCH /api/admin/addons/99999/deactivate - Client: testclient
2025-08-30 11:52:52,549 - api.middleware.logging - INFO - [logging.py:44] - [09859544] 404 - Time: 0.002s
2025-08-30 11:52:52,551 - httpx - INFO - [_client.py:1013] - HTTP Request: PATCH http://testserver/api/admin/addons/99999/deactivate "HTTP/1.1 404 Not Found"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [09859544] PATCH /api/admin/addons/99999/deactivate - Client: testclient
INFO     api.middleware.logging:logging.py:44 [09859544] 404 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: PATCH http://testserver/api/admin/addons/99999/deactivate "HTTP/1.1 404 Not Found"
___________________ TestAdminMeals.test_publish_meal_success ___________________
tests/test_api/test_admin.py:128: in test_publish_meal_success
    assert response.status_code == 201
E   assert 200 == 201
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,558 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,558 - api.middleware.logging - INFO - [logging.py:31] - [2c41a5fe] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,574 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,575 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,575 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,575 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,575 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,583 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,583 - api.middleware.logging - INFO - [logging.py:44] - [2c41a5fe] 200 - Time: 0.025s
2025-08-30 11:52:52,604 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,606 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:52,607 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,608 - api.middleware.logging - INFO - [logging.py:31] - [abdc8770] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,616 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,617 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,619 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,619 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,621 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,621 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,622 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252622695，包含 1 个操作
2025-08-30 11:52:52,623 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252622695 中的操作 1/1
2025-08-30 11:52:52,624 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252622695 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,624 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252622695 已回滚
2025-08-30 11:52:52,624 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,625 - api.middleware.logging - INFO - [logging.py:44] - [abdc8770] 200 - Time: 0.017s
2025-08-30 11:52:52,627 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,629 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [2c41a5fe] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [2c41a5fe] 200 - Time: 0.025s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [abdc8770] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252622695，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252622695 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252622695 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252622695 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [abdc8770] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,630 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,631 - api.middleware.logging - INFO - [logging.py:31] - [0e427772] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:52,639 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,640 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,640 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,641 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,643 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,643 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,643 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252643958，包含 1 个操作
2025-08-30 11:52:52,644 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252643958 中的操作 1/1
2025-08-30 11:52:52,645 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252643958 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,645 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252643958 已回滚
2025-08-30 11:52:52,646 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,646 - api.middleware.logging - INFO - [logging.py:44] - [0e427772] 200 - Time: 0.016s
2025-08-30 11:52:52,648 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,650 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [0e427772] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252643958，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252643958 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252643958 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252643958 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [0e427772] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
____________________ TestAdminMeals.test_lock_meal_success _____________________
tests/test_api/test_admin.py:173: in test_lock_meal_success
    assert response.status_code == 200
E   assert 405 == 200
E    +  where 405 = <Response [405 Method Not Allowed]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,737 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,737 - api.middleware.logging - INFO - [logging.py:31] - [464d3cb0] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,746 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,747 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,747 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,748 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,748 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,754 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,769 - api.middleware.logging - INFO - [logging.py:44] - [464d3cb0] 200 - Time: 0.032s
2025-08-30 11:52:52,769 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,772 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:52,773 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,774 - api.middleware.logging - INFO - [logging.py:31] - [6ea16f4c] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,782 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,783 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,783 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,783 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,785 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,785 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,786 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252786300，包含 1 个操作
2025-08-30 11:52:52,787 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252786300 中的操作 1/1
2025-08-30 11:52:52,789 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252786300 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,789 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252786300 已回滚
2025-08-30 11:52:52,789 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,790 - api.middleware.logging - INFO - [logging.py:44] - [6ea16f4c] 200 - Time: 0.016s
2025-08-30 11:52:52,792 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,794 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:52,795 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,796 - api.middleware.logging - INFO - [logging.py:31] - [584a19bb] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:52,804 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,805 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,805 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,806 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,808 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,808 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,808 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252808907，包含 1 个操作
2025-08-30 11:52:52,809 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252808907 中的操作 1/1
2025-08-30 11:52:52,810 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252808907 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,811 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252808907 已回滚
2025-08-30 11:52:52,811 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,811 - api.middleware.logging - INFO - [logging.py:44] - [584a19bb] 200 - Time: 0.015s
2025-08-30 11:52:52,813 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,815 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [464d3cb0] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [464d3cb0] 200 - Time: 0.032s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [6ea16f4c] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252786300，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252786300 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252786300 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252786300 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [6ea16f4c] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [584a19bb] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252808907，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252808907 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252808907 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252808907 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [584a19bb] 200 - Time: 0.015s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,816 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,817 - api.middleware.logging - INFO - [logging.py:31] - [b31d2402] PATCH /api/admin/meals/1/lock - Client: testclient
2025-08-30 11:52:52,818 - api.middleware.logging - INFO - [logging.py:44] - [b31d2402] 405 - Time: 0.001s
2025-08-30 11:52:52,820 - httpx - INFO - [_client.py:1013] - HTTP Request: PATCH http://testserver/api/admin/meals/1/lock "HTTP/1.1 405 Method Not Allowed"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b31d2402] PATCH /api/admin/meals/1/lock - Client: testclient
INFO     api.middleware.logging:logging.py:44 [b31d2402] 405 - Time: 0.001s
INFO     httpx:_client.py:1013 HTTP Request: PATCH http://testserver/api/admin/meals/1/lock "HTTP/1.1 405 Method Not Allowed"
__________________ TestAdminMeals.test_complete_meal_success ___________________
tests/test_api/test_admin.py:187: in test_complete_meal_success
    assert response.status_code == 200
E   assert 405 == 200
E    +  where 405 = <Response [405 Method Not Allowed]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,825 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,825 - api.middleware.logging - INFO - [logging.py:31] - [c549d846] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,834 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,835 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,835 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,835 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,835 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,845 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,846 - api.middleware.logging - INFO - [logging.py:44] - [c549d846] 200 - Time: 0.021s
2025-08-30 11:52:52,861 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,867 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:52,867 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,868 - api.middleware.logging - INFO - [logging.py:31] - [b20ae6c7] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,877 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,878 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,878 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,879 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,881 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,881 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,881 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252881765，包含 1 个操作
2025-08-30 11:52:52,882 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252881765 中的操作 1/1
2025-08-30 11:52:52,883 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252881765 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,884 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252881765 已回滚
2025-08-30 11:52:52,884 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,884 - api.middleware.logging - INFO - [logging.py:44] - [b20ae6c7] 200 - Time: 0.016s
2025-08-30 11:52:52,887 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,889 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:52,890 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,891 - api.middleware.logging - INFO - [logging.py:31] - [92f4f578] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:52,901 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,902 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,902 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,902 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,905 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,905 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,905 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252905923，包含 1 个操作
2025-08-30 11:52:52,906 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252905923 中的操作 1/1
2025-08-30 11:52:52,907 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252905923 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,907 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252905923 已回滚
2025-08-30 11:52:52,907 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,908 - api.middleware.logging - INFO - [logging.py:44] - [92f4f578] 200 - Time: 0.017s
2025-08-30 11:52:52,911 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,914 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c549d846] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [c549d846] 200 - Time: 0.021s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b20ae6c7] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252881765，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252881765 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252881765 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252881765 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [b20ae6c7] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [92f4f578] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252905923，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252905923 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252905923 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252905923 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [92f4f578] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:52,915 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,915 - api.middleware.logging - INFO - [logging.py:31] - [19dade4c] PATCH /api/admin/meals/1/complete - Client: testclient
2025-08-30 11:52:52,917 - api.middleware.logging - INFO - [logging.py:44] - [19dade4c] 405 - Time: 0.002s
2025-08-30 11:52:52,919 - httpx - INFO - [_client.py:1013] - HTTP Request: PATCH http://testserver/api/admin/meals/1/complete "HTTP/1.1 405 Method Not Allowed"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [19dade4c] PATCH /api/admin/meals/1/complete - Client: testclient
INFO     api.middleware.logging:logging.py:44 [19dade4c] 405 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: PATCH http://testserver/api/admin/meals/1/complete "HTTP/1.1 405 Method Not Allowed"
___________________ TestAdminMeals.test_cancel_meal_success ____________________
tests/test_api/test_admin.py:200: in test_cancel_meal_success
    response = client.delete(
E   TypeError: TestClient.delete() got an unexpected keyword argument 'json'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:52,924 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,924 - api.middleware.logging - INFO - [logging.py:31] - [1a4846af] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:52,934 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,934 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,935 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:52,935 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:52,935 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:52,942 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,943 - api.middleware.logging - INFO - [logging.py:44] - [1a4846af] 200 - Time: 0.018s
2025-08-30 11:52:52,960 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,962 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:52,963 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,963 - api.middleware.logging - INFO - [logging.py:31] - [80f7b34a] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:52,977 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:52,982 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:52,982 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:52,983 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:52,985 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:52,985 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:52,985 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115252985839，包含 1 个操作
2025-08-30 11:52:52,986 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115252985839 中的操作 1/1
2025-08-30 11:52:52,987 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115252985839 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,987 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115252985839 已回滚
2025-08-30 11:52:52,987 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:52,988 - api.middleware.logging - INFO - [logging.py:44] - [80f7b34a] 200 - Time: 0.025s
2025-08-30 11:52:52,990 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:52,992 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:52,993 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:52,993 - api.middleware.logging - INFO - [logging.py:31] - [8cede4c9] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:53,002 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,003 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,003 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,003 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:53,006 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:53,006 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:53,006 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115253006781，包含 1 个操作
2025-08-30 11:52:53,007 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115253006781 中的操作 1/1
2025-08-30 11:52:53,008 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115253006781 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:53,008 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115253006781 已回滚
2025-08-30 11:52:53,008 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:53,008 - api.middleware.logging - INFO - [logging.py:44] - [8cede4c9] 200 - Time: 0.015s
2025-08-30 11:52:53,010 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,012 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [1a4846af] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [1a4846af] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [80f7b34a] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115252985839，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115252985839 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115252985839 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115252985839 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [80f7b34a] 200 - Time: 0.025s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [8cede4c9] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115253006781，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115253006781 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115253006781 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115253006781 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [8cede4c9] 200 - Time: 0.015s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
______________ TestAdminPermissions.test_non_admin_access_denied _______________
tests/test_api/test_admin.py:326: in test_non_admin_access_denied
    assert response.status_code == 403
E   assert 200 == 403
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:53,548 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,549 - api.middleware.logging - INFO - [logging.py:31] - [8fb25f64] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,558 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,560 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,561 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,561 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,561 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:53,569 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:53,570 - api.middleware.logging - INFO - [logging.py:44] - [8fb25f64] 200 - Time: 0.022s
2025-08-30 11:52:53,587 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,589 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [8fb25f64] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [8fb25f64] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,591 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,591 - api.middleware.logging - INFO - [logging.py:31] - [5b379238] GET /api/admin/users - Client: testclient
2025-08-30 11:52:53,603 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,604 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,605 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,605 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:53,608 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:53,608 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:53,614 - api.middleware.logging - INFO - [logging.py:44] - [5b379238] 200 - Time: 0.022s
2025-08-30 11:52:53,616 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,618 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/admin/users "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [5b379238] GET /api/admin/users - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
INFO     api.middleware.logging:logging.py:44 [5b379238] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/admin/users "HTTP/1.1 200 OK"
___________ TestAdminPermissions.test_unauthenticated_access_denied ____________
tests/test_api/test_admin.py:341: in test_unauthenticated_access_denied
    assert response.status_code == 401
E   assert 403 == 401
E    +  where 403 = <Response [403 Forbidden]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,625 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,626 - api.middleware.logging - INFO - [logging.py:31] - [ae981693] GET /api/admin/users - Client: testclient
2025-08-30 11:52:53,627 - api.middleware.logging - INFO - [logging.py:44] - [ae981693] 403 - Time: 0.001s
2025-08-30 11:52:53,629 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/admin/users "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ae981693] GET /api/admin/users - Client: testclient
INFO     api.middleware.logging:logging.py:44 [ae981693] 403 - Time: 0.001s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/admin/users "HTTP/1.1 403 Forbidden"
___________________ TestAuthRoutes.test_wechat_auth_success ____________________
tests/test_api/test_auth.py:28: in test_wechat_auth_success
    assert data["data"]["user_info"]["wechat_name"] == "测试用户"
E   AssertionError: assert None == '测试用户'
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,635 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,636 - api.middleware.logging - INFO - [logging.py:31] - [593f2071] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,645 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,646 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,647 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,647 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,647 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_code_12345
2025-08-30 11:52:53,649 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115253649259，包含 1 个操作
2025-08-30 11:52:53,649 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115253649259 中的操作 1/1
2025-08-30 11:52:53,650 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,650 - DatabaseManager - DEBUG - [supporting_operations.py:74] - 开发模式: __any__ 存在于白名单，mock_openid_dd26c0e17bf6adba 设为管理员
2025-08-30 11:52:53,667 - DatabaseManager - INFO - [manager.py:156] - 事务 20250830115253649259 提交成功
2025-08-30 11:52:53,668 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_dd26c0e17bf6adba
2025-08-30 11:52:53,669 - api.middleware.logging - INFO - [logging.py:44] - [593f2071] 200 - Time: 0.033s
2025-08-30 11:52:53,687 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,689 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [593f2071] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_code_12345
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115253649259，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115253649259 中的操作 1/1
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
DEBUG    DatabaseManager:supporting_operations.py:74 开发模式: __any__ 存在于白名单，mock_openid_dd26c0e17bf6adba 设为管理员
INFO     DatabaseManager:manager.py:156 事务 20250830115253649259 提交成功
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_dd26c0e17bf6adba
INFO     api.middleware.logging:logging.py:44 [593f2071] 200 - Time: 0.033s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
______________________ TestAuthRoutes.test_token_refresh _______________________
tests/test_api/test_auth.py:67: in test_token_refresh
    assert refresh_data["data"]["access_token"] != token
E   AssertionError: assert 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxNiwib3Blbl9pZCI6Im1vY2tfb3BlbmlkXzA0ZDdmZDQyYjE1YWIyMDUiLCJpc19hZG1pbiI6dHJ1ZSwiZXhwIjoxNzU2NjQxMTczLCJpYXQiOjE3NTY1NTQ3NzN9.BqddH9uUWT_pO2aEIU4C0TQAPC2AnFfr_ykq5ex_G5Y' != 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxNiwib3Blbl9pZCI6Im1vY2tfb3BlbmlkXzA0ZDdmZDQyYjE1YWIyMDUiLCJpc19hZG1pbiI6dHJ1ZSwiZXhwIjoxNzU2NjQxMTczLCJpYXQiOjE3NTY1NTQ3NzN9.BqddH9uUWT_pO2aEIU4C0TQAPC2AnFfr_ykq5ex_G5Y'
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,711 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,712 - api.middleware.logging - INFO - [logging.py:31] - [90537fae] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:53,721 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,722 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,722 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,722 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:53,722 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_code_refresh
2025-08-30 11:52:53,724 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115253724810，包含 1 个操作
2025-08-30 11:52:53,725 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115253724810 中的操作 1/1
2025-08-30 11:52:53,726 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:53,726 - DatabaseManager - DEBUG - [supporting_operations.py:74] - 开发模式: __any__ 存在于白名单，mock_openid_04d7fd42b15ab205 设为管理员
2025-08-30 11:52:53,732 - DatabaseManager - INFO - [manager.py:156] - 事务 20250830115253724810 提交成功
2025-08-30 11:52:53,732 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_04d7fd42b15ab205
2025-08-30 11:52:53,733 - api.middleware.logging - INFO - [logging.py:44] - [90537fae] 200 - Time: 0.022s
2025-08-30 11:52:53,750 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,753 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:53,753 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,754 - api.middleware.logging - INFO - [logging.py:31] - [90cff9d2] POST /api/auth/refresh - Client: testclient
2025-08-30 11:52:53,762 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:53,763 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:53,763 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:53,763 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=16, open_id=mock_openid_04d7fd42b15ab205
2025-08-30 11:52:53,766 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=16, found=True
2025-08-30 11:52:53,766 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=16
2025-08-30 11:52:53,767 - api.middleware.logging - INFO - [logging.py:44] - [90cff9d2] 200 - Time: 0.013s
2025-08-30 11:52:53,769 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:53,771 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [90537fae] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_code_refresh
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115253724810，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115253724810 中的操作 1/1
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
DEBUG    DatabaseManager:supporting_operations.py:74 开发模式: __any__ 存在于白名单，mock_openid_04d7fd42b15ab205 设为管理员
INFO     DatabaseManager:manager.py:156 事务 20250830115253724810 提交成功
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_04d7fd42b15ab205
INFO     api.middleware.logging:logging.py:44 [90537fae] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [90cff9d2] POST /api/auth/refresh - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=16, open_id=mock_openid_04d7fd42b15ab205
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=16, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=16
INFO     api.middleware.logging:logging.py:44 [90cff9d2] 200 - Time: 0.013s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 200 OK"
_______________ TestAuthRoutes.test_token_refresh_missing_token ________________
tests/test_api/test_auth.py:84: in test_token_refresh_missing_token
    assert response.status_code == 401
E   assert 403 == 401
E    +  where 403 = <Response [403 Forbidden]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,791 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,792 - api.middleware.logging - INFO - [logging.py:31] - [1f801ba1] POST /api/auth/refresh - Client: testclient
2025-08-30 11:52:53,794 - api.middleware.logging - INFO - [logging.py:44] - [1f801ba1] 403 - Time: 0.001s
2025-08-30 11:52:53,795 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [1f801ba1] POST /api/auth/refresh - Client: testclient
INFO     api.middleware.logging:logging.py:44 [1f801ba1] 403 - Time: 0.001s
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 403 Forbidden"
________________ TestTokenValidation.test_missing_token_access _________________
tests/test_api/test_auth.py:129: in test_missing_token_access
    assert response.status_code == 401
E   assert 403 == 401
E    +  where 403 = <Response [403 Forbidden]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:53,888 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:53,889 - api.middleware.logging - INFO - [logging.py:31] - [acdf6431] GET /api/users/profile - Client: testclient
2025-08-30 11:52:53,891 - api.middleware.logging - INFO - [logging.py:44] - [acdf6431] 403 - Time: 0.002s
2025-08-30 11:52:53,892 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [acdf6431] GET /api/users/profile - Client: testclient
INFO     api.middleware.logging:logging.py:44 [acdf6431] 403 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/users/profile "HTTP/1.1 403 Forbidden"
__________________ TestMealsList.test_get_meals_missing_dates __________________
tests/test_api/test_meals.py:52: in test_get_meals_missing_dates
    assert response.status_code == 422  # Validation error
E   assert 200 == 422
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,040 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,041 - api.middleware.logging - INFO - [logging.py:31] - [6914158f] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,051 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,051 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,052 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,052 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,052 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,059 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,060 - api.middleware.logging - INFO - [logging.py:44] - [6914158f] 200 - Time: 0.019s
2025-08-30 11:52:54,114 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,116 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [6914158f] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [6914158f] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,117 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,118 - api.middleware.logging - INFO - [logging.py:31] - [c3b035d7] GET /api/meals - Client: testclient
2025-08-30 11:52:54,127 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,128 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,129 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,129 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:54,136 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:54,136 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:54,142 - api.middleware.logging - INFO - [logging.py:44] - [c3b035d7] 200 - Time: 0.024s
2025-08-30 11:52:54,147 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,149 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c3b035d7] GET /api/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
INFO     api.middleware.logging:logging.py:44 [c3b035d7] 200 - Time: 0.024s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals "HTTP/1.1 200 OK"
_______________ TestMealsList.test_get_meals_invalid_date_range ________________
tests/test_api/test_meals.py:61: in test_get_meals_invalid_date_range
    assert response.status_code == 400
E   assert 200 == 400
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,153 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,154 - api.middleware.logging - INFO - [logging.py:31] - [73b472aa] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,164 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,165 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,166 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,166 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,166 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,179 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,180 - api.middleware.logging - INFO - [logging.py:44] - [73b472aa] 200 - Time: 0.026s
2025-08-30 11:52:54,201 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,203 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [73b472aa] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [73b472aa] 200 - Time: 0.026s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,205 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,205 - api.middleware.logging - INFO - [logging.py:31] - [547d1ad2] GET /api/meals - Client: testclient
2025-08-30 11:52:54,215 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,216 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,217 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,217 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:54,220 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:54,220 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:54,220 - api.meals.routes - ERROR - [routes.py:99] - 获取餐次列表失败: 日期格式错误或无效: 开始日期不能晚于结束日期
2025-08-30 11:52:54,221 - api.middleware.logging - INFO - [logging.py:44] - [547d1ad2] 200 - Time: 0.016s
2025-08-30 11:52:54,223 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,225 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals?start_date=2024-12-31&end_date=2024-12-01 "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [547d1ad2] GET /api/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    api.meals.routes:routes.py:99 获取餐次列表失败: 日期格式错误或无效: 开始日期不能晚于结束日期
INFO     api.middleware.logging:logging.py:44 [547d1ad2] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals?start_date=2024-12-31&end_date=2024-12-01 "HTTP/1.1 200 OK"
__________________ TestMealsList.test_get_meals_unauthorized ___________________
tests/test_api/test_meals.py:69: in test_get_meals_unauthorized
    assert response.status_code == 401
E   assert 403 == 401
E    +  where 403 = <Response [403 Forbidden]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,229 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,230 - api.middleware.logging - INFO - [logging.py:31] - [dca66dd1] GET /api/meals - Client: testclient
2025-08-30 11:52:54,231 - api.middleware.logging - INFO - [logging.py:44] - [dca66dd1] 403 - Time: 0.002s
2025-08-30 11:52:54,233 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals?start_date=2024-12-01&end_date=2024-12-31 "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [dca66dd1] GET /api/meals - Client: testclient
INFO     api.middleware.logging:logging.py:44 [dca66dd1] 403 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals?start_date=2024-12-01&end_date=2024-12-31 "HTTP/1.1 403 Forbidden"
_____________________ TestMealDetail.test_get_meal_detail ______________________
tests/test_api/test_meals.py:85: in test_get_meal_detail
    assert data["success"] is True
E   assert False is True
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,236 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,237 - api.middleware.logging - INFO - [logging.py:31] - [344448d7] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,247 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,248 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,249 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,249 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,249 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,255 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,256 - api.middleware.logging - INFO - [logging.py:44] - [344448d7] 200 - Time: 0.019s
2025-08-30 11:52:54,276 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,278 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,279 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,280 - api.middleware.logging - INFO - [logging.py:31] - [ecb79c8b] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,292 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,293 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,293 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,293 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,293 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:54,301 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,301 - api.middleware.logging - INFO - [logging.py:44] - [ecb79c8b] 200 - Time: 0.022s
2025-08-30 11:52:54,312 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,314 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,315 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,316 - api.middleware.logging - INFO - [logging.py:31] - [b3d8ca95] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:54,326 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,327 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,327 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,328 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,330 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,330 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,330 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254330907，包含 1 个操作
2025-08-30 11:52:54,331 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254330907 中的操作 1/1
2025-08-30 11:52:54,332 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254330907 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,333 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254330907 已回滚
2025-08-30 11:52:54,333 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,335 - api.middleware.logging - INFO - [logging.py:44] - [b3d8ca95] 200 - Time: 0.019s
2025-08-30 11:52:54,337 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,339 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:54,340 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,340 - api.middleware.logging - INFO - [logging.py:31] - [46c9e798] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:54,348 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,350 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,350 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,350 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,352 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,352 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,353 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254353266，包含 1 个操作
2025-08-30 11:52:54,353 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254353266 中的操作 1/1
2025-08-30 11:52:54,355 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254353266 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,355 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254353266 已回滚
2025-08-30 11:52:54,355 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,356 - api.middleware.logging - INFO - [logging.py:44] - [46c9e798] 200 - Time: 0.015s
2025-08-30 11:52:54,357 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,359 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [344448d7] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [344448d7] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ecb79c8b] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [ecb79c8b] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b3d8ca95] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254330907，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254330907 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254330907 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254330907 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [b3d8ca95] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [46c9e798] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254353266，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254353266 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254353266 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254353266 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [46c9e798] 200 - Time: 0.015s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,360 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,361 - api.middleware.logging - INFO - [logging.py:31] - [33301847] GET /api/meals/1 - Client: testclient
2025-08-30 11:52:54,370 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,371 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,371 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,372 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:54,374 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:54,374 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:54,376 - api.meals.routes - ERROR - [routes.py:188] - 获取餐次详情失败: 'message'
2025-08-30 11:52:54,377 - api.middleware.logging - INFO - [logging.py:44] - [33301847] 200 - Time: 0.016s
2025-08-30 11:52:54,379 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,381 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/1 "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [33301847] GET /api/meals/1 - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    api.meals.routes:routes.py:188 获取餐次详情失败: 'message'
INFO     api.middleware.logging:logging.py:44 [33301847] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/1 "HTTP/1.1 200 OK"
_______________ TestMealDetail.test_get_meal_detail_nonexistent ________________
tests/test_api/test_meals.py:102: in test_get_meal_detail_nonexistent
    assert response.status_code == 404
E   assert 200 == 404
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,385 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,386 - api.middleware.logging - INFO - [logging.py:31] - [04c80774] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,395 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,396 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,397 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,397 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,397 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,404 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,405 - api.middleware.logging - INFO - [logging.py:44] - [04c80774] 200 - Time: 0.019s
2025-08-30 11:52:54,424 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,426 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [04c80774] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [04c80774] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,427 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,428 - api.middleware.logging - INFO - [logging.py:31] - [919b0fcf] GET /api/meals/99999 - Client: testclient
2025-08-30 11:52:54,437 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,438 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,438 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,438 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:54,440 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:54,441 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:54,442 - api.meals.routes - ERROR - [routes.py:188] - 获取餐次详情失败: 'message'
2025-08-30 11:52:54,443 - api.middleware.logging - INFO - [logging.py:44] - [919b0fcf] 200 - Time: 0.016s
2025-08-30 11:52:54,445 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,447 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/99999 "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [919b0fcf] GET /api/meals/99999 - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
ERROR    api.meals.routes:routes.py:188 获取餐次详情失败: 'message'
INFO     api.middleware.logging:logging.py:44 [919b0fcf] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/99999 "HTTP/1.1 200 OK"
_______________ TestMealDetail.test_get_meal_detail_unauthorized _______________
tests/test_api/test_meals.py:110: in test_get_meal_detail_unauthorized
    assert response.status_code == 401
E   assert 403 == 401
E    +  where 403 = <Response [403 Forbidden]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,451 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,452 - api.middleware.logging - INFO - [logging.py:31] - [ab0f529b] GET /api/meals/1 - Client: testclient
2025-08-30 11:52:54,454 - api.middleware.logging - INFO - [logging.py:44] - [ab0f529b] 403 - Time: 0.001s
2025-08-30 11:52:54,455 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/1 "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ab0f529b] GET /api/meals/1 - Client: testclient
INFO     api.middleware.logging:logging.py:44 [ab0f529b] 403 - Time: 0.001s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/1 "HTTP/1.1 403 Forbidden"
___________________ TestMealOrder.test_check_user_meal_order ___________________
tests/test_api/test_meals.py:123: in test_check_user_meal_order
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,459 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,459 - api.middleware.logging - INFO - [logging.py:31] - [5eb14f51] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,469 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,470 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,470 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,471 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,471 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,480 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,481 - api.middleware.logging - INFO - [logging.py:44] - [5eb14f51] 200 - Time: 0.022s
2025-08-30 11:52:54,500 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,502 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,503 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,504 - api.middleware.logging - INFO - [logging.py:31] - [e25b74ff] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,515 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,516 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,516 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,516 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,516 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:54,524 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,526 - api.middleware.logging - INFO - [logging.py:44] - [e25b74ff] 200 - Time: 0.022s
2025-08-30 11:52:54,559 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,561 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,562 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,563 - api.middleware.logging - INFO - [logging.py:31] - [b37e65a3] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:54,573 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,575 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,575 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,575 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,578 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,578 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,579 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254579155，包含 1 个操作
2025-08-30 11:52:54,579 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254579155 中的操作 1/1
2025-08-30 11:52:54,581 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254579155 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,581 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254579155 已回滚
2025-08-30 11:52:54,581 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,582 - api.middleware.logging - INFO - [logging.py:44] - [b37e65a3] 200 - Time: 0.019s
2025-08-30 11:52:54,585 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,588 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:54,589 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,590 - api.middleware.logging - INFO - [logging.py:31] - [b42a047d] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:54,599 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,600 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,600 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,600 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,603 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,603 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,603 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254603792，包含 1 个操作
2025-08-30 11:52:54,604 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254603792 中的操作 1/1
2025-08-30 11:52:54,605 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254603792 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,605 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254603792 已回滚
2025-08-30 11:52:54,605 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,606 - api.middleware.logging - INFO - [logging.py:44] - [b42a047d] 200 - Time: 0.016s
2025-08-30 11:52:54,608 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,610 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [5eb14f51] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [5eb14f51] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [e25b74ff] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [e25b74ff] 200 - Time: 0.022s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b37e65a3] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254579155，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254579155 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254579155 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254579155 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [b37e65a3] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [b42a047d] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254603792，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254603792 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254603792 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254603792 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [b42a047d] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,611 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,612 - api.middleware.logging - INFO - [logging.py:31] - [020590f7] GET /api/meals/1/order - Client: testclient
2025-08-30 11:52:54,614 - api.middleware.logging - INFO - [logging.py:44] - [020590f7] 404 - Time: 0.002s
2025-08-30 11:52:54,616 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/1/order "HTTP/1.1 404 Not Found"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [020590f7] GET /api/meals/1/order - Client: testclient
INFO     api.middleware.logging:logging.py:44 [020590f7] 404 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/1/order "HTTP/1.1 404 Not Found"
__________ TestMealOrder.test_check_user_meal_order_nonexistent_meal ___________
tests/test_api/test_meals.py:144: in test_check_user_meal_order_nonexistent_meal
    assert data["success"] is False
E   KeyError: 'success'
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,620 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,620 - api.middleware.logging - INFO - [logging.py:31] - [690f8825] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,629 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,632 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,632 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,632 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,632 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,640 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,641 - api.middleware.logging - INFO - [logging.py:44] - [690f8825] 200 - Time: 0.020s
2025-08-30 11:52:54,682 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,684 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [690f8825] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [690f8825] 200 - Time: 0.020s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,685 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,686 - api.middleware.logging - INFO - [logging.py:31] - [ff7fcc3a] GET /api/meals/99999/order - Client: testclient
2025-08-30 11:52:54,688 - api.middleware.logging - INFO - [logging.py:44] - [ff7fcc3a] 404 - Time: 0.002s
2025-08-30 11:52:54,690 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/99999/order "HTTP/1.1 404 Not Found"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ff7fcc3a] GET /api/meals/99999/order - Client: testclient
INFO     api.middleware.logging:logging.py:44 [ff7fcc3a] 404 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/99999/order "HTTP/1.1 404 Not Found"
____________ TestMealOrder.test_check_user_meal_order_unauthorized _____________
tests/test_api/test_meals.py:150: in test_check_user_meal_order_unauthorized
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = <Response [404 Not Found]>.status_code
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,694 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,695 - api.middleware.logging - INFO - [logging.py:31] - [7e54fb74] GET /api/meals/1/order - Client: testclient
2025-08-30 11:52:54,696 - api.middleware.logging - INFO - [logging.py:44] - [7e54fb74] 404 - Time: 0.002s
2025-08-30 11:52:54,699 - httpx - INFO - [_client.py:1013] - HTTP Request: GET http://testserver/api/meals/1/order "HTTP/1.1 404 Not Found"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7e54fb74] GET /api/meals/1/order - Client: testclient
INFO     api.middleware.logging:logging.py:44 [7e54fb74] 404 - Time: 0.002s
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/meals/1/order "HTTP/1.1 404 Not Found"
_________________ TestOrderCreation.test_create_order_success __________________
tests/test_api/test_orders.py:27: in test_create_order_success
    assert response.status_code == 201
E   assert 200 == 201
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,702 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,709 - api.middleware.logging - INFO - [logging.py:31] - [0a2bab7b] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,719 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,719 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,720 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,720 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,720 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,727 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,728 - api.middleware.logging - INFO - [logging.py:44] - [0a2bab7b] 200 - Time: 0.019s
2025-08-30 11:52:54,749 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,751 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,752 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,753 - api.middleware.logging - INFO - [logging.py:31] - [88bf9d3e] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,762 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,763 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,764 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,764 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,764 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:54,773 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,774 - api.middleware.logging - INFO - [logging.py:44] - [88bf9d3e] 200 - Time: 0.021s
2025-08-30 11:52:54,801 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,803 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:54,804 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,805 - api.middleware.logging - INFO - [logging.py:31] - [dc5b2dbc] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:54,816 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,817 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,817 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,818 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,820 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,820 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,820 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254820716，包含 1 个操作
2025-08-30 11:52:54,821 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254820716 中的操作 1/1
2025-08-30 11:52:54,822 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254820716 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,822 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254820716 已回滚
2025-08-30 11:52:54,823 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,823 - api.middleware.logging - INFO - [logging.py:44] - [dc5b2dbc] 200 - Time: 0.018s
2025-08-30 11:52:54,825 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,827 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:54,828 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,829 - api.middleware.logging - INFO - [logging.py:31] - [d1ba4adb] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:54,839 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,840 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,840 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,840 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:54,842 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:54,843 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:54,843 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254843576，包含 1 个操作
2025-08-30 11:52:54,844 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254843576 中的操作 1/1
2025-08-30 11:52:54,845 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254843576 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,845 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254843576 已回滚
2025-08-30 11:52:54,845 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:54,846 - api.middleware.logging - INFO - [logging.py:44] - [d1ba4adb] 200 - Time: 0.018s
2025-08-30 11:52:54,848 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,850 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [0a2bab7b] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [0a2bab7b] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [88bf9d3e] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [88bf9d3e] 200 - Time: 0.021s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [dc5b2dbc] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254820716，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254820716 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254820716 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254820716 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [dc5b2dbc] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [d1ba4adb] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254843576，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254843576 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254843576 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254843576 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [d1ba4adb] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,852 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,852 - api.middleware.logging - INFO - [logging.py:31] - [3d3ff5e1] POST /api/orders - Client: testclient
2025-08-30 11:52:54,862 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,863 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,863 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,863 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:54,866 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:54,866 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:54,867 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115254867350，包含 1 个操作
2025-08-30 11:52:54,867 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115254867350 中的操作 1/1
2025-08-30 11:52:54,868 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115254867350 执行失败: 用户账户已停用
2025-08-30 11:52:54,869 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115254867350 已回滚
2025-08-30 11:52:54,869 - api.orders.routes - ERROR - [routes.py:79] - 创建订单失败: 用户账户已停用
2025-08-30 11:52:54,870 - api.middleware.logging - INFO - [logging.py:44] - [3d3ff5e1] 200 - Time: 0.017s
2025-08-30 11:52:54,871 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,874 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [3d3ff5e1] POST /api/orders - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115254867350，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115254867350 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115254867350 执行失败: 用户账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115254867350 已回滚
ERROR    api.orders.routes:routes.py:79 创建订单失败: 用户账户已停用
INFO     api.middleware.logging:logging.py:44 [3d3ff5e1] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
_____________ TestOrderCreation.test_create_order_nonexistent_meal _____________
tests/test_api/test_orders.py:63: in test_create_order_nonexistent_meal
    assert response.status_code == 404
E   assert 200 == 404
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:54,939 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,940 - api.middleware.logging - INFO - [logging.py:31] - [1f1bfdda] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:54,948 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,949 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,950 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:54,950 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:54,950 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:54,970 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:54,971 - api.middleware.logging - INFO - [logging.py:44] - [1f1bfdda] 200 - Time: 0.031s
2025-08-30 11:52:54,983 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:54,985 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [1f1bfdda] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [1f1bfdda] 200 - Time: 0.031s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:54,987 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:54,987 - api.middleware.logging - INFO - [logging.py:31] - [5c2d9bca] POST /api/orders - Client: testclient
2025-08-30 11:52:54,997 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:54,998 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:54,998 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:54,998 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:55,000 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:55,000 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:55,001 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255001115，包含 1 个操作
2025-08-30 11:52:55,001 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255001115 中的操作 1/1
2025-08-30 11:52:55,002 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255001115 执行失败: 用户账户已停用
2025-08-30 11:52:55,002 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255001115 已回滚
2025-08-30 11:52:55,003 - api.orders.routes - ERROR - [routes.py:79] - 创建订单失败: 用户账户已停用
2025-08-30 11:52:55,003 - api.middleware.logging - INFO - [logging.py:44] - [5c2d9bca] 200 - Time: 0.016s
2025-08-30 11:52:55,005 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,007 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [5c2d9bca] POST /api/orders - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255001115，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255001115 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255001115 执行失败: 用户账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255001115 已回滚
ERROR    api.orders.routes:routes.py:79 创建订单失败: 用户账户已停用
INFO     api.middleware.logging:logging.py:44 [5c2d9bca] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
___________ TestOrderCreation.test_create_order_insufficient_balance ___________
tests/test_api/test_orders.py:82: in test_create_order_insufficient_balance
    assert response.status_code in [201, 400]
E   assert 200 in [201, 400]
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:55,013 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,014 - api.middleware.logging - INFO - [logging.py:31] - [f3fbdcc0] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,023 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,024 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,024 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:55,024 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:55,024 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_user_code
2025-08-30 11:52:55,032 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_520202aa9e114da5
2025-08-30 11:52:55,033 - api.middleware.logging - INFO - [logging.py:44] - [f3fbdcc0] 200 - Time: 0.019s
2025-08-30 11:52:55,085 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,088 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:55,088 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,089 - api.middleware.logging - INFO - [logging.py:31] - [a30fa92f] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,097 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,098 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,099 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:55,100 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:55,100 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:55,106 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,107 - api.middleware.logging - INFO - [logging.py:44] - [a30fa92f] 200 - Time: 0.018s
2025-08-30 11:52:55,120 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,122 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:55,123 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,124 - api.middleware.logging - INFO - [logging.py:31] - [ab98474f] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:55,133 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,134 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,135 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:55,135 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,137 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:55,137 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:55,137 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255137787，包含 1 个操作
2025-08-30 11:52:55,138 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255137787 中的操作 1/1
2025-08-30 11:52:55,139 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255137787 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,139 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255137787 已回滚
2025-08-30 11:52:55,139 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,140 - api.middleware.logging - INFO - [logging.py:44] - [ab98474f] 200 - Time: 0.016s
2025-08-30 11:52:55,142 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,144 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:55,145 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,146 - api.middleware.logging - INFO - [logging.py:31] - [706d3230] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:55,155 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,156 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,157 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:55,157 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,159 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:55,159 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:55,160 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255160132，包含 1 个操作
2025-08-30 11:52:55,160 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255160132 中的操作 1/1
2025-08-30 11:52:55,162 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255160132 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,162 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255160132 已回滚
2025-08-30 11:52:55,162 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,163 - api.middleware.logging - INFO - [logging.py:44] - [706d3230] 200 - Time: 0.017s
2025-08-30 11:52:55,164 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,166 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [f3fbdcc0] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_user_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_520202aa9e114da5
INFO     api.middleware.logging:logging.py:44 [f3fbdcc0] 200 - Time: 0.019s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [a30fa92f] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [a30fa92f] 200 - Time: 0.018s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [ab98474f] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255137787，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255137787 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255137787 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255137787 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [ab98474f] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [706d3230] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255160132，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255160132 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255160132 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255160132 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [706d3230] 200 - Time: 0.017s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:55,168 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,168 - api.middleware.logging - INFO - [logging.py:31] - [9f7058f2] POST /api/orders - Client: testclient
2025-08-30 11:52:55,190 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,191 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,192 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:55,192 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
2025-08-30 11:52:55,194 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=14, found=True
2025-08-30 11:52:55,194 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=14
2025-08-30 11:52:55,194 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255194905，包含 1 个操作
2025-08-30 11:52:55,195 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255194905 中的操作 1/1
2025-08-30 11:52:55,196 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255194905 执行失败: 用户账户已停用
2025-08-30 11:52:55,196 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255194905 已回滚
2025-08-30 11:52:55,196 - api.orders.routes - ERROR - [routes.py:79] - 创建订单失败: 用户账户已停用
2025-08-30 11:52:55,197 - api.middleware.logging - INFO - [logging.py:44] - [9f7058f2] 200 - Time: 0.028s
2025-08-30 11:52:55,199 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,202 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [9f7058f2] POST /api/orders - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=14, open_id=mock_openid_520202aa9e114da5
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=14, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=14
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255194905，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255194905 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255194905 执行失败: 用户账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255194905 已回滚
ERROR    api.orders.routes:routes.py:79 创建订单失败: 用户账户已停用
INFO     api.middleware.logging:logging.py:44 [9f7058f2] 200 - Time: 0.028s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/orders "HTTP/1.1 200 OK"
_______________ TestOrderCreation.test_create_order_unauthorized _______________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_orders.py:122: in test_create_order_unauthorized
    response = client.post("/api/orders", json=order_data)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:590: in post
    return super().post(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1132: in post
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
---------------------------- Captured stderr setup -----------------------------
2025-08-30 11:52:55,441 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,442 - api.middleware.logging - INFO - [logging.py:31] - [80da9de8] POST /api/auth/wechat/login - Client: testclient
2025-08-30 11:52:55,452 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,453 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,454 - root - INFO - [config.py:71] - 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
2025-08-30 11:52:55,454 - api.auth.wechat_service - WARNING - [wechat_service.py:21] - 微信配置缺失，将使用模拟模式
2025-08-30 11:52:55,454 - api.auth.wechat_service - INFO - [wechat_service.py:91] - 使用模拟微信认证，code: test_admin_code
2025-08-30 11:52:55,469 - api.auth.routes - INFO - [routes.py:165] - 未注册用户登录: mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,470 - api.middleware.logging - INFO - [logging.py:44] - [80da9de8] 200 - Time: 0.028s
2025-08-30 11:52:55,490 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,492 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
2025-08-30 11:52:55,493 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,494 - api.middleware.logging - INFO - [logging.py:31] - [c3ab8959] POST /api/admin/addons - Client: testclient
2025-08-30 11:52:55,502 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,503 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,504 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:55,504 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,506 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:55,506 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:55,506 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255506900，包含 1 个操作
2025-08-30 11:52:55,507 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255506900 中的操作 1/1
2025-08-30 11:52:55,509 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255506900 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,509 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255506900 已回滚
2025-08-30 11:52:55,509 - api.admin.routes - ERROR - [routes.py:70] - 创建附加项失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,510 - api.middleware.logging - INFO - [logging.py:44] - [c3ab8959] 200 - Time: 0.016s
2025-08-30 11:52:55,512 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,514 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
2025-08-30 11:52:55,515 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,516 - api.middleware.logging - INFO - [logging.py:31] - [c92a169a] POST /api/admin/meals - Client: testclient
2025-08-30 11:52:55,524 - DatabaseManager - INFO - [manager.py:60] - 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
2025-08-30 11:52:55,525 - DatabaseManager - DEBUG - [manager.py:99] - 数据库优化参数配置完成
2025-08-30 11:52:55,525 - api.auth.routes - DEBUG - [routes.py:48] - 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
2025-08-30 11:52:55,525 - api.auth.routes - DEBUG - [routes.py:53] - JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
2025-08-30 11:52:55,528 - api.auth.routes - DEBUG - [routes.py:62] - 数据库查询用户: user_id=13, found=True
2025-08-30 11:52:55,528 - api.auth.routes - DEBUG - [routes.py:81] - 用户认证成功: user_id=13
2025-08-30 11:52:55,529 - DatabaseManager - DEBUG - [manager.py:147] - 开始事务 20250830115255529076，包含 1 个操作
2025-08-30 11:52:55,529 - DatabaseManager - DEBUG - [manager.py:151] - 执行事务 20250830115255529076 中的操作 1/1
2025-08-30 11:52:55,530 - DatabaseManager - ERROR - [manager.py:161] - 事务 20250830115255529076 执行失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,531 - DatabaseManager - INFO - [manager.py:164] - 事务 20250830115255529076 已回滚
2025-08-30 11:52:55,531 - api.admin.routes - ERROR - [routes.py:235] - 发布餐次失败: 用户不是管理员或账户已停用
2025-08-30 11:52:55,532 - api.middleware.logging - INFO - [logging.py:44] - [c92a169a] 200 - Time: 0.016s
2025-08-30 11:52:55,534 - DatabaseManager - INFO - [manager.py:78] - 数据库连接已关闭
2025-08-30 11:52:55,535 - httpx - INFO - [_client.py:1013] - HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [80da9de8] POST /api/auth/wechat/login - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
INFO     root:config.py:71 成功加载配置文件: /home/pp/mp/ganghaofan_cc/server/config/config-dev.json
WARNING  api.auth.wechat_service:wechat_service.py:21 微信配置缺失，将使用模拟模式
INFO     api.auth.wechat_service:wechat_service.py:91 使用模拟微信认证，code: test_admin_code
INFO     api.auth.routes:routes.py:165 未注册用户登录: mock_openid_3b77fd501946df1a
INFO     api.middleware.logging:logging.py:44 [80da9de8] 200 - Time: 0.028s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/auth/wechat/login "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c3ab8959] POST /api/admin/addons - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255506900，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255506900 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255506900 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255506900 已回滚
ERROR    api.admin.routes:routes.py:70 创建附加项失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [c3ab8959] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/addons "HTTP/1.1 200 OK"
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [c92a169a] POST /api/admin/meals - Client: testclient
INFO     DatabaseManager:manager.py:60 成功连接到数据库: /home/pp/mp/ganghaofan_cc/data/gang_hao_fan_dev.db
DEBUG    DatabaseManager:manager.py:99 数据库优化参数配置完成
DEBUG    api.auth.routes:routes.py:48 收到Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkI...
DEBUG    api.auth.routes:routes.py:53 JWT解码成功: user_id=13, open_id=mock_openid_3b77fd501946df1a
DEBUG    api.auth.routes:routes.py:62 数据库查询用户: user_id=13, found=True
DEBUG    api.auth.routes:routes.py:81 用户认证成功: user_id=13
DEBUG    DatabaseManager:manager.py:147 开始事务 20250830115255529076，包含 1 个操作
DEBUG    DatabaseManager:manager.py:151 执行事务 20250830115255529076 中的操作 1/1
ERROR    DatabaseManager:manager.py:161 事务 20250830115255529076 执行失败: 用户不是管理员或账户已停用
INFO     DatabaseManager:manager.py:164 事务 20250830115255529076 已回滚
ERROR    api.admin.routes:routes.py:235 发布餐次失败: 用户不是管理员或账户已停用
INFO     api.middleware.logging:logging.py:44 [c92a169a] 200 - Time: 0.016s
INFO     DatabaseManager:manager.py:78 数据库连接已关闭
INFO     httpx:_client.py:1013 HTTP Request: POST http://testserver/api/admin/meals "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:55,537 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:55,538 - api.middleware.logging - INFO - [logging.py:31] - [7ea8d6f0] POST /api/orders - Client: testclient
2025-08-30 11:52:55,538 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:55,538 - api.middleware.logging - ERROR - [logging.py:57] - [7ea8d6f0] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7ea8d6f0] POST /api/orders - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [7ea8d6f0] ERROR -  - Time: 0.000s
_____________ TestOrderCancellation.test_cancel_order_unauthorized _____________
tests/test_api/test_orders.py:187: in test_cancel_order_unauthorized
    response = client.delete("/api/orders/1", json=cancel_data)
E   TypeError: TestClient.delete() got an unexpected keyword argument 'json'
______________ TestOrderDetail.test_get_order_detail_unauthorized ______________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_orders.py:226: in test_get_order_detail_unauthorized
    response = client.get("/api/orders/1")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:56,559 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,560 - api.middleware.logging - INFO - [logging.py:31] - [2ca1567e] GET /api/orders/1 - Client: testclient
2025-08-30 11:52:56,560 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,561 - api.middleware.logging - ERROR - [logging.py:57] - [2ca1567e] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [2ca1567e] GET /api/orders/1 - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [2ca1567e] ERROR -  - Time: 0.000s
________________ TestUserProfile.test_get_profile_unauthorized _________________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_users.py:29: in test_get_profile_unauthorized
    response = client.get("/api/users/profile")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:56,835 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:56,836 - api.middleware.logging - INFO - [logging.py:31] - [4596337d] GET /api/users/profile - Client: testclient
2025-08-30 11:52:56,836 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:56,836 - api.middleware.logging - ERROR - [logging.py:57] - [4596337d] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [4596337d] GET /api/users/profile - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [4596337d] ERROR -  - Time: 0.000s
________________ TestUserBalance.test_get_balance_unauthorized _________________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_users.py:57: in test_get_balance_unauthorized
    response = client.get("/api/users/balance")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:57,123 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,124 - api.middleware.logging - INFO - [logging.py:31] - [8a494b1d] GET /api/users/balance - Client: testclient
2025-08-30 11:52:57,124 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,125 - api.middleware.logging - ERROR - [logging.py:57] - [8a494b1d] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [8a494b1d] GET /api/users/balance - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [8a494b1d] ERROR -  - Time: 0.000s
_________________ TestUserLedger.test_get_ledger_unauthorized __________________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_users.py:99: in test_get_ledger_unauthorized
    response = client.get("/api/users/ledger")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:57,526 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,527 - api.middleware.logging - INFO - [logging.py:31] - [be13d937] GET /api/users/ledger - Client: testclient
2025-08-30 11:52:57,527 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,527 - api.middleware.logging - ERROR - [logging.py:57] - [be13d937] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [be13d937] GET /api/users/ledger - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [be13d937] ERROR -  - Time: 0.000s
_______________ TestUserOrders.test_get_user_orders_unauthorized _______________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_users.py:137: in test_get_user_orders_unauthorized
    response = client.get("/api/users/orders")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:57,959 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:57,960 - api.middleware.logging - INFO - [logging.py:31] - [495dc524] GET /api/users/orders - Client: testclient
2025-08-30 11:52:57,960 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:57,960 - api.middleware.logging - ERROR - [logging.py:57] - [495dc524] ERROR -  - Time: 0.000s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [495dc524] GET /api/users/orders - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [495dc524] ERROR -  - Time: 0.000s
_____________ TestUserStatistics.test_get_statistics_unauthorized ______________
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:78: in call_next
    message = await recv_stream.receive()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:98: in receive
    return self.receive_nowait()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/streams/memory.py:91: in receive_nowait
    raise EndOfStream
E   anyio.EndOfStream

During handling of the above exception, another exception occurred:
tests/test_api/test_users.py:181: in test_get_statistics_unauthorized
    response = client.get("/api/users/statistics/orders")
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:499: in get
    return super().get(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1041: in get
    return self.request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:465: in request
    return super().request(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/logging.py:38: in log_requests
    response = await call_next(request)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
/home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
api/middleware/security.py:78: in rate_limiting
    raise HTTPException(status_code=429, detail="Too many requests")
E   fastapi.exceptions.HTTPException
----------------------------- Captured stderr call -----------------------------
2025-08-30 11:52:58,379 - asyncio - DEBUG - [selector_events.py:54] - Using selector: EpollSelector
2025-08-30 11:52:58,380 - api.middleware.logging - INFO - [logging.py:31] - [7f51a3f1] GET /api/users/statistics/orders - Client: testclient
2025-08-30 11:52:58,380 - api.middleware.security - WARNING - [security.py:77] - Rate limit exceeded for IP testclient
2025-08-30 11:52:58,387 - api.middleware.logging - ERROR - [logging.py:57] - [7f51a3f1] ERROR -  - Time: 0.007s
------------------------------ Captured log call -------------------------------
DEBUG    asyncio:selector_events.py:54 Using selector: EpollSelector
INFO     api.middleware.logging:logging.py:31 [7f51a3f1] GET /api/users/statistics/orders - Client: testclient
WARNING  api.middleware.security:security.py:77 Rate limit exceeded for IP testclient
ERROR    api.middleware.logging:logging.py:57 [7f51a3f1] ERROR -  - Time: 0.007s
=============================== warnings summary ===============================
../../../miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/test_api/test_admin.py: 19 warnings
tests/test_api/test_auth.py: 3 warnings
tests/test_api/test_meals.py: 10 warnings
tests/test_api/test_orders.py: 9 warnings
  /home/pp/mp/ganghaofan_cc/server/api/auth/routes.py:168: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    data=response_data.dict(),

tests/test_api/test_admin.py: 22 warnings
tests/test_api/test_auth.py: 5 warnings
tests/test_api/test_meals.py: 10 warnings
tests/test_api/test_orders.py: 9 warnings
  /home/pp/miniconda3/envs/ganghaofan_test/lib/python3.11/site-packages/pydantic/main.py:979: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn('The `dict` method is deprecated; use `model_dump` instead.', DeprecationWarning)

tests/test_api/test_admin.py::TestAdminUsers::test_set_user_admin_status
tests/test_api/test_admin.py::TestAdminUsers::test_set_user_status
tests/test_api/test_admin.py::TestAdminUsers::test_adjust_user_balance
tests/test_api/test_auth.py::TestTokenValidation::test_valid_token_access
  /home/pp/mp/ganghaofan_cc/server/api/users/routes.py:73: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    data=profile_data.dict(),

tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh
  /home/pp/mp/ganghaofan_cc/server/api/auth/routes.py:239: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    data=response_data.dict(),

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_api/test_admin.py::TestAdminAddons::test_create_addon_success
FAILED tests/test_api/test_admin.py::TestAdminAddons::test_create_addon_unauthorized
FAILED tests/test_api/test_admin.py::TestAdminAddons::test_deactivate_addon_success
FAILED tests/test_api/test_admin.py::TestAdminAddons::test_deactivate_addon_nonexistent
FAILED tests/test_api/test_admin.py::TestAdminMeals::test_publish_meal_success
FAILED tests/test_api/test_admin.py::TestAdminMeals::test_lock_meal_success
FAILED tests/test_api/test_admin.py::TestAdminMeals::test_complete_meal_success
FAILED tests/test_api/test_admin.py::TestAdminMeals::test_cancel_meal_success
FAILED tests/test_api/test_admin.py::TestAdminPermissions::test_non_admin_access_denied
FAILED tests/test_api/test_admin.py::TestAdminPermissions::test_unauthenticated_access_denied
FAILED tests/test_api/test_auth.py::TestAuthRoutes::test_wechat_auth_success
FAILED tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh - Asse...
FAILED tests/test_api/test_auth.py::TestAuthRoutes::test_token_refresh_missing_token
FAILED tests/test_api/test_auth.py::TestTokenValidation::test_missing_token_access
FAILED tests/test_api/test_meals.py::TestMealsList::test_get_meals_missing_dates
FAILED tests/test_api/test_meals.py::TestMealsList::test_get_meals_invalid_date_range
FAILED tests/test_api/test_meals.py::TestMealsList::test_get_meals_unauthorized
FAILED tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail - a...
FAILED tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail_nonexistent
FAILED tests/test_api/test_meals.py::TestMealDetail::test_get_meal_detail_unauthorized
FAILED tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order
FAILED tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order_nonexistent_meal
FAILED tests/test_api/test_meals.py::TestMealOrder::test_check_user_meal_order_unauthorized
FAILED tests/test_api/test_orders.py::TestOrderCreation::test_create_order_success
FAILED tests/test_api/test_orders.py::TestOrderCreation::test_create_order_nonexistent_meal
FAILED tests/test_api/test_orders.py::TestOrderCreation::test_create_order_insufficient_balance
FAILED tests/test_api/test_orders.py::TestOrderCreation::test_create_order_unauthorized
FAILED tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_unauthorized
FAILED tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail_unauthorized
FAILED tests/test_api/test_users.py::TestUserProfile::test_get_profile_unauthorized
FAILED tests/test_api/test_users.py::TestUserBalance::test_get_balance_unauthorized
FAILED tests/test_api/test_users.py::TestUserLedger::test_get_ledger_unauthorized
FAILED tests/test_api/test_users.py::TestUserOrders::test_get_user_orders_unauthorized
FAILED tests/test_api/test_users.py::TestUserStatistics::test_get_statistics_unauthorized
ERROR tests/test_api/test_admin.py::TestAdminUsers::test_set_user_admin_status
ERROR tests/test_api/test_admin.py::TestAdminUsers::test_set_user_status - Ke...
ERROR tests/test_api/test_admin.py::TestAdminUsers::test_adjust_user_balance
ERROR tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_success
ERROR tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_nonexistent
ERROR tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_not_owned
ERROR tests/test_api/test_orders.py::TestOrderCancellation::test_cancel_order_missing_reason
ERROR tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail
ERROR tests/test_api/test_orders.py::TestOrderDetail::test_get_order_detail_nonexistent
ERROR tests/test_api/test_users.py::TestUserProfile::test_get_profile_success
ERROR tests/test_api/test_users.py::TestUserBalance::test_get_balance - fasta...
ERROR tests/test_api/test_users.py::TestUserLedger::test_get_ledger_history
ERROR tests/test_api/test_users.py::TestUserLedger::test_get_ledger_history_with_pagination
ERROR tests/test_api/test_users.py::TestUserOrders::test_get_user_orders - fa...
ERROR tests/test_api/test_users.py::TestUserOrders::test_get_user_orders_with_pagination
ERROR tests/test_api/test_users.py::TestUserStatistics::test_get_order_statistics
ERROR tests/test_api/test_users.py::TestUserStatistics::test_get_transaction_statistics
============ 34 failed, 12 passed, 93 warnings, 17 errors in 6.57s =============
