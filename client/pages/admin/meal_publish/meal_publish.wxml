<!--ç®¡ç†å‘˜å‘å¸ƒé¤é¡µé¢-->
<!--å‚è€ƒæ–‡æ¡£: doc/client/page_meal_publish.md-->

<!-- åŠ è½½çŠ¶æ€ -->
<view wx:if="{{loading}}" class="loading-container">
  <view class="loading-content">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<view wx:else class="container">
  <!-- é¡µé¢å¤´éƒ¨ä¿¡æ¯ -->
  <view class="header-section">
    <view class="date-info">
      <text class="date-text">ğŸ“… {{date}}</text>
      <text class="slot-text">{{slot === 'lunch' ? 'åˆé¤' : 'æ™šé¤'}}</text>
    </view>
    <view wx:if="{{meal}}" class="status-info">
      <text class="status-text status-{{meal.status}}">
        {{meal.status === 'published' ? 'å·²å‘å¸ƒ ğŸŸ¢' : meal.status === 'locked' ? 'å·²é”å®š ğŸŸ¡' : meal.status === 'completed' ? 'å·²å®Œæˆ âœ…' : meal.status === 'canceled' ? 'å·²å–æ¶ˆ âŒ' : 'æœªçŸ¥çŠ¶æ€'}}
      </text>
    </view>
  </view>

  <!-- é¤æ¬¡ä¿¡æ¯åŒºåŸŸ -->
  <view wx:if="{{meal && pageMode !== 'publish'}}" class="meal-info-section">
    <view class="section-title">ğŸ“ é¤æ¬¡ä¿¡æ¯</view>
    <view class="meal-info">
      <view class="info-row">
        <text class="info-label">æè¿°ï¼š</text>
        <text class="info-value">{{meal.description}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">åŸºç¡€ä»·æ ¼ï¼š</text>
        <text class="info-value">Â¥{{meal.base_price_yuan}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">è®¢é¤æƒ…å†µï¼š</text>
        <text class="info-value">{{orderStats.active_orders || 0}}/{{meal.max_orders}} äºº</text>
      </view>
      <view wx:if="{{orderStats.total_orders > 0}}" class="info-row">
        <button class="view-details-btn" bind:tap="onViewOrderDetails">
          ğŸ“Š æŸ¥çœ‹ä¸‹å•è¯¦æƒ… â†’
        </button>
      </view>
    </view>
    
    <!-- é™„åŠ é¡¹ä¿¡æ¯æ˜¾ç¤ºï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰ -->
    <view wx:if="{{meal.addon_config}}" class="addon-info-section">
      <view class="section-subtitle">ğŸ– å·²é…ç½®é™„åŠ é¡¹</view>
      <view class="addon-display">
        <view
          wx:for="{{addons}}"
          wx:key="addon_id"
          wx:if="{{meal.addon_config[item.addon_id]}}"
          class="addon-display-item"
        >
          <text class="addon-display-name">{{item.name}}</text>
          <text class="addon-display-price">Â¥{{item.price_yuan}}</text>
          <text class="addon-display-quantity">æœ€å¤š {{meal.addon_config[item.addon_id]}} ä»½</text>
        </view>
      </view>
    </view>
  </view>

  <!-- é¤æ¬¡è¡¨å•åŒºåŸŸ -->
  <view wx:if="{{pageMode === 'publish'}}" class="form-section">
    <view class="section-title">
      ğŸ“ å‘å¸ƒé¤æ¬¡
    </view>
    
    <!-- é¤æ¬¡æè¿° -->
    <view class="form-item">
      <text class="form-label">é¤æ¬¡æè¿°</text>
      <textarea
        class="form-textarea"
        placeholder="è¯·è¾“å…¥é¤æ¬¡æè¿°ï¼ˆå¦‚ï¼šçº¢çƒ§è‚‰å¥—é¤ï¼Œé…ç™½ç±³é¥­å’Œæ±¤ï¼‰"
        value="{{mealForm.description}}"
        bind:input="onDescriptionInput"
        maxlength="200"
        auto-height="{{true}}"
      />
    </view>

    <!-- åŸºç¡€ä»·æ ¼ -->
    <view class="form-item">
      <text class="form-label">åŸºç¡€ä»·æ ¼ï¼ˆå…ƒï¼‰</text>
      <view class="price-input-container">
        <input
          class="form-input price-input"
          type="digit"
          placeholder="18"
          value="{{mealForm.base_price_yuan}}"
          bind:input="onPriceInput"
        />
        <view class="quick-prices">
          <button
            wx:for="{{quickPrices}}"
            wx:key="*this"
            class="quick-price-btn {{mealForm.base_price_yuan === item ? 'active' : ''}}"
            data-price="{{item}}"
            bind:tap="onQuickPriceSelect"
          >
            Â¥{{item}}
          </button>
        </view>
      </view>
    </view>

    <!-- è®¢é¤ä¸Šé™ -->
    <view class="form-item">
      <text class="form-label">è®¢é¤ä¸Šé™ï¼ˆäººï¼‰</text>
      <input
        class="form-input"
        type="number"
        placeholder="50"
        value="{{mealForm.max_orders}}"
        bind:input="onMaxOrdersInput"
      />
    </view>

    <!-- é™„åŠ é¡¹é…ç½® -->
    <view class="form-item">
      <text class="form-label">ğŸ– é™„åŠ é¡¹é…ç½®ï¼ˆå¯å¤šé€‰ï¼‰</text>
      <view class="addons-config">
        <view
          wx:for="{{addons}}"
          wx:key="addon_id"
          class="addon-item"
        >
          <view class="addon-info" bind:tap="onAddonToggle" data-addon-id="{{item.addon_id}}">
            <text class="addon-checkbox">
              {{mealForm.addon_config[item.addon_id] ? 'â˜‘ï¸' : 'â˜'}}
            </text>
            <text class="addon-name">{{item.name}}</text>
            <text class="addon-price">Â¥{{item.price_yuan}}</text>
          </view>
          <view wx:if="{{mealForm.addon_config[item.addon_id]}}" class="addon-quantity">
            <text class="quantity-label">æœ€å¤š:</text>
            <button
              class="quantity-btn"
              data-addon-id="{{item.addon_id}}"
              data-type="decrease"
              bind:tap="onAddonQuantityChange"
            >
              -
            </button>
            <text class="quantity-value">{{mealForm.addon_config[item.addon_id]}}</text>
            <button
              class="quantity-btn"
              data-addon-id="{{item.addon_id}}"
              data-type="increase"
              bind:tap="onAddonQuantityChange"
            >
              +
            </button>
            <text class="quantity-unit">ä»½</text>
          </view>
        </view>
      </view>
      
      <!-- é¢„ä¼°æ€»ä»·èŒƒå›´ -->
      <view wx:if="{{priceRange}}" class="price-range">
        <text class="price-range-text">
          é¢„ä¼°æ€»ä»·èŒƒå›´ï¼šÂ¥{{priceRange.min}} - Â¥{{priceRange.max}}
        </text>
        <view wx:if="{{priceRange.min < mealForm.base_price_yuan}}" class="price-note">
          (å«è´Ÿä»·æ ¼é™„åŠ é¡¹)
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="actions-section">
    <!-- å‘å¸ƒé¤æ¬¡ -->
    <button
      wx:if="{{pageMode === 'publish'}}"
      class="action-btn primary"
      loading="{{submitting}}"
      disabled="{{submitting}}"
      bind:tap="onPublishMeal"
    >
      ğŸ“ å‘å¸ƒé¤æ¬¡
    </button>

    <!-- å·²å‘å¸ƒçŠ¶æ€æŒ‰é’® -->
    <view wx:elif="{{pageMode === 'view' && meal.status === 'published'}}" class="view-actions">
      <button
        class="action-btn warning"
        data-action="lock"
        bind:tap="onMealStatusAction"
      >
        ğŸ”’ é”å®š
      </button>
      <button
        class="action-btn danger"
        data-action="cancel"
        bind:tap="onMealStatusAction"
      >
        âŒ å–æ¶ˆ
      </button>
    </view>

    <!-- é”å®šçŠ¶æ€æŒ‰é’® -->
    <view wx:elif="{{pageMode === 'view' && meal.status === 'locked'}}" class="locked-actions">
      <button
        class="action-btn success"
        data-action="complete"
        bind:tap="onMealStatusAction"
      >
        âœ… å®Œæˆ
      </button>
      <button
        class="action-btn secondary"
        data-action="unlock"
        bind:tap="onMealStatusAction"
      >
        ğŸ”“ å–æ¶ˆé”å®š
      </button>
    </view>

    <!-- å·²å®ŒæˆçŠ¶æ€ -->
    <view wx:elif="{{pageMode === 'readonly' && meal.status === 'completed'}}" class="readonly-status">
      <text class="status-message">é¤æ¬¡å·²å®Œæˆ âœ…</text>
    </view>

    <!-- å·²å–æ¶ˆçŠ¶æ€ -->
    <view wx:elif="{{pageMode === 'readonly' && meal.status === 'canceled'}}" class="readonly-status">
      <text class="status-message">é¤æ¬¡å·²å–æ¶ˆ âŒ</text>
    </view>
  </view>
</view>