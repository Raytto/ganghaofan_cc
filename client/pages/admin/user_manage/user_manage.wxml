<!--ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†é¡µé¢-->
<!--å‚è€ƒæ–‡æ¡£: doc/client/page_user_manage.md-->

<view class="container">
  <!-- åŠŸèƒ½æ  -->
  <view class="function-bar">
    <view class="function-left">
      <view class="search-box">
        <input
          class="search-input"
          placeholder="ğŸ” æœç´¢ç”¨æˆ·åæˆ–ID"
          value="{{filters.search}}"
          bind:input="onSearchInput"
        />
      </view>
      <view class="filter-toggle" bind:tap="onToggleFilters">
        <text class="filter-icon {{showFilters ? 'active' : ''}}">âš™ï¸</text>
      </view>
    </view>
    <view class="function-actions">
      <button wx:if="{{users.length > 0}}" class="export-btn" bind:tap="onExportUsers">
        ğŸ“Š å¯¼å‡º
      </button>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilters}}" class="filter-panel">
    <view class="filter-section">
      <view class="filter-item">
        <text class="filter-label">ç”¨æˆ·çŠ¶æ€ï¼š</text>
        <picker
          range="{{statusOptions}}"
          range-key="label"
          value="{{statusOptions.findIndex(item => item.value === filters.status)}}"
          bind:change="onFilterChange"
          data-field="status"
        >
          <view class="picker-value">
            {{statusOptions[statusOptions.findIndex(item => item.value === filters.status)]?.label || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">ç”¨æˆ·è§’è‰²ï¼š</text>
        <picker
          range="{{roleOptions}}"
          range-key="label"
          value="{{roleOptions.findIndex(item => item.value === filters.role)}}"
          bind:change="onFilterChange"
          data-field="role"
        >
          <view class="picker-value">
            {{roleOptions[roleOptions.findIndex(item => item.value === filters.role)]?.label || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="filter-btn reset" bind:tap="onResetFilters">é‡ç½®</button>
      <button class="filter-btn apply" bind:tap="onApplyFilters">åº”ç”¨</button>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view wx:if="{{showBatchActions}}" class="batch-actions-bar">
    <view class="batch-info">
      <text class="selected-count">å·²é€‰æ‹© {{selectedUsers.length}} ä½ç”¨æˆ·</text>
      <button class="select-all-btn" bind:tap="onToggleSelectAll">
        {{selectedUsers.length === users.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
    </view>
    <view class="batch-buttons">
      <button class="batch-btn activate" data-action="activate" bind:tap="onBatchAction">
        æ¿€æ´»ç”¨æˆ·
      </button>
      <button class="batch-btn suspend" data-action="suspend" bind:tap="onBatchAction">
        æš‚åœç”¨æˆ·
      </button>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{pagination.total > 0}}" class="stats-bar">
    <text class="stats-text">å…± {{pagination.total}} ä½ç”¨æˆ·</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading && users.length === 0}}" class="loading-container">
    <view class="loading-content">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <view wx:elif="{{users.length > 0}}" class="user-list">
    <view 
      wx:for="{{users}}" 
      wx:key="user_id" 
      class="user-item {{selectedUsers.includes(item.user_id) ? 'selected' : ''}}"
      bind:tap="onUserItemTap"
      data-user-id="{{item.user_id}}"
    >
      <!-- å¤šé€‰æ¡† -->
      <view class="selection-checkbox" 
            bind:tap="onToggleUserSelection" 
            data-user-id="{{item.user_id}}"
            catchtap="true">
        <text class="checkbox-icon">
          {{selectedUsers.includes(item.user_id) ? 'â˜‘ï¸' : 'â˜'}}
        </text>
      </view>

      <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
      <view class="user-header">
        <view class="user-avatar">
          <text class="avatar-text">{{item.name.charAt(0)}}</text>
        </view>
        <view class="user-info">
          <view class="user-name-row">
            <text class="user-name">{{item.name}}</text>
            <text class="user-role">{{formatUserRole(item.role)}}</text>
          </view>
          <view class="user-details">
            <text class="user-id">ID: {{item.user_id}}</text>
            <text class="user-status">{{formatUserStatus(item.status)}}</text>
          </view>
        </view>
      </view>

      <!-- ç”¨æˆ·æ•°æ® -->
      <view class="user-data">
        <view class="data-item">
          <text class="data-label">ä½™é¢</text>
          <text class="data-value balance">Â¥{{item.balance_yuan}}</text>
        </view>
        <view class="data-item">
          <text class="data-label">è®¢å•æ•°</text>
          <text class="data-value">{{item.order_count || 0}}</text>
        </view>
        <view class="data-item">
          <text class="data-label">æœ€åç™»å½•</text>
          <text class="data-value">{{formatLastLogin(item.last_login_at)}}</text>
        </view>
      </view>

      <!-- è”ç³»ä¿¡æ¯ -->
      <view wx:if="{{item.phone || item.email}}" class="user-contact">
        <text wx:if="{{item.phone}}" class="contact-item">ğŸ“± {{item.phone}}</text>
        <text wx:if="{{item.email}}" class="contact-item">ğŸ“§ {{item.email}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="user-actions">
        <button class="action-btn view-orders" 
                data-user-id="{{item.user_id}}"
                bind:tap="onViewUserOrders"
                catchtap="true">
          ğŸ“‹ è®¢å•
        </button>
        
        <button wx:if="{{item.status === 'active'}}" 
                class="action-btn suspend" 
                data-user-id="{{item.user_id}}"
                data-action="suspend"
                bind:tap="onUserStatusAction"
                catchtap="true">
          æš‚åœ
        </button>
        
        <button wx:if="{{item.status === 'suspended'}}" 
                class="action-btn activate" 
                data-user-id="{{item.user_id}}"
                data-action="activate"
                bind:tap="onUserStatusAction"
                catchtap="true">
          æ¿€æ´»
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{!loading}}" class="empty-container">
    <view class="empty-content">
      <text class="empty-icon">ğŸ‘¥</text>
      <text class="empty-text">æš‚æ— ç”¨æˆ·æ•°æ®</text>
      <text class="empty-tip">ç­‰å¾…ç”¨æˆ·æ³¨å†Œ</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{loadingMore}}" class="loading-more">
    <text class="loading-more-text">åŠ è½½æ›´å¤š...</text>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view wx:elif="{{users.length > 0 && !pagination.has_more}}" class="no-more">
    <text class="no-more-text">æ²¡æœ‰æ›´å¤šç”¨æˆ·äº†</text>
  </view>

  <!-- ç”¨æˆ·æ“ä½œå¼¹çª— -->
  <view wx:if="{{showUserModal && currentUser}}" class="user-modal">
    <view class="modal-mask" bind:tap="onHideUserModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ğŸ‘¤ {{currentUser.name}}</text>
        <text class="modal-close" bind:tap="onHideUserModal">âœ•</text>
      </view>
      
      <view class="modal-body">
        <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
        <view class="user-summary">
          <view class="summary-item">
            <text class="summary-label">ç”¨æˆ·IDï¼š</text>
            <text class="summary-value">{{currentUser.user_id}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">å½“å‰ä½™é¢ï¼š</text>
            <text class="summary-value balance">Â¥{{currentUser.balance_yuan}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">ç”¨æˆ·çŠ¶æ€ï¼š</text>
            <text class="summary-value">{{formatUserStatus(currentUser.status)}}</text>
          </view>
        </view>
        
        <!-- ä½™é¢æ“ä½œ -->
        <view class="balance-operation">
          <text class="operation-title">ğŸ’° ä½™é¢æ“ä½œ</text>
          
          <view class="operation-type">
            <view class="type-buttons">
              <button 
                class="type-btn {{userOperationForm.operation_type === 'recharge' ? 'active' : ''}}"
                data-field="operation_type"
                data-value="recharge"
                bind:tap="onOperationFormChange"
              >
                å……å€¼
              </button>
              <button 
                class="type-btn {{userOperationForm.operation_type === 'deduct' ? 'active' : ''}}"
                data-field="operation_type" 
                data-value="deduct"
                bind:tap="onOperationFormChange"
              >
                æ‰£è´¹
              </button>
            </view>
          </view>
          
          <view class="amount-input-section">
            <text class="input-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
            <input
              class="amount-input"
              type="digit"
              placeholder="è¯·è¾“å…¥é‡‘é¢"
              value="{{userOperationForm.balance_change}}"
              data-field="balance_change"
              bind:input="onOperationFormChange"
              maxlength="6"
            />
          </view>
          
          <view class="quick-amounts">
            <text class="quick-label">å¿«æ·é€‰æ‹©ï¼š</text>
            <view class="quick-buttons">
              <button
                wx:for="{{quickAmounts}}"
                wx:key="*this"
                class="quick-btn {{userOperationForm.balance_change === item ? 'active' : ''}}"
                data-amount="{{item}}"
                bind:tap="onQuickAmountSelect"
              >
                Â¥{{item}}
              </button>
            </view>
          </view>
          
          <view class="reason-input-section">
            <text class="input-label">æ“ä½œåŸå› </text>
            <textarea
              class="reason-input"
              placeholder="è¯·è¾“å…¥æ“ä½œåŸå› "
              value="{{userOperationForm.reason}}"
              data-field="reason"
              bind:input="onOperationFormChange"
              maxlength="200"
            />
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bind:tap="onHideUserModal">å–æ¶ˆ</button>
        <button 
          class="modal-btn confirm" 
          loading="{{submittingOperation}}"
          disabled="{{submittingOperation || !userOperationForm.balance_change || !userOperationForm.reason}}"
          bind:tap="onSubmitUserOperation"
        >
          ç¡®è®¤æ“ä½œ
        </button>
      </view>
    </view>
  </view>
</view>