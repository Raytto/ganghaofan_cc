<!--è®¢å•åˆ—è¡¨é¡µé¢-->
<!--å‚è€ƒæ–‡æ¡£: doc/client/page_order_list.md-->

<view class="container">
  <!-- ç­›é€‰æŒ‰é’® -->
  <view class="filter-bar">
    <view class="filter-toggle" bind:tap="onToggleFilters">
      <text class="filter-text">ğŸ” ç­›é€‰</text>
      <text class="filter-icon {{showFilters ? 'active' : ''}}">â–¼</text>
    </view>
    <view wx:if="{{isAdmin}}" class="admin-actions">
      <button wx:if="{{orders.length > 0}}" class="export-btn" bind:tap="onExportOrders">
        ğŸ“Š å¯¼å‡º
      </button>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilters}}" class="filter-panel">
    <view class="filter-section">
      <view class="filter-item">
        <text class="filter-label">è®¢å•çŠ¶æ€ï¼š</text>
        <picker
          range="{{statusOptions}}"
          range-key="label"
          value="{{statusOptions.findIndex(item => item.value === filters.status)}}"
          bind:change="onFilterChange"
          data-field="status"
        >
          <view class="picker-value">
            {{statusOptions[statusOptions.findIndex(item => item.value === filters.status)]?.label || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">å¼€å§‹æ—¥æœŸï¼š</text>
        <picker
          mode="date"
          value="{{filters.date_from}}"
          bind:change="onFilterChange"
          data-field="date_from"
        >
          <view class="picker-value">
            {{filters.date_from || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">ç»“æŸæ—¥æœŸï¼š</text>
        <picker
          mode="date"
          value="{{filters.date_to}}"
          bind:change="onFilterChange"
          data-field="date_to"
        >
          <view class="picker-value">
            {{filters.date_to || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="filter-btn reset" bind:tap="onResetFilters">é‡ç½®</button>
      <button class="filter-btn apply" bind:tap="onApplyFilters">åº”ç”¨</button>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view wx:if="{{isAdmin && showBatchActions}}" class="batch-actions-bar">
    <view class="batch-info">
      <text class="selected-count">å·²é€‰æ‹© {{selectedOrders.length}} é¡¹</text>
      <button class="select-all-btn" bind:tap="onToggleSelectAll">
        {{selectedOrders.length === orders.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
    </view>
    <view class="batch-buttons">
      <button class="batch-btn confirm" data-action="confirm" bind:tap="onBatchAction">
        ç¡®è®¤è®¢å•
      </button>
      <button class="batch-btn complete" data-action="complete" bind:tap="onBatchAction">
        æ ‡è®°å®Œæˆ
      </button>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading && orders.length === 0}}" class="loading-container">
    <view class="loading-content">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view wx:elif="{{orders.length > 0}}" class="order-list">
    <view 
      wx:for="{{orders}}" 
      wx:key="order_id" 
      class="order-item {{selectedOrders.includes(item.order_id) ? 'selected' : ''}}"
      bind:tap="onOrderItemTap"
      data-order-id="{{item.order_id}}"
    >
      <!-- ç®¡ç†å‘˜å¤šé€‰æ¡† -->
      <view wx:if="{{isAdmin}}" class="selection-checkbox" 
            bind:tap="onToggleOrderSelection" 
            data-order-id="{{item.order_id}}"
            catchtap="true">
        <text class="checkbox-icon">
          {{selectedOrders.includes(item.order_id) ? 'â˜‘ï¸' : 'â˜'}}
        </text>
      </view>

      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-id">è®¢å• #{{item.order_id}}</text>
          <text class="order-time">{{formatDateTime(item.created_at)}}</text>
        </view>
        <view class="order-status">
          <text class="status-text status-{{item.status}}">
            {{formatStatus(item.status)}}
          </text>
        </view>
      </view>

      <!-- é¤æ¬¡ä¿¡æ¯ -->
      <view class="meal-info">
        <view class="meal-basic">
          <text class="meal-date">ğŸ“… {{item.meal_date}}</text>
          <text class="meal-slot">{{item.meal_slot === 'lunch' ? 'ğŸ± åˆé¤' : 'ğŸ½ï¸ æ™šé¤'}}</text>
        </view>
        <view wx:if="{{item.meal_description}}" class="meal-description">
          <text class="description-text">{{item.meal_description}}</text>
        </view>
      </view>

      <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
      <view wx:if="{{isAdmin && item.user_name}}" class="user-info">
        <text class="user-label">ä¸‹å•ç”¨æˆ·ï¼š</text>
        <text class="user-name">{{item.user_name}}</text>
      </view>

      <!-- é™„åŠ é¡¹ä¿¡æ¯ -->
      <view wx:if="{{item.addon_details && item.addon_details.length > 0}}" class="addon-info">
        <text class="addon-title">é™„åŠ é¡¹ï¼š</text>
        <view class="addon-list">
          <view 
            wx:for="{{item.addon_details}}" 
            wx:key="addon_id"
            wx:for-item="addon"
            class="addon-item"
          >
            <text class="addon-name">{{addon.name}}</text>
            <text class="addon-quantity">Ã—{{addon.quantity}}</text>
          </view>
        </view>
      </view>

      <!-- ä»·æ ¼ä¿¡æ¯ -->
      <view class="price-info">
        <view class="price-breakdown">
          <text class="base-price">åŸºç¡€ï¼šÂ¥{{item.base_price_yuan}}</text>
          <text wx:if="{{item.addon_price_yuan !== 0}}" class="addon-price">
            é™„åŠ é¡¹ï¼š{{item.addon_price_yuan >= 0 ? '+' : ''}}Â¥{{item.addon_price_yuan}}
          </text>
        </view>
        <text class="total-price">æ€»è®¡ï¼šÂ¥{{item.total_price_yuan}}</text>
      </view>

      <!-- è®¢å•æ“ä½œæŒ‰é’® -->
      <view class="order-actions">
        <!-- ç”¨æˆ·æ“ä½œ -->
        <view wx:if="{{!isAdmin && item.status === 'placed'}}" class="user-actions">
          <button 
            class="action-btn cancel" 
            data-order-id="{{item.order_id}}"
            data-action="cancel"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            å–æ¶ˆè®¢å•
          </button>
        </view>

        <!-- ç®¡ç†å‘˜æ“ä½œ -->
        <view wx:if="{{isAdmin}}" class="admin-actions">
          <button 
            wx:if="{{item.status === 'placed'}}"
            class="action-btn confirm" 
            data-order-id="{{item.order_id}}"
            data-action="confirm"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            ç¡®è®¤
          </button>
          <button 
            wx:if="{{item.status === 'confirmed'}}"
            class="action-btn complete" 
            data-order-id="{{item.order_id}}"
            data-action="complete"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            å®Œæˆ
          </button>
          <button 
            wx:if="{{['placed', 'confirmed'].includes(item.status)}}"
            class="action-btn cancel" 
            data-order-id="{{item.order_id}}"
            data-action="cancel"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            å–æ¶ˆ
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{!loading}}" class="empty-container">
    <view class="empty-content">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <text class="empty-tip">{{isAdmin ? 'ç­‰å¾…ç”¨æˆ·ä¸‹å•' : 'å¿«å»ä¸‹å•å§'}}</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{loadingMore}}" class="loading-more">
    <text class="loading-more-text">åŠ è½½æ›´å¤š...</text>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view wx:elif="{{orders.length > 0 && !pagination.has_more}}" class="no-more">
    <text class="no-more-text">æ²¡æœ‰æ›´å¤šè®¢å•äº†</text>
  </view>
</view>