<!--订单列表页面-->
<!--参考文档: doc/client/page_order_list.md-->

<view class="container">
  <!-- 筛选按钮 -->
  <view class="filter-bar">
    <view class="filter-toggle" bind:tap="onToggleFilters">
      <text class="filter-text">🔍 筛选</text>
      <text class="filter-icon {{showFilters ? 'active' : ''}}">▼</text>
    </view>
    <view wx:if="{{isAdmin}}" class="admin-actions">
      <button wx:if="{{orders.length > 0}}" class="export-btn" bind:tap="onExportOrders">
        📊 导出
      </button>
    </view>
  </view>

  <!-- 筛选面板 -->
  <view wx:if="{{showFilters}}" class="filter-panel">
    <view class="filter-section">
      <view class="filter-item">
        <text class="filter-label">订单状态：</text>
        <picker
          range="{{statusOptions}}"
          range-key="label"
          value="{{statusOptions.findIndex(item => item.value === filters.status)}}"
          bind:change="onFilterChange"
          data-field="status"
        >
          <view class="picker-value">
            {{statusOptions[statusOptions.findIndex(item => item.value === filters.status)]?.label || '请选择'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">开始日期：</text>
        <picker
          mode="date"
          value="{{filters.date_from}}"
          bind:change="onFilterChange"
          data-field="date_from"
        >
          <view class="picker-value">
            {{filters.date_from || '请选择'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">结束日期：</text>
        <picker
          mode="date"
          value="{{filters.date_to}}"
          bind:change="onFilterChange"
          data-field="date_to"
        >
          <view class="picker-value">
            {{filters.date_to || '请选择'}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="filter-btn reset" bind:tap="onResetFilters">重置</button>
      <button class="filter-btn apply" bind:tap="onApplyFilters">应用</button>
    </view>
  </view>

  <!-- 批量操作栏 -->
  <view wx:if="{{isAdmin && showBatchActions}}" class="batch-actions-bar">
    <view class="batch-info">
      <text class="selected-count">已选择 {{selectedOrders.length}} 项</text>
      <button class="select-all-btn" bind:tap="onToggleSelectAll">
        {{selectedOrders.length === orders.length ? '取消全选' : '全选'}}
      </button>
    </view>
    <view class="batch-buttons">
      <button class="batch-btn confirm" data-action="confirm" bind:tap="onBatchAction">
        确认订单
      </button>
      <button class="batch-btn complete" data-action="complete" bind:tap="onBatchAction">
        标记完成
      </button>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading && orders.length === 0}}" class="loading-container">
    <view class="loading-content">
      <text class="loading-text">加载中...</text>
    </view>
  </view>

  <!-- 订单列表 -->
  <view wx:elif="{{orders.length > 0}}" class="order-list">
    <view 
      wx:for="{{orders}}" 
      wx:key="order_id" 
      class="order-item {{selectedOrders.includes(item.order_id) ? 'selected' : ''}}"
      bind:tap="onOrderItemTap"
      data-order-id="{{item.order_id}}"
    >
      <!-- 管理员多选框 -->
      <view wx:if="{{isAdmin}}" class="selection-checkbox" 
            bind:tap="onToggleOrderSelection" 
            data-order-id="{{item.order_id}}"
            catchtap="true">
        <text class="checkbox-icon">
          {{selectedOrders.includes(item.order_id) ? '☑️' : '☐'}}
        </text>
      </view>

      <!-- 订单基本信息 -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-id">订单 #{{item.order_id}}</text>
          <text class="order-time">{{formatDateTime(item.created_at)}}</text>
        </view>
        <view class="order-status">
          <text class="status-text status-{{item.status}}">
            {{formatStatus(item.status)}}
          </text>
        </view>
      </view>

      <!-- 餐次信息 -->
      <view class="meal-info">
        <view class="meal-basic">
          <text class="meal-date">📅 {{item.meal_date}}</text>
          <text class="meal-slot">{{item.meal_slot === 'lunch' ? '🍱 午餐' : '🍽️ 晚餐'}}</text>
        </view>
        <view wx:if="{{item.meal_description}}" class="meal-description">
          <text class="description-text">{{item.meal_description}}</text>
        </view>
      </view>

      <!-- 用户信息（仅管理员可见） -->
      <view wx:if="{{isAdmin && item.user_name}}" class="user-info">
        <text class="user-label">下单用户：</text>
        <text class="user-name">{{item.user_name}}</text>
      </view>

      <!-- 附加项信息 -->
      <view wx:if="{{item.addon_details && item.addon_details.length > 0}}" class="addon-info">
        <text class="addon-title">附加项：</text>
        <view class="addon-list">
          <view 
            wx:for="{{item.addon_details}}" 
            wx:key="addon_id"
            wx:for-item="addon"
            class="addon-item"
          >
            <text class="addon-name">{{addon.name}}</text>
            <text class="addon-quantity">×{{addon.quantity}}</text>
          </view>
        </view>
      </view>

      <!-- 价格信息 -->
      <view class="price-info">
        <view class="price-breakdown">
          <text class="base-price">基础：¥{{item.base_price_yuan}}</text>
          <text wx:if="{{item.addon_price_yuan !== 0}}" class="addon-price">
            附加项：{{item.addon_price_yuan >= 0 ? '+' : ''}}¥{{item.addon_price_yuan}}
          </text>
        </view>
        <text class="total-price">总计：¥{{item.total_price_yuan}}</text>
      </view>

      <!-- 订单操作按钮 -->
      <view class="order-actions">
        <!-- 用户操作 -->
        <view wx:if="{{!isAdmin && item.status === 'placed'}}" class="user-actions">
          <button 
            class="action-btn cancel" 
            data-order-id="{{item.order_id}}"
            data-action="cancel"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            取消订单
          </button>
        </view>

        <!-- 管理员操作 -->
        <view wx:if="{{isAdmin}}" class="admin-actions">
          <button 
            wx:if="{{item.status === 'placed'}}"
            class="action-btn confirm" 
            data-order-id="{{item.order_id}}"
            data-action="confirm"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            确认
          </button>
          <button 
            wx:if="{{item.status === 'confirmed'}}"
            class="action-btn complete" 
            data-order-id="{{item.order_id}}"
            data-action="complete"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            完成
          </button>
          <button 
            wx:if="{{['placed', 'confirmed'].includes(item.status)}}"
            class="action-btn cancel" 
            data-order-id="{{item.order_id}}"
            data-action="cancel"
            bind:tap="onOrderAction"
            catchtap="true"
          >
            取消
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{!loading}}" class="empty-container">
    <view class="empty-content">
      <text class="empty-icon">📋</text>
      <text class="empty-text">暂无订单</text>
      <text class="empty-tip">{{isAdmin ? '等待用户下单' : '快去下单吧'}}</text>
    </view>
  </view>

  <!-- 加载更多 -->
  <view wx:if="{{loadingMore}}" class="loading-more">
    <text class="loading-more-text">加载更多...</text>
  </view>

  <!-- 没有更多 -->
  <view wx:elif="{{orders.length > 0 && !pagination.has_more}}" class="no-more">
    <text class="no-more-text">没有更多订单了</text>
  </view>
</view>