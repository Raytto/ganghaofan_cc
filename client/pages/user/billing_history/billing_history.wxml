<!--ç”¨æˆ·è´¦å•å†å²é¡µé¢-->
<!--å‚è€ƒæ–‡æ¡£: doc/client/page_billing_history.md-->

<view class="container">
  <!-- è´¦æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="balance-card">
    <view class="balance-header">
      <text class="balance-title">ğŸ’° è´¦æˆ·ä½™é¢</text>
      <button class="recharge-btn" bind:tap="onShowRecharge">
        + å……å€¼
      </button>
    </view>
    <view class="balance-amount">
      <text class="amount-symbol">Â¥</text>
      <text class="amount-value">{{balance}}</text>
    </view>
    <view wx:if="{{userInfo}}" class="user-info">
      <text class="user-name">{{userInfo.name}}</text>
      <text class="user-id">ID: {{userInfo.user_id}}</text>
    </view>
  </view>

  <!-- åŠŸèƒ½æŒ‰é’®æ  -->
  <view class="function-bar">
    <view class="function-toggle" bind:tap="onToggleFilters">
      <text class="function-text">ğŸ” ç­›é€‰</text>
      <text class="function-icon {{showFilters ? 'active' : ''}}">â–¼</text>
    </view>
    <view class="function-actions">
      <button class="export-btn" bind:tap="onExportTransactions">
        ğŸ“Š å¯¼å‡º
      </button>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilters}}" class="filter-panel">
    <view class="filter-section">
      <view class="filter-item">
        <text class="filter-label">äº¤æ˜“ç±»å‹ï¼š</text>
        <picker
          range="{{transactionTypes}}"
          range-key="label"
          value="{{transactionTypeIndex}}"
          bind:change="onFilterChange"
          data-field="transaction_type"
        >
          <view class="picker-value">
            {{transactionTypes[transactionTypeIndex].label}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">å¼€å§‹æ—¥æœŸï¼š</text>
        <picker
          mode="date"
          value="{{filters.date_from}}"
          bind:change="onFilterChange"
          data-field="date_from"
        >
          <view class="picker-value">
            {{filters.date_from || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
      
      <view class="filter-item">
        <text class="filter-label">ç»“æŸæ—¥æœŸï¼š</text>
        <picker
          mode="date"
          value="{{filters.date_to}}"
          bind:change="onFilterChange"
          data-field="date_to"
        >
          <view class="picker-value">
            {{filters.date_to || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-actions">
      <button class="filter-btn reset" bind:tap="onResetFilters">é‡ç½®</button>
      <button class="filter-btn apply" bind:tap="onApplyFilters">åº”ç”¨</button>
    </view>
  </view>

  <!-- äº¤æ˜“è®°å½•åˆ—è¡¨ -->
  <view class="transactions-section">
    <view class="section-title">
      <text class="title-text">ğŸ“‹ äº¤æ˜“è®°å½•</text>
      <text wx:if="{{pagination.total > 0}}" class="title-count">å…±{{pagination.total}}ç¬”</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading && transactions.length === 0}}" class="loading-container">
      <view class="loading-content">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- äº¤æ˜“è®°å½•åˆ—è¡¨ -->
    <view wx:elif="{{transactions.length > 0}}" class="transaction-list">
      <view 
        wx:for="{{transactions}}" 
        wx:key="transaction_id" 
        class="transaction-item"
        bind:tap="onTransactionTap"
        data-transaction-id="{{item.transaction_id}}"
      >
        <!-- äº¤æ˜“åŸºæœ¬ä¿¡æ¯ -->
        <view class="transaction-header">
          <view class="transaction-info">
            <text class="transaction-type">{{formatTransactionType(item.transaction_type)}}</text>
            <text class="transaction-time">{{formatDateTime(item.created_at)}}</text>
          </view>
          <view class="transaction-amount {{formatTransactionAmount(item.amount_yuan, item.transaction_type).color}}">
            <text class="amount-text">{{formatTransactionAmount(item.amount_yuan, item.transaction_type).text}}</text>
          </view>
        </view>

        <!-- äº¤æ˜“è¯¦æƒ… -->
        <view wx:if="{{item.description}}" class="transaction-description">
          <text class="description-text">{{item.description}}</text>
        </view>

        <!-- è®¢å•ç›¸å…³ä¿¡æ¯ -->
        <view wx:if="{{item.related_order_id}}" class="related-info">
          <text class="related-label">ç›¸å…³è®¢å•ï¼š</text>
          <text class="related-value">#{{item.related_order_id}}</text>
        </view>

        <!-- äº¤æ˜“ç¼–å·å’Œä½™é¢ -->
        <view class="transaction-footer">
          <text class="transaction-number">{{item.transaction_number}}</text>
          <text class="balance-after">ä½™é¢ï¼šÂ¥{{item.balance_after_yuan}}</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{!loading}}" class="empty-container">
      <view class="empty-content">
        <text class="empty-icon">ğŸ’³</text>
        <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
        <text class="empty-tip">å¿«å»ä¸‹å•æˆ–å……å€¼å§</text>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loadingMore}}" class="loading-more">
      <text class="loading-more-text">åŠ è½½æ›´å¤š...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:elif="{{transactions.length > 0 && !pagination.has_more}}" class="no-more">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
    </view>
  </view>

  <!-- å……å€¼å¼¹çª— -->
  <view wx:if="{{showRecharge}}" class="recharge-modal">
    <view class="modal-mask" bind:tap="onHideRecharge"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ğŸ’° è´¦æˆ·å……å€¼</text>
        <text class="modal-close" bind:tap="onHideRecharge">âœ•</text>
      </view>
      
      <view class="modal-body">
        <!-- å½“å‰ä½™é¢ -->
        <view class="current-balance">
          <text class="balance-label">å½“å‰ä½™é¢ï¼š</text>
          <text class="balance-value">Â¥{{balance}}</text>
        </view>
        
        <!-- å……å€¼é‡‘é¢è¾“å…¥ -->
        <view class="amount-input-section">
          <text class="input-label">å……å€¼é‡‘é¢ï¼ˆå…ƒï¼‰</text>
          <input
            class="amount-input"
            type="digit"
            placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢"
            value="{{rechargeAmount}}"
            bind:input="onRechargeAmountInput"
            maxlength="6"
          />
        </view>
        
        <!-- å¿«æ·é‡‘é¢é€‰æ‹© -->
        <view class="quick-amounts">
          <text class="quick-label">å¿«æ·é€‰æ‹©ï¼š</text>
          <view class="quick-buttons">
            <button
              wx:for="{{quickRechargeAmounts}}"
              wx:key="*this"
              class="quick-btn {{rechargeAmount === item ? 'active' : ''}}"
              data-amount="{{item}}"
              bind:tap="onQuickAmountSelect"
            >
              Â¥{{item}}
            </button>
          </view>
        </view>
        
        <!-- å……å€¼è¯´æ˜ -->
        <view class="recharge-notice">
          <text class="notice-text">â€¢ å•æ¬¡å……å€¼é™é¢ï¼š1000å…ƒ</text>
          <text class="notice-text">â€¢ å……å€¼åç«‹å³åˆ°è´¦</text>
          <text class="notice-text">â€¢ å¦‚æœ‰ç–‘é—®è¯·è”ç³»ç®¡ç†å‘˜</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bind:tap="onHideRecharge">å–æ¶ˆ</button>
        <button 
          class="modal-btn confirm" 
          loading="{{submittingRecharge}}"
          disabled="{{submittingRecharge || !rechargeAmount || rechargeAmount <= 0}}"
          bind:tap="onSubmitRecharge"
        >
          ç¡®è®¤å……å€¼
        </button>
      </view>
    </view>
  </view>
</view>