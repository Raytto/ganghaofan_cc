<!--ç”¨æˆ·ä¸‹å•é¡µé¢-->
<!--å‚è€ƒæ–‡æ¡£: doc/client/page_meal_order.md-->

<!-- åŠ è½½çŠ¶æ€ -->
<view wx:if="{{loading}}" class="loading-container">
  <view class="loading-content">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>

<view wx:else class="container">
  <!-- é¡µé¢å¤´éƒ¨ä¿¡æ¯ -->
  <view class="header-section">
    <view class="date-info">
      <text class="date-text">ğŸ“… {{date}}</text>
      <text class="slot-text">{{slot === 'lunch' ? 'åˆé¤' : 'æ™šé¤'}}</text>
    </view>
    <view class="balance-info">
      <text class="balance-label">è´¦æˆ·ä½™é¢ï¼š</text>
      <text class="balance-amount {{priceCalculation.is_affordable ? '' : 'insufficient'}}">Â¥{{balance}}</text>
      <button wx:if="{{!priceCalculation.is_affordable}}" class="recharge-btn" bind:tap="onGoToRecharge">
        ğŸ’° å……å€¼
      </button>
    </view>
  </view>

  <!-- é¤æ¬¡ä¿¡æ¯åŒºåŸŸ -->
  <view wx:if="{{meal}}" class="meal-info-section">
    <view class="section-title">ğŸ½ï¸ é¤æ¬¡ä¿¡æ¯</view>
    <view class="meal-info">
      <view class="meal-description">
        <text class="description-text">{{meal.description}}</text>
      </view>
      <view class="meal-details">
        <view class="detail-item">
          <text class="detail-label">åŸºç¡€ä»·æ ¼ï¼š</text>
          <text class="detail-value">Â¥{{meal.base_price_yuan}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">å‰©ä½™ä»½æ•°ï¼š</text>
          <text class="detail-value">{{meal.max_orders - meal.current_orders}}/{{meal.max_orders}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å·²æœ‰è®¢å•ä¿¡æ¯ -->
  <view wx:if="{{existingOrder && pageMode === 'view'}}" class="existing-order-section">
    <view class="section-title">ğŸ“‹ æˆ‘çš„è®¢å•</view>
    <view class="order-info">
      <view class="order-status">
        <text class="status-label">çŠ¶æ€ï¼š</text>
        <text class="status-value status-{{existingOrder.status}}">
          {{existingOrder.status === 'placed' ? 'å·²ä¸‹å• ğŸŸ¡' : existingOrder.status === 'confirmed' ? 'å·²ç¡®è®¤ ğŸŸ¢' : existingOrder.status === 'completed' ? 'å·²å®Œæˆ âœ…' : existingOrder.status === 'canceled' ? 'å·²å–æ¶ˆ âŒ' : 'æœªçŸ¥çŠ¶æ€'}}
        </text>
      </view>
      <view class="order-detail">
        <text class="order-label">æ€»ä»·æ ¼ï¼š</text>
        <text class="order-value">Â¥{{existingOrder.total_price_yuan}}</text>
      </view>
      <view wx:if="{{existingOrder.addon_selections && Object.keys(existingOrder.addon_selections).length > 0}}" class="order-addons">
        <text class="addons-title">é™„åŠ é¡¹ï¼š</text>
        <view class="addon-list">
          <view 
            wx:for="{{addons}}" 
            wx:key="addon_id"
            wx:if="{{existingOrder.addon_selections[item.addon_id] > 0}}"
            class="addon-item"
          >
            <text class="addon-name">{{item.name}}</text>
            <text class="addon-quantity">Ã—{{existingOrder.addon_selections[item.addon_id]}}</text>
          </view>
        </view>
      </view>
      <button class="view-details-btn" bind:tap="onViewOrderDetails">
        ğŸ“Š æŸ¥çœ‹è¯¦æƒ… â†’
      </button>
    </view>
  </view>

  <!-- é™„åŠ é¡¹é€‰æ‹©åŒºåŸŸ -->
  <view wx:if="{{addons.length > 0 && (pageMode === 'order' || pageMode === 'modify')}}" class="addons-section">
    <view class="section-title">ğŸ– é™„åŠ é¡¹é€‰æ‹©</view>
    <view class="addons-list">
      <view 
        wx:for="{{addons}}" 
        wx:key="addon_id"
        class="addon-item"
      >
        <view class="addon-info">
          <view class="addon-header">
            <text class="addon-name">{{item.name}}</text>
            <text class="addon-price">Â¥{{item.price_yuan}}</text>
          </view>
          <view wx:if="{{item.description}}" class="addon-description">
            <text class="description-text">{{item.description}}</text>
          </view>
        </view>
        <view class="addon-controls">
          <text class="max-hint">æœ€å¤š{{item.max_quantity}}ä»½</text>
          <view class="quantity-controls">
            <button 
              class="quantity-btn"
              data-addon-id="{{item.addon_id}}"
              data-type="decrease"
              bind:tap="onAddonQuantityChange"
              disabled="{{(orderForm.addon_selections[item.addon_id] || 0) <= 0}}"
            >
              -
            </button>
            <text class="quantity-value">{{orderForm.addon_selections[item.addon_id] || 0}}</text>
            <button 
              class="quantity-btn"
              data-addon-id="{{item.addon_id}}"
              data-type="increase"
              bind:tap="onAddonQuantityChange"
              disabled="{{(orderForm.addon_selections[item.addon_id] || 0) >= item.max_quantity}}"
            >
              +
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»·æ ¼è®¡ç®—åŒºåŸŸ -->
  <view wx:if="{{pageMode === 'order' || pageMode === 'modify'}}" class="price-section">
    <view class="section-title">ğŸ’° ä»·æ ¼æ˜ç»†</view>
    <view class="price-details">
      <view class="price-item">
        <text class="price-label">åŸºç¡€ä»·æ ¼ï¼š</text>
        <text class="price-value">Â¥{{priceCalculation.base_price_yuan}}</text>
      </view>
      <view wx:if="{{priceCalculation.addon_price_yuan !== 0}}" class="price-item">
        <text class="price-label">é™„åŠ é¡¹ï¼š</text>
        <text class="price-value {{priceCalculation.addon_price_yuan < 0 ? 'discount' : ''}}">
          {{priceCalculation.addon_price_yuan >= 0 ? '+' : ''}}Â¥{{priceCalculation.addon_price_yuan}}
        </text>
      </view>
      <view class="price-divider"></view>
      <view class="price-total">
        <text class="total-label">æ€»ä»·æ ¼ï¼š</text>
        <text class="total-value">Â¥{{priceCalculation.total_price_yuan}}</text>
      </view>
      <view wx:if="{{!priceCalculation.is_affordable}}" class="insufficient-notice">
        <text class="notice-text">âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="actions-section">
    <!-- ä¸‹å•æ¨¡å¼ -->
    <button
      wx:if="{{pageMode === 'order'}}"
      class="action-btn primary"
      loading="{{submitting}}"
      disabled="{{submitting || !priceCalculation.is_affordable}}"
      bind:tap="onPlaceOrder"
    >
      ğŸ›’ ç«‹å³ä¸‹å•
    </button>

    <!-- æŸ¥çœ‹è®¢å•æ¨¡å¼ -->
    <view wx:elif="{{pageMode === 'view' && existingOrder.status === 'placed'}}" class="view-actions">
      <button
        class="action-btn secondary"
        bind:tap="onStartModifyOrder"
      >
        âœï¸ ä¿®æ”¹è®¢å•
      </button>
      <button
        class="action-btn danger"
        loading="{{submitting}}"
        disabled="{{submitting}}"
        bind:tap="onCancelOrder"
      >
        âŒ å–æ¶ˆè®¢å•
      </button>
    </view>

    <!-- å·²ç¡®è®¤è®¢å• -->
    <view wx:elif="{{pageMode === 'view' && existingOrder.status === 'confirmed'}}" class="confirmed-notice">
      <text class="notice-text">è®¢å•å·²ç¡®è®¤ï¼Œæ— æ³•ä¿®æ”¹æˆ–å–æ¶ˆ âœ…</text>
    </view>

    <!-- ä¿®æ”¹è®¢å•æ¨¡å¼ -->
    <view wx:elif="{{pageMode === 'modify'}}" class="modify-actions">
      <button
        class="action-btn secondary"
        bind:tap="onCancelModify"
      >
        å–æ¶ˆ
      </button>
      <button
        class="action-btn primary"
        loading="{{submitting}}"
        disabled="{{submitting || !priceCalculation.is_affordable}}"
        bind:tap="onModifyOrder"
      >
        ä¿å­˜ä¿®æ”¹
      </button>
    </view>
  </view>
</view>