# 用户订餐页面 (meal_order.js)

## 页面概述

用户订餐页面展示管理员发布的餐次信息，用户可以查看餐次详情、选择附加项并下单，或修改已有订单。页面根据餐次状态、订单情况和余额状态动态显示不同的操作界面，确保用户在合适的时机进行相应操作。

## 页面路径
- 文件位置：`client/pages/user/meal_order/meal_order.js`
- 页面路径：`pages/user/meal_order/meal_order`
- 权限要求：已注册用户
- 入口：日历页面点击已发布的餐次进入

## 页面功能

### 主要职责
1. **餐次信息展示**：显示餐次详情和可选附加项
2. **订单状态判断**：判断用户是否已订餐及可操作状态
3. **下单功能**：选择附加项并创建订单
4. **修改订单**：修改已有订单的附加项选择
5. **余额检查**：确保用户余额充足
6. **容量检查**：检查餐次剩余容量

## 页面数据结构

### data 字段
```javascript
{
  meal: Object,            // 餐次详细信息
  userOrder: Object,       // 用户当前订单（如果已订餐）
  availableAddons: Array,  // 可选附加项列表
  userInfo: Object,        // 用户信息（包含余额）
  loading: Boolean,        // 页面加载状态
  submitting: Boolean,     // 提交状态
  orderForm: {            // 订单表单
    addon_selections: Object, // 附加项选择 {addon_id: quantity}
    total_amount_yuan: Number // 计算出的总价格（元）
  },
  pageMode: String,       // 页面模式：view/order/edit/readonly
  canOrder: Boolean,      // 是否可以下单
  hasCapacity: Boolean,   // 是否还有容量
  hasBalance: Boolean     // 余额是否充足
}
```

### meal 对象结构
```javascript
{
  meal_id: Number,        // 餐次ID
  date: String,          // 日期 YYYY-MM-DD
  slot: String,          // 时段 lunch/dinner
  description: String,    // 餐次描述
  base_price_cents: Number, // 基础价格（分）
  base_price_yuan: Number,  // 基础价格（元）
  addon_config: Object,   // 附加项配置 {addon_id: max_quantity}
  max_orders: Number,     // 最大订餐数量
  current_orders: Number, // 当前订单数
  status: String,        // 状态：published/locked/completed/canceled
  updated_at: String     // 更新时间
}
```

### userOrder 对象结构
```javascript
{
  order_id: Number,       // 订单ID
  amount_cents: Number,   // 订单金额（分）
  amount_yuan: Number,    // 订单金额（元）
  addon_selections: Object, // 附加项选择
  status: String,        // 订单状态
  created_at: String     // 下单时间
}
```

### availableAddons 数组结构
```javascript
[
  {
    addon_id: Number,       // 附加项ID
    name: String,          // 附加项名称
    price_cents: Number,   // 价格（分）
    price_yuan: Number,    // 价格（元）
    max_quantity: Number,  // 该餐次允许的最大数量
    selected_quantity: Number // 当前选择的数量
  }
]
```

## 核心功能模块

### 1. 页面状态判断
根据餐次状态和用户订单情况确定页面模式：
- **view模式**：仅查看餐次信息（餐次已锁定/完成，或容量已满）
- **order模式**：可以下单（餐次已发布，用户未订餐，有容量，余额充足）
- **edit模式**：可以修改订单（用户已订餐，餐次未锁定）
- **readonly模式**：只读查看（用户已订餐，餐次已锁定/完成）

### 2. 餐次信息展示
- **基本信息**：日期时段、描述、基础价格
- **容量信息**：当前订单数/最大订单数
- **状态指示**：用颜色和图标显示餐次状态
- **剩余容量**：计算和显示剩余可订名额

### 3. 附加项选择功能
- **附加项列表**：展示所有可选附加项及价格
- **数量选择**：+/-按钮调节选择数量
- **限制提示**：显示每个附加项的最大可选数量
- **实时计算**：动态计算总价格
- **选择记忆**：修改订单时预填充已选择的附加项

### 4. 下单功能
- **余额验证**：检查用户余额是否充足
- **容量验证**：检查餐次是否还有容量
- **表单提交**：提交订单数据到后端
- **成功反馈**：下单成功后更新页面状态

### 5. 修改订单功能
- **预填充表单**：加载现有订单的附加项选择
- **差价计算**：显示修改后的价格差异
- **更新提交**：提交修改后的订单数据
- **余额检查**：如果增加金额需验证余额充足

### 6. 订单详情展示
- **已订信息**：显示用户当前的订单详情
- **附加项明细**：列出选择的附加项和数量
- **价格明细**：显示基础价格和附加项价格分解
- **下单时间**：显示订单创建时间

## API 调用

参考 `doc/api.md` 中的餐次和订单接口：

### 1. 获取餐次信息
- **接口**：`GET /meals/{date}/{slot}`
- **权限**：用户
- **返回**：餐次详细信息

### 2. 获取用户订单
- **接口**：`GET /orders/my?meal_id={meal_id}`
- **权限**：用户
- **返回**：用户在该餐次的订单信息

### 3. 获取可用附加项
- **接口**：`GET /addons?status=active`
- **权限**：用户
- **返回**：活跃附加项列表

### 4. 获取用户信息
- **接口**：`GET /users/me`
- **权限**：用户
- **返回**：用户信息（包含余额）

### 5. 创建订单
- **接口**：`POST /orders`
- **权限**：用户
- **参数**：
  ```javascript
  {
    meal_id: Number,           // 餐次ID
    addon_selections: Object   // 附加项选择 {addon_id: quantity}
  }
  ```

### 6. 修改订单
- **接口**：`PUT /orders/{order_id}`
- **权限**：用户（订单所有者）
- **参数**：同创建订单

### 7. 取消订单
- **接口**：`DELETE /orders/{order_id}`
- **权限**：用户（订单所有者）

## 页面布局结构

### 1. 页面头部
- **标题**：订餐 / 查看订单（根据状态）
- **返回按钮**：左上角返回日历页面
- **日期时段**：显示餐次的日期和时段

### 2. 餐次信息区域
```
┌─────────────────────────────────────┐
│  📅 2024-11-27 午餐                  │
│  状态：已发布 🟢                     │
├─────────────────────────────────────┤
│  📝 餐次描述：                       │
│      红烧肉套餐，配白米饭和汤         │
│                                     │
│  💰 基础价格：¥18.00                 │
│  👥 订餐情况：25/50 人 (剩余25名额)   │
│  📊 [查看下单详情] →                 │
└─────────────────────────────────────┘
```

### 3. 用户状态提示区域
```
未订餐状态：
┌─────────────────────────────────────┐
│  💰 您的余额：¥88.50                 │
│  ✅ 余额充足，可以订餐               │
└─────────────────────────────────────┘

已订餐状态：
┌─────────────────────────────────────┐
│  📋 您的订单 #20241127001            │
│  💰 订单金额：¥21.00                 │
│  🕒 下单时间：11-26 14:30            │
└─────────────────────────────────────┘

余额不足状态：
┌─────────────────────────────────────┐
│  💰 您的余额：¥12.00                 │
│  ⚠️ 余额不足，请先充值               │
│      [💰 去充值] →                   │
└─────────────────────────────────────┘
```

### 4. 附加项选择区域
```
下单模式：
┌─────────────────────────────────────┐
│  🍖 选择附加项                       │
├─────────────────────────────────────┤
│  加鸡腿 ¥3.00   [-] 2 [+]  (最多3份) │
│  加饮料 ¥2.00   [-] 1 [+]  (最多1份) │
│  加米饭 ¥1.00   [-] 0 [+]  (最多2份) │
│                                     │
│  预计总价：¥18.00 + ¥8.00 = ¥26.00  │
└─────────────────────────────────────┘

查看模式（已订餐）：
┌─────────────────────────────────────┐
│  🍖 您的选择                         │
├─────────────────────────────────────┤
│  ✅ 加鸡腿 ¥3.00 × 2 = ¥6.00        │
│  ✅ 加饮料 ¥2.00 × 1 = ¥2.00        │
│                                     │
│  基础价格：¥18.00                   │
│  附加项：  ¥8.00                    │
│  总计：    ¥26.00                   │
└─────────────────────────────────────┘
```

### 5. 操作按钮区域
```
可下单状态：
┌─────────────────────────────────────┐
│           [🍽️ 确认下单]              │
└─────────────────────────────────────┘

可修改状态：
┌─────────────────────────────────────┐
│     [✏️ 修改订单]  [❌ 取消订单]     │
└─────────────────────────────────────┘

只读状态：
┌─────────────────────────────────────┐
│         餐次已锁定，无法修改         │
└─────────────────────────────────────┘

余额不足状态：
┌─────────────────────────────────────┐
│      [💰 去充值]  [👀 仅查看]        │
└─────────────────────────────────────┘

容量已满状态：
┌─────────────────────────────────────┐
│           订餐名额已满 😔            │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  获取餐次信息 → 
    获取用户信息 → 
      检查用户订单 → 
        加载附加项列表 → 
          判断页面模式 → 
            渲染页面内容
```

### 2. 下单流程
```
选择附加项 → 
  实时计算价格 → 
    余额验证 → 
      容量验证 → 
        确认下单 → 
          调用下单接口 → 
            更新页面状态 → 
              显示成功提示
```

### 3. 修改订单流程
```
点击修改订单 → 
  进入编辑模式 → 
    预填充现有选择 → 
      修改附加项 → 
        计算价格差异 → 
          余额验证 → 
            提交修改 → 
              更新页面显示
```

### 4. 附加项选择流程
```
点击+/-按钮 → 
  验证数量限制 → 
    更新选择数量 → 
      实时计算总价 → 
        更新页面显示
```

## 权限控制

### 1. 页面访问控制
```javascript
onLoad() {
  if (!this.checkUserLogin()) {
    wx.showToast({ title: '请先登录', icon: 'none' })
    wx.redirectTo({ url: '/pages/login/login' })
    return
  }
  this.loadPageData()
}
```

### 2. 操作权限控制
- **下单权限**：餐次已发布 + 用户未订餐 + 有容量 + 余额充足
- **修改权限**：用户已订餐 + 餐次未锁定
- **取消权限**：用户已订餐 + 餐次未锁定

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮
- **提交失败**：显示具体错误信息
- **超时处理**：自动重试或手动刷新

### 2. 业务错误处理
- **余额不足**：显示"余额不足，请先充值"，提供充值入口
- **容量已满**：显示"订餐名额已满"
- **状态冲突**：显示"餐次状态已变更"，自动刷新页面
- **重复下单**：显示"您已订过此餐次"
- **订单不存在**：显示"订单不存在或已取消"

### 3. 数据验证错误
- **价格异常**：显示"价格计算错误，请刷新重试"
- **附加项超限**：显示"附加项选择超出限制"
- **餐次过期**：显示"该餐次已过期"

## 用户体验优化

### 1. 加载状态管理
- **骨架屏**：页面首次加载显示骨架屏
- **局部loading**：按钮操作时显示loading状态
- **数据缓存**：缓存餐次和附加项数据

### 2. 交互反馈优化
- **实时计算**：附加项选择后立即计算总价
- **操作禁用**：余额不足或容量已满时禁用下单按钮
- **状态指示**：用颜色和图标明确表示各种状态
- **成功动画**：下单成功后显示动画反馈

### 3. 表单交互优化
- **数量控制**：+/-按钮支持快速调节
- **限制提示**：达到最大数量时禁用+按钮
- **价格预览**：选择变更时立即显示价格变化
- **确认提示**：取消订单时显示确认弹窗

### 4. 提示信息优化
- **状态说明**：清晰解释当前页面状态
- **操作指导**：引导用户完成相关操作
- **错误提示**：友好的错误信息和解决建议

## 数据流管理

### 1. 页面模式判断
```javascript
determinePageMode() {
  const { meal, userOrder, userInfo, hasCapacity } = this.data
  
  let mode = 'view'
  let canOrder = false
  
  if (meal.status === 'published') {
    if (!userOrder && hasCapacity && this.checkBalance()) {
      mode = 'order'
      canOrder = true
    } else if (userOrder) {
      mode = 'edit'
    }
  } else if (userOrder) {
    mode = 'readonly'
  }
  
  this.setData({ pageMode: mode, canOrder })
}
```

### 2. 价格计算逻辑
```javascript
calculateTotalPrice() {
  const { meal, orderForm } = this.data
  let totalCents = meal.base_price_cents
  
  Object.entries(orderForm.addon_selections).forEach(([addonId, quantity]) => {
    const addon = this.data.availableAddons.find(a => a.addon_id == addonId)
    if (addon) {
      totalCents += addon.price_cents * quantity
    }
  })
  
  this.setData({
    'orderForm.total_amount_yuan': totalCents / 100
  })
}
```

### 3. 表单状态同步
```javascript
// 修改订单时预填充表单
loadOrderToForm() {
  if (this.data.userOrder) {
    this.setData({
      'orderForm.addon_selections': this.data.userOrder.addon_selections || {}
    })
    this.calculateTotalPrice()
  }
}
```

## 扩展功能预留

### 1. 个性化功能
- **订餐偏好**：记住用户常选的附加项
- **快捷下单**：基于历史选择提供快捷选项
- **收藏功能**：收藏喜欢的餐次配置

### 2. 社交功能
- **餐友提醒**：提醒好友一起订餐
- **拼餐功能**：多人共享一个订单

### 3. 增强体验
- **图片展示**：显示菜品图片
- **营养信息**：显示热量和营养成分
- **评价查看**：查看其他用户的评价

## 安全考虑

### 1. 数据安全
- **价格验证**：前后端双重价格验证
- **权限检查**：确保用户只能操作自己的订单
- **状态一致性**：操作前验证餐次和订单状态

### 2. 业务安全
- **重复提交**：防止用户重复点击下单
- **并发控制**：处理多用户同时下单的情况
- **数据同步**：确保显示的容量信息准确

### 3. 用户体验安全
- **敏感操作**：取消订单需要二次确认
- **数据保护**：不显示其他用户的订单信息
- **错误处理**：友好处理各种异常情况

这个页面设计充分考虑了用户订餐的各种场景，通过动态的页面模式和清晰的状态指示，让用户能够方便地进行订餐操作，同时确保了数据的准确性和操作的安全性。