# 健康日历页面 (calendar.js)

## 页面概述

健康日历页面是用户查看餐次信息的核心页面，以三周日历视图的形式展示餐次的预订状态、价格和时间安排。用户可以直观地查看上周、本周、下周的所有餐次信息。

## 页面路径
- 文件位置：`client/pages/calendar/calendar.js`
- 页面路径：`pages/calendar/calendar`
- Tab页面：是（底部导航栏第一个）

## 页面功能

### 主要职责
1. **日历展示**：以三周视图显示日期和餐次信息
2. **餐次状态**：显示每日午餐和晚餐的预订状态和价格
3. **实时更新**：页面显示时自动刷新最新数据
4. **状态区分**：通过颜色和文字区分不同的餐次状态

### 核心功能模块

#### 1. 日历结构生成
- **三周范围**：上周、本周、下周（共21天）
- **周结构**：每周从周日开始到周六结束
- **今日标识**：高亮显示当前日期

#### 2. 餐次信息展示
- **午餐信息**：价格、预订状态
- **晚餐信息**：价格、预订状态
- **状态类型**：可预订、已预订、已截止、未发布

#### 3. 数据加载机制
- **登录检查**：验证用户登录状态
- **API调用**：获取指定日期范围的餐次数据
- **数据同步**：将后端数据映射到前端日历结构

## 页面数据结构

### data 字段
```javascript
{
  currentMonth: String,     // 当前月份显示文本 (如: "2024年8月")
  weeks: Array,            // 三周的数据结构
  today: Date              // 今天的日期对象
}
```

### weeks 数组结构
```javascript
[
  {
    weekIndex: Number,       // 周索引 (0=上周, 1=本周, 2=下周)
    days: [
      {
        dayIndex: Number,        // 日索引 (0-6, 0=周日)
        date: Number,           // 日期数字 (1-31)
        fullDate: Date,         // 完整日期对象
        isToday: Boolean,       // 是否为今天
        isCurrentMonth: Boolean, // 是否为当前月份
        lunch: {                // 午餐信息
          status: String,       // 状态: available/ordered/locked/unpublished
          price: Number         // 价格（元）
        },
        dinner: {               // 晚餐信息
          status: String,
          price: Number
        }
      }
      // ... 7天
    ]
  }
  // ... 3周
]
```

## 餐次状态系统

### 状态类型
1. **available** - 可预订
   - 颜色：橙色背景 (#fff2e8)
   - 显示：价格 (如: ¥15)

2. **ordered** - 已预订
   - 颜色：绿色背景 (#1aad19)
   - 显示：文字 "已订"

3. **locked** - 已截止
   - 颜色：灰色背景 (#666)
   - 显示：文字 "已锁"

4. **unpublished** - 未发布
   - 颜色：浅灰背景 (#f0f0f0)
   - 显示：文字 "未发布"

### 状态映射逻辑
```javascript
// 后端数据 -> 前端状态
if (meal.user_order_status === 'ordered') {
  return 'ordered'
} else if (meal.meal_status === 'locked' || meal.meal_status === 'completed') {
  return 'locked'
} else if (meal.meal_status === 'published') {
  return 'available'
} else {
  return 'unpublished'
}
```

## API 调用

### 获取日历餐次数据
- **接口**：`GET /meals/calendar`
- **参数**：
  ```javascript
  {
    start_date: "YYYY-MM-DD",  // 开始日期
    end_date: "YYYY-MM-DD"     // 结束日期
  }
  ```
- **返回**：餐次列表包含状态和价格信息

## 页面布局结构

### 1. 日历头部
- **月份显示**：当前月份和年份
- **星期标题**：周日到周六的列标题

### 2. 三周日历网格
- **7列布局**：对应一周七天
- **3行布局**：对应三周
- **日期格子**：包含日期数字和两个餐次信息

### 3. 底部图例
- **状态说明**：用颜色块和文字说明各种状态的含义
- **用户指导**：帮助用户理解不同颜色的含义

## 交互功能

### 1. 页面加载 (onLoad)
```
页面加载 → 初始化日历结构 → 加载餐次数据 → 渲染页面
```

### 2. 页面显示 (onShow)
```
页面显示 → 刷新餐次数据 → 更新页面状态
```

### 3. 日期点击 (onDayTap) [预留]
- **功能**：点击日期格子跳转到详情页
- **条件**：只响应当前月份的日期点击
- **扩展**：可跳转到具体日期的订餐页面

## 错误处理

### 1. 登录状态检查
```javascript
const token = wx.getStorageSync('access_token')
if (!token) {
  wx.reLaunch({ url: '../welcome/welcome' })
  return
}
```

### 2. API请求失败
- **网络错误**：显示"网络错误"提示
- **认证错误**：清除本地数据并跳转到欢迎页面
- **数据错误**：显示"获取数据失败"提示

### 3. 数据异常处理
- **空数据**：显示默认的未发布状态
- **日期格式错误**：使用fallback日期处理
- **状态异常**：默认显示为未发布状态

## 性能优化

### 1. 数据结构优化
- **预生成日历结构**：页面加载时一次性生成21天结构
- **增量更新**：只更新餐次数据，不重新生成日历结构
- **日期计算缓存**：避免重复的日期计算操作

### 2. 渲染优化
- **条件渲染**：使用wx:if减少不必要的DOM节点
- **列表优化**：使用wx:key提升列表渲染性能
- **样式复用**：通过class组合减少样式计算

### 3. 数据加载优化
- **懒加载**：仅加载可见范围的数据
- **缓存机制**：适当缓存餐次数据减少请求频率
- **分页加载**：大数据量时分页处理

## 样式设计特点

### 1. 卡片式布局
- **圆角设计**：12rpx圆角营造现代感
- **阴影效果**：轻微阴影增加层次感
- **间距统一**：20rpx的标准间距保持整齐

### 2. 色彩系统
- **主题色**：绿色 (#1aad19) 表示成功状态
- **警告色**：橙色 (#fff2e8) 表示可操作状态
- **中性色**：灰色系表示不可操作状态
- **背景色**：浅灰 (#f5f5f5) 提供良好对比度

### 3. 响应式设计
- **弹性布局**：使用flex布局适配不同屏幕
- **相对单位**：使用rpx确保不同设备一致性
- **最小高度**：确保内容在小屏幕上也能正常显示

## 扩展功能预留

### 1. 日期跳转
- **详情页面**：点击日期跳转到当天详细信息页
- **订餐功能**：直接从日历跳转到订餐页面
- **历史查看**：查看历史餐次记录

### 2. 手势操作
- **左右滑动**：切换不同周的数据
- **上下滑动**：查看更多周的信息
- **长按操作**：快速预订或取消预订

### 3. 数据筛选
- **餐次类型**：仅显示午餐或晚餐
- **状态筛选**：仅显示特定状态的餐次
- **价格排序**：按价格高低排序显示

## 用户体验优化

### 1. 视觉反馈
- **今日高亮**：明确标识当前日期
- **状态颜色**：直观的颜色区分不同状态
- **加载状态**：数据加载时的友好提示

### 2. 操作便捷
- **一屏显示**：三周信息在一屏内完整展示
- **状态图例**：底部图例帮助用户理解
- **自动刷新**：页面显示时自动获取最新数据

### 3. 信息清晰
- **层次分明**：头部、日历、图例的清晰分层
- **信息完整**：日期、价格、状态信息一目了然
- **对比明显**：不同状态的视觉对比度足够