# 订单列表页面 (order_list.js)

## 页面概述

订单列表页面展示系统中的订单信息，支持多种过滤和查看模式。管理员可以查看所有订单，普通用户只能查看自己的订单。页面支持按餐次、用户、状态等维度进行过滤，并提供订单详细信息的展示和基本的订单管理功能。

## 页面路径
- 文件位置：`client/pages/common/order_list/order_list.js`
- 页面路径：`pages/common/order_list/order_list`
- 权限要求：已注册用户
- 入口：餐次管理页面、订餐页面的"查看下单详情"按钮

## 页面功能

### 主要职责
1. **订单列表展示**：展示符合条件的订单列表
2. **多维度过滤**：支持按餐次、用户、状态过滤
3. **订单详情展示**：显示订单的详细信息
4. **订单统计**：显示订单数量和金额统计
5. **权限控制**：管理员和用户看到不同的内容

## 页面数据结构

### data 字段
```javascript
{
  orders: Array,           // 订单列表
  loading: Boolean,        // 页面加载状态
  userInfo: Object,        // 当前用户信息
  isAdmin: Boolean,        // 是否管理员
  filters: {              // 过滤条件
    meal_id: Number,      // 特定餐次ID
    user_id: Number,      // 特定用户ID
    status: String,       // 订单状态过滤
    date_start: String,   // 开始日期
    date_end: String      // 结束日期
  },
  statistics: {           // 统计信息
    total_count: Number,  // 总订单数
    total_amount: Number, // 总金额
    active_count: Number, // 有效订单数
    active_amount: Number // 有效订单金额
  },
  showFilters: Boolean,   // 是否显示过滤器
  expandedOrders: Array,  // 展开详情的订单ID列表
  pageTitle: String       // 页面标题
}
```

### orders 数组结构
```javascript
[
  {
    order_id: Number,       // 订单ID
    user_id: Number,        // 用户ID
    user_name: String,      // 用户昵称
    meal_id: Number,        // 餐次ID
    meal_date: String,      // 餐次日期
    meal_slot: String,      // 餐次时段
    meal_description: String, // 餐次描述
    amount_cents: Number,   // 订单金额（分）
    amount_yuan: Number,    // 订单金额（元）
    addon_selections: Object, // 附加项选择
    addon_details: Array,   // 附加项详情列表
    status: String,         // 订单状态
    created_at: String,     // 创建时间
    updated_at: String,     // 更新时间
    meal_base_price_yuan: Number // 餐次基础价格（元）
  }
]
```

### addon_details 数组结构
```javascript
[
  {
    addon_id: Number,       // 附加项ID
    name: String,          // 附加项名称
    price_yuan: Number,    // 单价（元）
    quantity: Number,      // 选择数量
    total_yuan: Number     // 小计（元）
  }
]
```

## 核心功能模块

### 1. 订单列表管理
- **数据加载**：根据权限和过滤条件加载订单
- **分页加载**：支持上拉加载更多订单
- **实时刷新**：下拉刷新获取最新数据
- **列表排序**：按创建时间倒序排列

### 2. 过滤功能
- **餐次过滤**：过滤特定餐次的订单
- **用户过滤**：过滤特定用户的订单（管理员可用）
- **状态过滤**：过滤特定状态的订单（active/canceled）
- **日期过滤**：按日期范围过滤订单
- **快速过滤**：预设的快速过滤选项

### 3. 订单详情展示
- **基本信息**：订单号、用户、餐次、时间
- **价格明细**：基础价格、附加项明细、总价
- **状态信息**：订单状态及状态时间
- **展开收缩**：点击订单卡片展开/收缩详情

### 4. 订单统计
- **数量统计**：总订单数、有效订单数
- **金额统计**：总金额、有效金额
- **分组统计**：按餐次或用户分组统计
- **实时更新**：过滤条件变化时实时更新统计

### 5. 订单操作
- **查看详情**：展开查看订单详细信息
- **取消订单**：管理员可取消订单（需确认）
- **导出数据**：管理员可导出订单数据（预留功能）

## API 调用

参考 `doc/api.md` 中的订单管理接口：

### 1. 获取订单列表
- **接口**：`GET /orders`
- **权限**：用户（仅返回自己的订单）/ 管理员（返回所有订单）
- **参数**：
  ```javascript
  {
    meal_id?: Number,      // 餐次ID过滤
    user_id?: Number,      // 用户ID过滤（管理员可用）
    status?: String,       // 状态过滤
    date_start?: String,   // 开始日期
    date_end?: String,     // 结束日期
    page?: Number,         // 页码
    size?: Number          // 每页大小
  }
  ```

### 2. 获取订单详情
- **接口**：`GET /orders/{order_id}`
- **权限**：订单所有者或管理员
- **返回**：订单详细信息

### 3. 取消订单（管理员）
- **接口**：`DELETE /admin/orders/{order_id}`
- **权限**：管理员
- **返回**：操作结果

### 4. 获取订单统计
- **接口**：`GET /orders/statistics`
- **权限**：用户（自己的统计）/ 管理员（全局统计）
- **参数**：同订单列表接口
- **返回**：统计数据

### 5. 获取用户列表（管理员）
- **接口**：`GET /admin/users`
- **权限**：管理员
- **返回**：用户列表（用于过滤选择）

## 页面布局结构

### 1. 页面头部
- **标题**：订单列表 / 特定餐次订单（根据入口）
- **返回按钮**：左上角返回上一页面
- **过滤按钮**：右上角显示/隐藏过滤器

### 2. 统计信息区域
```
┌─────────────────────────────────────┐
│  📊 订单统计                         │
├─────────────────────────────────────┤
│  总订单：25 份    有效订单：23 份    │
│  总金额：¥487.50  有效金额：¥456.00  │
└─────────────────────────────────────┘
```

### 3. 过滤器区域（可折叠）
```
┌─────────────────────────────────────┐
│  🔍 过滤条件                         │
├─────────────────────────────────────┤
│  餐次：[全部] ▼                     │
│  用户：[全部] ▼  (管理员可见)        │
│  状态：[全部] ▼                     │
│  日期：[最近7天] ▼                   │
│         [重置]    [应用]           │
└─────────────────────────────────────┘
```

### 4. 订单列表区域
```
普通显示状态：
┌─────────────────────────────────────┐
│  📋 #20241127001  👤 张三            │
│  📅 11-27 午餐  💰 ¥21.00  ✅ 有效   │
│  🕒 下单时间：11-26 14:30            │
│                      [展开详情] ▼   │
├─────────────────────────────────────┤
│  📋 #20241127002  👤 李四            │
│  📅 11-27 午餐  💰 ¥18.00  ❌ 已取消 │
│  🕒 下单时间：11-26 15:15            │
│                      [展开详情] ▼   │
└─────────────────────────────────────┘

展开详情状态：
┌─────────────────────────────────────┐
│  📋 #20241127001  👤 张三            │
│  📅 11-27 午餐  💰 ¥21.00  ✅ 有效   │
│  🕒 下单时间：11-26 14:30            │
│                      [收起详情] ▲   │
├─────────────────────────────────────┤
│  💰 价格明细：                       │
│    基础价格：       ¥18.00          │
│    + 加鸡腿 ¥3.00 × 1 = ¥3.00      │
│    总计：           ¥21.00          │
│                                     │
│  📝 餐次：红烧肉套餐，配白米饭和汤    │
│  [取消订单] (管理员可见)             │
└─────────────────────────────────────┘
```

### 5. 空状态显示
```
┌─────────────────────────────────────┐
│           😔 暂无订单数据            │
│                                     │
│        调整过滤条件试试看？          │
│           [重置过滤器]               │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  检查用户权限 → 
    解析入口参数 → 
      设置默认过滤条件 → 
        加载订单数据 → 
          计算统计信息 → 
            渲染页面内容
```

### 2. 过滤功能流程
```
点击过滤按钮 → 
  显示过滤器 → 
    选择过滤条件 → 
      点击应用 → 
        重新加载数据 → 
          更新统计信息 → 
            刷新列表显示
```

### 3. 订单详情展开流程
```
点击订单卡片 → 
  检查是否已展开 → 
    加载订单详情 → 
      展开详情区域 → 
        显示价格明细和操作按钮
```

### 4. 取消订单流程（管理员）
```
点击取消订单 → 
  显示确认弹窗 → 
    输入取消原因 → 
      调用取消接口 → 
        更新订单状态 → 
          刷新列表 → 
            显示操作结果
```

## 权限控制

### 1. 页面访问控制
```javascript
onLoad() {
  if (!this.checkUserLogin()) {
    wx.redirectTo({ url: '/pages/login/login' })
    return
  }
  this.setData({ 
    isAdmin: this.checkAdminPermission(),
    userInfo: this.getUserInfo()
  })
  this.loadPageData()
}
```

### 2. 数据权限控制
- **用户权限**：只能查看自己的订单
- **管理员权限**：可查看所有订单，可取消订单
- **过滤权限**：用户不能按其他用户过滤

### 3. 操作权限控制
- **取消订单**：仅管理员可操作
- **导出数据**：仅管理员可操作
- **用户过滤**：仅管理员可见

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮和错误提示
- **操作失败**：显示具体错误信息
- **超时处理**：自动重试或提示手动刷新

### 2. 业务错误处理
- **权限不足**：显示"权限不足"并返回上一页
- **数据不存在**：显示"暂无数据"状态
- **操作冲突**：显示"数据已变更，请刷新"

### 3. 数据异常处理
- **金额异常**：显示异常标记，不影响其他数据
- **状态异常**：显示未知状态，记录错误日志
- **格式错误**：使用默认值，避免页面崩溃

## 用户体验优化

### 1. 加载性能优化
- **分页加载**：避免一次性加载大量数据
- **虚拟列表**：长列表使用虚拟滚动（预留）
- **数据缓存**：缓存已加载的订单数据
- **骨架屏**：首次加载显示骨架屏

### 2. 交互体验优化
- **下拉刷新**：支持下拉刷新获取最新数据
- **上拉加载**：支持上拉加载更多数据
- **快速过滤**：提供常用的快速过滤选项
- **状态记忆**：记住用户的过滤偏好

### 3. 视觉体验优化
- **状态指示**：用颜色和图标区分订单状态
- **金额高亮**：重要金额信息突出显示
- **分组显示**：按日期或餐次分组显示（可选）
- **展开动画**：详情展开/收缩有平滑动画

### 4. 信息展示优化
- **时间友好**：显示相对时间（如"2小时前"）
- **金额格式**：统一的金额显示格式
- **截断处理**：长文本内容智能截断
- **空状态友好**：无数据时显示友好的空状态

## 数据流管理

### 1. 过滤状态管理
```javascript
// 过滤条件变更时重新加载数据
applyFilters() {
  this.setData({ loading: true })
  this.loadOrders().then(() => {
    this.calculateStatistics()
    this.setData({ loading: false })
  })
}

// 重置过滤条件
resetFilters() {
  this.setData({
    filters: this.getDefaultFilters()
  })
  this.applyFilters()
}
```

### 2. 列表状态管理
```javascript
// 展开/收缩订单详情
toggleOrderDetail(orderId) {
  const expanded = this.data.expandedOrders
  const index = expanded.indexOf(orderId)
  
  if (index > -1) {
    expanded.splice(index, 1)
  } else {
    expanded.push(orderId)
  }
  
  this.setData({ expandedOrders: expanded })
}
```

### 3. 统计数据计算
```javascript
calculateStatistics() {
  const orders = this.data.orders
  const stats = {
    total_count: orders.length,
    total_amount: 0,
    active_count: 0,
    active_amount: 0
  }
  
  orders.forEach(order => {
    stats.total_amount += order.amount_yuan
    if (order.status === 'active') {
      stats.active_count++
      stats.active_amount += order.amount_yuan
    }
  })
  
  this.setData({ statistics: stats })
}
```

## 扩展功能预留

### 1. 高级过滤
- **模糊搜索**：按订单号、用户名模糊搜索
- **金额范围**：按订单金额范围过滤
- **附加项过滤**：按选择的附加项过滤

### 2. 数据导出
- **Excel导出**：导出订单数据为Excel文件
- **报表生成**：生成各种统计报表
- **数据分析**：订单趋势和用户行为分析

### 3. 批量操作
- **批量取消**：管理员批量取消订单
- **批量导出**：选择特定订单导出
- **批量通知**：向订单用户发送通知

### 4. 可视化增强
- **图表展示**：订单趋势图表
- **热力图**：用户下单时间热力图
- **地图显示**：用户分布地图（如果有地理信息）

## 安全考虑

### 1. 数据安全
- **权限隔离**：严格控制用户只能看到自己的数据
- **敏感信息**：脱敏显示敏感用户信息
- **操作日志**：记录管理员的敏感操作

### 2. 界面安全
- **防止XSS**：用户输入内容进行转义
- **数据验证**：前端显示数据进行格式验证
- **错误处理**：不暴露系统内部错误信息

### 3. 业务安全
- **操作确认**：重要操作需要二次确认
- **权限检查**：每个操作都进行权限验证
- **状态一致性**：确保显示状态与实际状态一致

## 性能优化建议

### 1. 数据加载优化
- **分页大小**：合理设置分页大小（建议20-50条）
- **预加载**：预加载下一页数据
- **缓存策略**：合理缓存订单数据，设置过期时间

### 2. 渲染性能优化
- **列表复用**：使用小程序的列表复用机制
- **图片懒加载**：如果有头像等图片，使用懒加载
- **节流防抖**：搜索和过滤操作使用节流

### 3. 内存管理
- **定时清理**：定期清理不需要的缓存数据
- **组件销毁**：页面销毁时清理事件监听
- **数据限制**：限制同时展开的订单详情数量

这个页面设计提供了完善的订单管理功能，支持灵活的过滤和查看，同时考虑了不同用户角色的权限需求，为系统的订单管理提供了强大的支持。