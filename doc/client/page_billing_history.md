# 用户历史账单查询页面 (billing_history.js)

## 页面概述

用户历史账单查询页面用于展示用户的财务记录和交易历史。用户只能查看自己的账单记录，管理员可以查看所有用户的账单记录并可以选择特定用户查看。页面展示详细的交易记录包括充值、消费、退款等所有资金变动，帮助用户了解账户资金流水。

## 页面路径
- 文件位置：`client/pages/common/billing_history/billing_history.js`
- 页面路径：`pages/common/billing_history/billing_history`
- 权限要求：已注册用户
- 入口：个人中心页面、用户管理页面（管理员）

## 页面功能

### 主要职责
1. **账单记录展示**：显示用户的所有资金变动记录
2. **交易分类筛选**：按交易类型、方向、时间筛选
3. **余额变化追踪**：显示每笔交易后的账户余额
4. **交易详情查看**：展示交易的详细信息
5. **统计信息汇总**：显示各类交易的汇总数据

## 页面数据结构

### data 字段
```javascript
{
  ledgerRecords: Array,    // 账本记录列表
  userInfo: Object,        // 当前查看的用户信息
  currentUser: Object,     // 当前登录用户信息
  isAdmin: Boolean,        // 是否管理员
  loading: Boolean,        // 页面加载状态
  filters: {              // 筛选条件
    type: String,         // 交易类型: all/recharge/order/refund
    direction: String,    // 交易方向: all/in/out
    date_start: String,   // 开始日期
    date_end: String,     // 结束日期
    amount_min: Number,   // 最小金额
    amount_max: Number    // 最大金额
  },
  statistics: {           // 统计信息
    total_in: Number,     // 总收入
    total_out: Number,    // 总支出
    total_count: Number,  // 总记录数
    recharge_amount: Number, // 充值金额
    order_amount: Number, // 消费金额
    refund_amount: Number // 退款金额
  },
  showFilters: Boolean,   // 是否显示筛选器
  hasMore: Boolean,       // 是否有更多数据
  pageNum: Number,        // 当前页码
  expandedRecords: Array  // 展开详情的记录ID列表
}
```

### ledgerRecords 数组结构
```javascript
[
  {
    ledger_id: Number,      // 账本记录ID
    transaction_no: String, // 交易号
    user_id: Number,        // 用户ID
    user_name: String,      // 用户昵称
    type: String,          // 类型: recharge/order/refund
    direction: String,     // 方向: in/out
    amount_cents: Number,  // 金额（分）
    amount_yuan: Number,   // 金额（元）
    balance_before_yuan: Number, // 变动前余额（元）
    balance_after_yuan: Number,  // 变动后余额（元）
    order_id: Number,      // 关联订单ID（可能为空）
    order_info: Object,    // 关联订单信息
    description: String,   // 交易描述
    operator_id: Number,   // 操作员ID（充值时）
    operator_name: String, // 操作员昵称
    created_at: String,    // 创建时间
    type_display: String,  // 类型显示名称
    direction_display: String, // 方向显示名称
    amount_display: String // 金额显示（带正负号）
  }
]
```

### order_info 对象结构（当交易关联订单时）
```javascript
{
  meal_date: String,      // 餐次日期
  meal_slot: String,      // 餐次时段
  meal_description: String, // 餐次描述
  addon_summary: String   // 附加项摘要
}
```

## 核心功能模块

### 1. 账单记录管理
- **数据加载**：根据权限和筛选条件加载记录
- **分页加载**：支持上拉加载更多记录
- **实时刷新**：下拉刷新获取最新数据
- **时间排序**：按交易时间倒序显示

### 2. 筛选功能
- **交易类型筛选**：充值、订餐消费、退款
- **交易方向筛选**：收入、支出
- **日期范围筛选**：自定义时间范围
- **金额范围筛选**：按金额区间筛选
- **快速筛选**：今天、本周、本月等快速选项

### 3. 用户选择（管理员）
- **用户列表**：显示所有注册用户
- **用户搜索**：按昵称或ID搜索用户
- **快速切换**：快速切换查看不同用户的账单
- **用户信息**：显示当前查看用户的基本信息

### 4. 交易详情展示
- **基本信息**：交易号、时间、类型、金额
- **余额变化**：交易前后余额对比
- **关联信息**：如果是订餐消费，显示餐次信息
- **操作信息**：显示操作员信息（充值时）

### 5. 统计信息
- **金额统计**：收入、支出、净值统计
- **类型统计**：各类交易的金额和笔数
- **时间统计**：按筛选条件的统计数据
- **图表展示**：资金变化趋势图（预留）

## API 调用

参考 `doc/api.md` 中的账单查询接口：

### 1. 获取账单记录
- **接口**：`GET /users/{user_id}/ledger`
- **权限**：用户（自己的记录）/ 管理员（任意用户）
- **参数**：
  ```javascript
  {
    type?: String,         // 交易类型过滤
    direction?: String,    // 方向过滤
    date_start?: String,   // 开始日期
    date_end?: String,     // 结束日期
    amount_min?: Number,   // 最小金额（分）
    amount_max?: Number,   // 最大金额（分）
    page?: Number,         // 页码
    size?: Number          // 每页大小
  }
  ```

### 2. 获取账单统计
- **接口**：`GET /users/{user_id}/ledger/statistics`
- **权限**：用户（自己的统计）/ 管理员（任意用户）
- **参数**：同账单记录接口
- **返回**：统计数据

### 3. 获取用户列表（管理员）
- **接口**：`GET /admin/users`
- **权限**：管理员
- **返回**：用户列表（用于选择查看目标）

### 4. 获取用户基本信息
- **接口**：`GET /users/{user_id}`
- **权限**：用户（自己的信息）/ 管理员（任意用户）
- **返回**：用户基本信息和当前余额

## 页面布局结构

### 1. 页面头部
- **标题**：账单历史 / XXX的账单历史（管理员查看其他用户）
- **返回按钮**：左上角返回上一页面
- **筛选按钮**：右上角显示/隐藏筛选器

### 2. 用户信息区域（管理员查看时显示）
```
┌─────────────────────────────────────┐
│  👤 用户：张三                       │
│  💰 当前余额：¥88.50                 │
│  📱 OpenID：oxxxxxxxxxxxxxxxxx       │
│                    [切换用户] →     │
└─────────────────────────────────────┘
```

### 3. 统计信息区域
```
┌─────────────────────────────────────┐
│  📊 账单统计                         │
├─────────────────────────────────────┤
│  📈 总收入：¥2,350.00  (15笔)        │
│  📉 总支出：¥2,261.50  (48笔)        │
│  💰 净余额：¥88.50                   │
└─────────────────────────────────────┘
```

### 4. 筛选器区域（可折叠）
```
┌─────────────────────────────────────┐
│  🔍 筛选条件                         │
├─────────────────────────────────────┤
│  类型：[全部] ▼  方向：[全部] ▼      │
│  日期：[最近30天] ▼                  │
│  金额：[￥0] - [￥999] 元             │
│         [重置]    [应用]           │
└─────────────────────────────────────┘
```

### 5. 账单记录列表
```
普通显示：
┌─────────────────────────────────────┐
│  💰 充值 +¥100.00                   │
│  📅 11-25 09:30  📋 TXN20241125001   │
│  余额：¥50.00 → ¥150.00             │
│                      [展开详情] ▼   │
├─────────────────────────────────────┤
│  🍽️ 订餐消费 -¥21.00                │
│  📅 11-26 14:30  📋 TXN20241126015   │
│  余额：¥150.00 → ¥129.00            │
│                      [展开详情] ▼   │
├─────────────────────────────────────┤
│  🔄 订单退款 +¥18.00                │
│  📅 11-27 10:15  📋 TXN20241127008   │
│  余额：¥129.00 → ¥147.00            │
│                      [展开详情] ▼   │
└─────────────────────────────────────┘

展开详情：
┌─────────────────────────────────────┐
│  🍽️ 订餐消费 -¥21.00                │
│  📅 11-26 14:30  📋 TXN20241126015   │
│  余额：¥150.00 → ¥129.00            │
│                      [收起详情] ▲   │
├─────────────────────────────────────┤
│  📝 交易详情：                       │
│    餐次：11-27 午餐                 │
│    菜品：红烧肉套餐                 │
│    附加项：加鸡腿×1                 │
│                                     │
│  👤 操作员：系统                     │
│  📋 订单号：#20241127001             │
└─────────────────────────────────────┘
```

### 6. 快速统计卡片
```
┌─────────────────────────────────────┐
│  本月统计 📅                         │
├─────────────────────────────────────┤
│  充值：¥500.00 (3笔)  消费：¥420.00 (12笔) │
│  退款：¥36.00 (2笔)   净值：¥116.00  │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  检查用户权限 → 
    获取用户参数 → 
      加载用户信息 → 
        设置默认筛选 → 
          加载账单数据 → 
            计算统计信息 → 
              渲染页面内容
```

### 2. 用户切换流程（管理员）
```
点击切换用户 → 
  显示用户选择器 → 
    搜索/选择用户 → 
      更新用户信息 → 
        重置筛选条件 → 
          重新加载数据 → 
            更新页面显示
```

### 3. 筛选应用流程
```
设置筛选条件 → 
  点击应用筛选 → 
    验证筛选参数 → 
      重新加载数据 → 
        更新统计信息 → 
          刷新列表显示 → 
            收起筛选器
```

### 4. 记录详情展开流程
```
点击记录卡片 → 
  检查是否已展开 → 
    加载详细信息 → 
      展开详情区域 → 
        显示关联订单信息
```

## 权限控制

### 1. 页面访问控制
```javascript
onLoad(options) {
  if (!this.checkUserLogin()) {
    wx.redirectTo({ url: '/pages/login/login' })
    return
  }
  
  const isAdmin = this.checkAdminPermission()
  const targetUserId = options.user_id || this.getCurrentUserId()
  
  // 非管理员不能查看其他用户账单
  if (!isAdmin && targetUserId != this.getCurrentUserId()) {
    wx.showToast({ title: '权限不足', icon: 'none' })
    wx.navigateBack()
    return
  }
  
  this.setData({ isAdmin, targetUserId })
  this.loadPageData()
}
```

### 2. 数据权限控制
- **用户权限**：只能查看自己的账单记录
- **管理员权限**：可查看所有用户的账单记录
- **操作日志**：管理员的查看操作需要记录

### 3. 敏感信息处理
- **交易号脱敏**：对普通用户部分隐藏交易号
- **余额隐私**：用户可选择是否显示具体余额
- **操作员信息**：仅管理员可查看充值操作员信息

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮和错误提示
- **超时处理**：自动重试或提示手动刷新
- **网络断线**：显示离线状态提示

### 2. 业务错误处理
- **权限不足**：显示权限错误并返回
- **用户不存在**：显示用户不存在提示
- **数据异常**：显示数据错误，提供客服联系方式

### 3. 数据完整性处理
- **余额不一致**：标记异常记录，不影响显示
- **交易记录缺失**：显示数据不完整提示
- **关联订单丢失**：仅显示交易基本信息

## 用户体验优化

### 1. 加载性能优化
- **分页加载**：每页20-30条记录
- **虚拟滚动**：长列表优化（预留）
- **数据缓存**：缓存最近查看的记录
- **预加载**：预加载下一页数据

### 2. 交互体验优化
- **下拉刷新**：支持下拉刷新最新数据
- **上拉加载**：平滑的上拉加载更多
- **快速筛选**：提供常用时间段快速筛选
- **搜索建议**：用户搜索提供智能建议

### 3. 视觉体验优化
- **交易类型图标**：不同类型使用不同图标和颜色
- **金额显示**：收入绿色、支出红色、退款橙色
- **余额趋势**：简单的余额变化趋势线
- **时间分组**：按日期分组显示记录

### 4. 信息展示优化
- **金额格式化**：统一的金额显示格式
- **时间友好**：显示相对时间和绝对时间
- **描述优化**：简化交易描述，重点突出
- **状态标识**：清晰的交易状态标识

## 数据流管理

### 1. 筛选状态管理
```javascript
// 应用筛选条件
applyFilters() {
  this.setData({ 
    loading: true, 
    pageNum: 1, 
    ledgerRecords: [] 
  })
  
  this.loadLedgerRecords().then(() => {
    this.calculateStatistics()
    this.setData({ loading: false })
  })
}

// 重置筛选条件
resetFilters() {
  this.setData({
    filters: this.getDefaultFilters()
  })
  this.applyFilters()
}
```

### 2. 分页数据管理
```javascript
// 加载更多数据
loadMore() {
  if (!this.data.hasMore || this.data.loading) return
  
  this.setData({ loading: true })
  const nextPage = this.data.pageNum + 1
  
  this.loadLedgerRecords(nextPage).then((newRecords) => {
    const allRecords = [...this.data.ledgerRecords, ...newRecords]
    this.setData({
      ledgerRecords: allRecords,
      pageNum: nextPage,
      hasMore: newRecords.length === this.data.pageSize,
      loading: false
    })
  })
}
```

### 3. 用户切换管理
```javascript
// 切换查看用户（管理员）
switchUser(userId) {
  this.setData({
    targetUserId: userId,
    ledgerRecords: [],
    statistics: {},
    pageNum: 1,
    filters: this.getDefaultFilters()
  })
  
  this.loadUserInfo(userId).then(() => {
    this.loadPageData()
  })
}
```

## 扩展功能预留

### 1. 数据导出
- **Excel导出**：导出账单记录为Excel文件
- **PDF报表**：生成PDF格式的账单报表
- **数据筛选导出**：按筛选条件导出特定数据

### 2. 图表分析
- **余额趋势图**：显示余额变化趋势
- **收支分析图**：饼图显示收支结构
- **月度对比图**：不同月份的消费对比

### 3. 智能分析
- **消费习惯分析**：分析用户订餐习惯
- **异常检测**：检测异常交易模式
- **消费预测**：预测未来消费趋势

### 4. 通知提醒
- **余额不足提醒**：余额低于阈值时提醒
- **交易通知**：重要交易的推送通知
- **月度账单**：每月发送账单汇总

## 安全考虑

### 1. 数据安全
- **权限验证**：每次数据请求都验证权限
- **数据脱敏**：敏感信息适度脱敏显示
- **操作日志**：记录敏感操作和查看行为

### 2. 隐私保护
- **访问控制**：严格控制谁能查看谁的数据
- **数据加密**：传输过程中的数据加密
- **会话管理**：合理的会话超时和刷新机制

### 3. 业务安全
- **数据一致性**：确保显示的数据与实际一致
- **防篡改**：交易记录的完整性校验
- **审计跟踪**：完整的操作审计链条

## 性能优化建议

### 1. 数据查询优化
- **索引优化**：为常用查询字段建立索引
- **分页查询**：避免一次性加载大量数据
- **缓存策略**：合理使用缓存减少数据库查询

### 2. 前端渲染优化
- **虚拟列表**：长列表使用虚拟滚动
- **懒加载**：延迟加载非关键数据
- **节流防抖**：筛选操作使用节流机制

### 3. 网络优化
- **请求合并**：合并相关的API请求
- **数据压缩**：压缩传输数据大小
- **离线缓存**：关键数据支持离线查看

这个页面设计为用户和管理员提供了完整的财务记录查看功能，支持灵活的筛选和统计，帮助用户清楚地了解自己的资金流动情况，同时为管理员提供了强大的财务监控工具。