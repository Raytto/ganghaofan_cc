# 附加项管理页面 (addon_manage.js)

## 页面概述

附加项管理页面是管理员专用页面，用于管理餐次的附加项（如加鸡腿、加饮料等）。管理员可以查看所有生效中的附加项信息，停用现有附加项，以及添加新的附加项。

## 页面路径
- 文件位置：`client/pages/admin/addon_manage/addon_manage.js`
- 页面路径：`pages/admin/addon_manage/addon_manage`
- 权限要求：管理员身份 + 管理模式开启

## 页面功能

### 主要职责
1. **附加项列表展示**：显示所有生效中的附加项
2. **附加项停用**：将附加项设置为inactive状态
3. **新增附加项**：创建新的附加项

## 页面数据结构

### data 字段
```javascript
{
  activeAddons: Array,     // 生效中的附加项列表
  loading: Boolean,        // 页面加载状态
  newAddon: {             // 新增附加项表单
    name: String,         // 附加项名称
    price_yuan: Number    // 附加项价格（元）
  },
  submitting: Boolean     // 提交状态
}
```

### activeAddons 数组结构
```javascript
[
  {
    addon_id: Number,        // 附加项ID
    name: String,           // 附加项名称
    price_cents: Number,    // 价格（分）
    price_yuan: Number,     // 价格（元）
    display_order: Number,  // 显示顺序
    status: String,         // 状态：active
    created_at: String      // 创建时间
  }
]
```

## 核心功能模块

### 1. 附加项列表管理
- **数据加载**：页面加载时获取所有active状态的附加项
- **列表展示**：以卡片形式展示附加项信息
- **实时更新**：操作后自动刷新列表

### 2. 附加项停用功能
- **停用按钮**：每个附加项卡片包含删除按钮
- **确认弹窗**：点击删除前显示确认弹窗
- **后端调用**：调用DELETE接口将附加项设置为inactive
- **列表更新**：停用成功后从列表中移除该项

### 3. 新增附加项功能
- **名称输入**：单行文本框输入附加项名称
- **价格设置**：数字输入框 + +1快捷按钮
- **表单验证**：检查名称不为空，价格为正数
- **提交处理**：调用POST接口创建新附加项

## API 调用

参考 `doc/api.md` 中的管理员附加项接口：

### 1. 获取附加项列表
- **接口**：`GET /admin/addons?status=active`
- **权限**：管理员
- **返回**：生效中的附加项列表

### 2. 停用附加项
- **接口**：`DELETE /admin/addons/{addon_id}`
- **权限**：管理员
- **参数**：路径参数 addon_id
- **返回**：操作结果

### 3. 创建附加项
- **接口**：`POST /admin/addons`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    name: String,           // 附加项名称
    price_cents: Number,    // 价格（分）
    display_order: Number,  // 显示顺序（可选，默认递增）
    is_default: Boolean     // 是否默认（可选，默认false）
  }
  ```

## 页面布局结构

### 1. 页面头部
- **标题**：附加项管理
- **返回按钮**：左上角返回上一个页面（用微信的页面栈逻辑）

### 2. 生效附加项列表
```
┌─────────────────────────────────────┐
│  生效中的附加项                      │
├─────────────────────────────────────┤
│  [附加项卡片1]  加鸡腿    ¥3.00  [删除] │
│  [附加项卡片2]  加饮料    ¥2.00  [删除] │
│  [附加项卡片3]  加米饭    ¥1.00  [删除] │
└─────────────────────────────────────┘
```

### 3. 新增附加项表单
```
┌─────────────────────────────────────┐
│  添加新附加项                       │
├─────────────────────────────────────┤
│  附加项名称: [____________]          │
│  价格设置:   [____] 元  [+1]        │
│               [新增附加项]           │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  检查管理员权限 → 
    获取附加项列表 → 
      渲染页面内容
```

### 2. 停用附加项流程
```
点击删除按钮 → 
  显示确认弹窗 → 
    用户确认 → 
      调用删除接口 → 
        刷新列表 → 
          显示成功提示
```

### 3. 新增附加项流程
```
填写表单 → 
  点击新增按钮 → 
    表单验证 → 
      调用创建接口 → 
        刷新列表 → 
          清空表单 → 
            显示成功提示
```

## 权限控制

### 1. 页面访问控制
```javascript
// 页面加载时检查权限
onLoad() {
  if (!this.checkAdminPermission()) {
    wx.showToast({
      title: '权限不足',
      icon: 'none'
    })
    wx.navigateBack()
    return
  }
  this.loadAddonList()
}
```

### 2. 权限检查函数
```javascript
checkAdminPermission() {
  const adminUtils = require('../../utils/admin.js')
  return adminUtils.isAdminModeEnabled()
}
```

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮
- **操作失败**：显示具体错误信息
- **权限错误**：跳转回个人中心页面

### 2. 业务错误处理
- **附加项被使用**：显示"该附加项正在被使用，无法删除"
- **名称重复**：显示"附加项名称已存在"
- **表单验证**：实时显示验证错误信息

## 用户体验优化

### 1. 加载状态管理
- **列表加载**：显示骨架屏或loading状态
- **操作反馈**：按钮loading状态，操作成功toast提示

### 2. 表单交互优化
- **价格+1按钮**：快速调整价格，避免频繁输入
- **表单验证**：实时验证，错误提示明确
- **自动清空**：提交成功后自动清空表单

### 3. 确认交互
- **删除确认**：避免误操作，显示附加项名称
- **操作提示**：清晰的成功/失败提示信息

## 数据流管理

### 1. 页面状态管理
```javascript
// 页面状态更新流程
loadAddonList() → setData({ activeAddons, loading: false })
deleteAddon() → setData({ activeAddons: updatedList })
createAddon() → setData({ activeAddons: newList, newAddon: {} })
```

### 2. 表单状态管理
```javascript
// 新增表单状态
{
  newAddon: {
    name: '',
    price_yuan: 0
  },
  submitting: false
}
```

## 扩展功能预留

### 1. 批量操作
- **批量删除**：选择多个附加项进行批量停用
- **排序调整**：拖拽调整附加项显示顺序

### 2. 附加项详情
- **使用统计**：显示每个附加项的使用频次
- **历史记录**：查看附加项的创建和修改历史

### 3. 高级设置
- **默认附加项**：设置新餐次的默认附加项
- **价格模板**：常用价格的快速设置

## 安全考虑

### 1. 前端权限验证
- 页面级权限检查
- 操作级权限验证
- 实时状态同步

### 2. 后端依赖
- 所有关键操作依赖后端API权限验证
- 前端权限检查仅用于用户体验优化

### 3. 数据一致性
- 操作后及时刷新数据
- 错误状态的正确处理和回滚

这个页面设计遵循了简单实用的原则，专注于核心功能，同时为未来扩展预留了空间。