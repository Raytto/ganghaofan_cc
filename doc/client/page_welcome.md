# 欢迎页面 (welcome.js)

## 页面概述

欢迎页面是用户进入小程序后的主要入口页面，负责处理用户身份验证和状态检查，引导用户进入相应的流程。

## 页面路径
- 文件位置：`client/pages/welcome/welcome.js`
- 页面路径：`../welcome/welcome`

## 页面功能

### 主要职责
1. **用户身份验证**：检查用户登录状态和注册状态
2. **状态引导**：根据用户状态引导到相应页面
3. **欢迎展示**：为已注册用户显示个性化欢迎信息

### 核心逻辑流程

#### 1. 页面加载流程 (onLoad)
```
页面加载 → 调用getOpenIdAndFetchUserInfo() → 用户状态检查
```

#### 2. 用户状态检查逻辑 (getOpenIdAndFetchUserInfo)
```
开始
│
├─ 检查本地Token
│  ├─ 有Token → 调用fetchCurrentUserStatus()
│  │              ├─ 已注册 → 显示欢迎页面
│  │              └─ 未注册 → 跳转注册页面
│  │
│  └─ 无Token → 调用wechatSilentLogin()
│                 ├─ 已注册 → 显示欢迎页面
│                 └─ 未注册 → 跳转注册页面
│
└─ 错误处理 → 跳转注册页面
```

#### 3. 微信静默登录流程 (wechatSilentLogin)
1. 调用 `wx.login()` 获取微信授权码
2. 发送请求到 `/auth/wechat/login` 接口
3. 保存返回的 `access_token` 和用户信息
4. 返回用户信息用于状态判断

#### 4. 当前用户状态检查 (fetchCurrentUserStatus)
1. 验证本地 Token 存在
2. 调用 `/auth/me` 接口获取用户状态
3. 检查 `wechat_name` 字段判断注册状态
4. 根据注册状态显示页面或跳转

## 页面数据结构

### data 字段
```javascript
{
  userInfo: {
    avatarUrl: String,    // 用户头像URL，默认为defaultAvatarUrl
    nickName: String      // 用户昵称，默认为空字符串
  },
  openid: String,         // 用户OpenID
  isRegistered: Boolean,  // 用户注册状态，默认true
  loading: Boolean        // 页面加载状态，默认true
}
```

## API 调用

### 1. 微信静默登录
- **接口**：`POST /auth/wechat/login`
- **参数**：`{ code: String }`
- **返回**：用户信息和访问令牌

### 2. 获取当前用户状态
- **接口**：`GET /auth/me`
- **参数**：无（自动携带Token）
- **返回**：当前用户详细信息

## 页面展示状态

### 1. 加载状态 (loading: true)
- 显示加载中的界面
- 在后台进行用户状态检查

### 2. 已注册用户展示 (isRegistered: true)
- **用户头像**：显示用户设置的头像或默认头像
- **用户昵称**：显示用户设置的微信昵称
- **OpenID**：显示用户的微信OpenID（开发调试用）
- **欢迎文案**：显示 "欢迎和罡子哥一起健康每一天"
- **开始按钮**：绿色按钮，点击进入点餐页面

### 3. 未注册用户处理
- 自动跳转到注册页面，不在当前页面停留

## 用户交互

### 开始按钮点击 (onStartTap)
- **功能**：进入主应用功能（点餐页面）
- **前置条件**：用户必须已注册 (`isRegistered: true`)
- **未注册处理**：显示提示"请先完成注册"
- **跳转目标**：`../meals/meals` (点餐页面)

## 错误处理

### 1. Token失效处理
- 清除本地存储的 `access_token` 和 `user_info`
- 跳转到注册页面重新进行身份验证

### 2. 网络请求失败
- 显示错误提示Toast
- 自动跳转到注册页面

### 3. 微信登录失败
- 记录错误日志
- 显示"初始化失败"提示
- 2秒后自动跳转到注册页面

## 本地存储管理

### 存储的数据
- `access_token`: 用户访问令牌
- `user_info`: 用户基本信息
- `userInfo`: 页面显示用的用户信息

### 清理时机
- Token验证失败时
- 用户状态异常时
- 认证错误时

## 页面特点

1. **自动化流程**：用户无需手动操作，自动完成状态检查
2. **错误容错**：对各种错误情况都有相应的处理机制
3. **状态引导**：根据用户不同状态引导到对应页面
4. **开发友好**：支持微信开发者工具的mock数据
5. **用户体验**：流畅的页面跳转，清晰的状态反馈