# 用户管理页面 (user_manage.js)

## 页面概述

用户管理页面是管理员专用页面，用于管理系统中的所有注册用户。管理员可以查看用户列表，管理用户余额（充值和扣款），管理用户状态（拉黑和取消拉黑），以及查看用户的历史账单。这是系统用户管理的核心页面。

## 页面路径
- 文件位置：`client/pages/admin/user_manage/user_manage.js`
- 页面路径：`pages/admin/user_manage/user_manage`
- 权限要求：管理员身份 + 管理模式开启
- 入口：管理员控制台、个人中心管理菜单

## 页面功能

### 主要职责
1. **用户列表展示**：显示所有注册用户的基本信息
2. **用户搜索**：按昵称、OpenID搜索用户
3. **余额管理**：为用户充值或扣款
4. **状态管理**：拉黑（suspend）或恢复用户
5. **账单查看**：查看用户的历史账单记录

## 页面数据结构

### data 字段
```javascript
{
  users: Array,           // 用户列表
  loading: Boolean,       // 页面加载状态
  searching: Boolean,     // 搜索状态
  searchKeyword: String,  // 搜索关键词
  filters: {             // 筛选条件
    status: String,      // 用户状态: all/active/suspended
    balance_min: Number, // 最小余额
    balance_max: Number, // 最大余额
    has_orders: Boolean  // 是否有订单记录
  },
  statistics: {          // 统计信息
    total_users: Number,   // 总用户数
    active_users: Number,  // 活跃用户数
    suspended_users: Number, // 被拉黑用户数
    total_balance: Number  // 总余额
  },
  showFilters: Boolean,  // 是否显示筛选器
  selectedUser: Object,  // 当前选中的用户（用于操作）
  operationModal: {      // 操作弹窗状态
    visible: Boolean,    // 是否显示
    type: String,        // 操作类型: recharge/deduct/suspend/unsuspend
    amount: Number,      // 金额（充值/扣款用）
    reason: String       // 操作原因
  },
  hasMore: Boolean,      // 是否有更多用户
  pageNum: Number        // 当前页码
}
```

### users 数组结构
```javascript
[
  {
    user_id: Number,       // 用户ID
    open_id: String,       // 微信OpenID（部分脱敏）
    wechat_name: String,   // 微信昵称
    avatar_url: String,    // 头像URL
    balance_cents: Number, // 余额（分）
    balance_yuan: Number,  // 余额（元）
    is_admin: Boolean,     // 是否管理员
    status: String,        // 状态: active/suspended
    created_at: String,    // 注册时间
    last_login_at: String, // 最后登录时间
    order_count: Number,   // 订单数量
    total_consumed: Number, // 总消费金额（元）
    last_order_date: String, // 最后订单日期
    status_display: String // 状态显示文本
  }
]
```

## 核心功能模块

### 1. 用户列表管理
- **用户展示**：以卡片形式展示用户基本信息
- **分页加载**：支持分页加载和上拉加载更多
- **排序功能**：按注册时间、余额、消费等排序
- **状态筛选**：按用户状态筛选显示

### 2. 用户搜索功能
- **关键词搜索**：支持按昵称、OpenID部分匹配搜索
- **实时搜索**：输入时实时显示搜索结果
- **搜索历史**：记住最近的搜索关键词
- **清空搜索**：一键清空搜索条件

### 3. 余额管理功能
- **充值功能**：为用户充值，支持预设金额和自定义金额
- **扣款功能**：扣减用户余额，需要输入扣款原因
- **批量充值**：选择多个用户进行批量充值（预留）
- **充值记录**：操作后自动记录到账本表

### 4. 用户状态管理
- **拉黑用户**：将用户状态设为suspended，禁止登录和操作
- **恢复用户**：将拉黑用户恢复为active状态
- **状态历史**：记录状态变更的历史和原因
- **批量操作**：支持批量状态变更（预留）

### 5. 历史账单查看
- **账单跳转**：点击查看历史账单跳转到账单历史页面
- **快速预览**：在弹窗中显示用户最近的几条账单记录
- **统计概览**：显示用户的收支汇总信息

## API 调用

参考现有API和需要补充的接口：

### 1. 获取用户列表
- **接口**：`GET /admin/users`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    keyword?: String,      // 搜索关键词
    status?: String,       // 状态筛选
    balance_min?: Number,  // 最小余额（分）
    balance_max?: Number,  // 最大余额（分）
    has_orders?: Boolean,  // 是否有订单
    page?: Number,         // 页码
    size?: Number,         // 每页大小
    sort?: String          // 排序字段
  }
  ```

### 2. 用户充值
- **接口**：`POST /admin/users/{user_id}/recharge`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    amount_cents: Number,  // 充值金额（分）
    reason: String         // 充值原因
  }
  ```

### 3. 用户扣款
- **接口**：`POST /admin/users/{user_id}/deduct`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    amount_cents: Number,  // 扣款金额（分）
    reason: String         // 扣款原因
  }
  ```

### 4. 更新用户状态
- **接口**：`PUT /admin/users/{user_id}/status`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    status: String,        // 新状态: active/suspended
    reason: String         // 变更原因
  }
  ```

### 5. 获取用户统计
- **接口**：`GET /admin/users/statistics`
- **权限**：管理员
- **返回**：用户数量和余额统计

### 6. 获取用户详情
- **接口**：`GET /admin/users/{user_id}/detail`
- **权限**：管理员
- **返回**：用户详细信息和统计数据

## 页面布局结构

### 1. 页面头部
- **标题**：用户管理
- **返回按钮**：左上角返回管理页面
- **搜索框**：顶部搜索输入框
- **筛选按钮**：右上角筛选器开关

### 2. 统计信息区域
```
┌─────────────────────────────────────┐
│  📊 用户统计                         │
├─────────────────────────────────────┤
│  总用户：52人    活跃：48人          │
│  拉黑：4人      总余额：¥4,387.50    │
└─────────────────────────────────────┘
```

### 3. 搜索和筛选区域
```
┌─────────────────────────────────────┐
│  🔍 [搜索用户昵称或OpenID...] [🔍]    │
├─────────────────────────────────────┤
│  📋 筛选：[全部状态] ▼ [全部余额] ▼  │
│         [重置]    [应用]            │
└─────────────────────────────────────┘
```

### 4. 用户列表区域
```
┌─────────────────────────────────────┐
│  👤 张三                    ✅ 正常   │
│  💰 余额：¥88.50  📋 订单：15次      │
│  🕒 最后登录：11-26 14:30           │
│  📱 openid: oABC***DEF (已脱敏)      │
├─────────────────────────────────────┤
│  [💰 充值] [📉 扣款] [👁️ 账单] [⚙️ 管理] │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  👤 李四                    🚫 已拉黑 │
│  💰 余额：¥12.00  📋 订单：3次       │
│  🕒 最后登录：11-20 09:15           │
│  📱 openid: oXYZ***UVW (已脱敏)      │
├─────────────────────────────────────┤
│  [🔄 恢复] [👁️ 账单] [⚙️ 管理]        │
└─────────────────────────────────────┘
```

### 5. 操作弹窗
```
充值弹窗：
┌─────────────────────────────────────┐
│  💰 为 张三 充值                     │
├─────────────────────────────────────┤
│  当前余额：¥88.50                   │
│                                     │
│  充值金额：                         │
│  [50] [100] [200] [自定义...]       │
│                                     │
│  充值原因：                         │
│  [________________________]        │
│                                     │
│         [取消]    [确认充值]        │
└─────────────────────────────────────┘

拉黑确认弹窗：
┌─────────────────────────────────────┐
│  ⚠️ 拉黑用户确认                     │
├─────────────────────────────────────┤
│  将要拉黑用户：张三                 │
│  拉黑后用户将无法登录和使用系统      │
│                                     │
│  拉黑原因：                         │
│  [________________________]        │
│                                     │
│         [取消]    [确认拉黑]        │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  检查管理员权限 → 
    加载用户统计 → 
      加载用户列表 → 
        渲染页面内容
```

### 2. 用户搜索流程
```
输入搜索关键词 → 
  实时搜索验证 → 
    调用搜索接口 → 
      更新用户列表 → 
        高亮搜索结果
```

### 3. 余额操作流程
```
点击充值/扣款 → 
  显示操作弹窗 → 
    填写金额和原因 → 
      确认操作 → 
        调用相应接口 → 
          更新用户余额 → 
            刷新列表 → 
              显示操作结果
```

### 4. 状态管理流程
```
点击拉黑/恢复 → 
  显示确认弹窗 → 
    输入操作原因 → 
      确认操作 → 
        调用状态更新接口 → 
          更新用户状态 → 
            刷新列表 → 
              显示操作结果
```

## 权限控制

### 1. 页面访问控制
```javascript
onLoad() {
  if (!this.checkAdminPermission()) {
    wx.showToast({
      title: '权限不足',
      icon: 'none'
    })
    wx.navigateBack()
    return
  }
  this.loadPageData()
}
```

### 2. 操作权限控制
- **所有操作**：仅限管理员执行
- **敏感操作**：拉黑、大额扣款需要额外确认
- **操作日志**：所有操作记录操作员信息

### 3. 数据脱敏
- **OpenID脱敏**：只显示前3位和后3位
- **敏感信息**：不显示完整的用户隐私信息
- **操作记录**：操作原因记录到系统日志

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮
- **操作失败**：显示具体错误信息
- **超时处理**：自动重试或手动刷新

### 2. 业务错误处理
- **余额不足**：扣款时检查余额是否充足
- **用户不存在**：显示用户不存在提示
- **状态冲突**：显示用户状态已变更提示
- **重复操作**：防止重复提交操作

### 3. 操作安全处理
- **危险操作**：大额扣款和拉黑需要二次确认
- **操作记录**：失败操作也要记录日志
- **权限验证**：每次操作都验证管理员权限

## 用户体验优化

### 1. 加载状态管理
- **列表加载**：显示骨架屏
- **操作反馈**：按钮loading状态
- **分页加载**：平滑的分页加载体验

### 2. 搜索体验优化
- **搜索建议**：提供搜索历史建议
- **实时搜索**：输入时实时显示结果
- **搜索高亮**：高亮显示匹配的关键词
- **清空功能**：一键清空搜索内容

### 3. 操作体验优化
- **快捷金额**：充值提供常用金额选项
- **操作确认**：危险操作有明确的确认提示
- **成功反馈**：操作成功后显示明确的反馈
- **撤销功能**：误操作提供撤销机制（预留）

### 4. 视觉体验优化
- **状态指示**：用颜色和图标区分用户状态
- **余额高亮**：余额不足的用户特殊标记
- **排序指示**：显示当前排序方式
- **操作分组**：将相关操作归类显示

## 数据流管理

### 1. 用户列表管理
```javascript
// 加载用户列表
loadUserList() {
  const params = {
    ...this.data.filters,
    keyword: this.data.searchKeyword,
    page: this.data.pageNum,
    size: 20
  }
  
  return this.callAPI('GET', '/admin/users', params)
    .then(users => {
      this.setData({
        users: this.data.pageNum === 1 ? users : [...this.data.users, ...users],
        hasMore: users.length === 20
      })
    })
}
```

### 2. 操作状态管理
```javascript
// 执行用户操作
performUserOperation(userId, operation, params) {
  this.setData({ ['operationModal.submitting']: true })
  
  const endpoint = `/admin/users/${userId}/${operation}`
  return this.callAPI('POST', endpoint, params)
    .then(() => {
      this.hideOperationModal()
      this.refreshUserInList(userId)
      this.showSuccessToast(`${operation}操作成功`)
    })
    .catch(error => {
      this.showErrorToast(error.message)
    })
    .finally(() => {
      this.setData({ ['operationModal.submitting']: false })
    })
}
```

### 3. 搜索状态管理
```javascript
// 搜索用户
onSearchInput(e) {
  const keyword = e.detail.value
  this.setData({ searchKeyword: keyword })
  
  // 防抖搜索
  clearTimeout(this.searchTimer)
  this.searchTimer = setTimeout(() => {
    this.setData({ pageNum: 1 })
    this.loadUserList()
  }, 500)
}
```

## 扩展功能预留

### 1. 批量操作
- **批量充值**：选择多个用户进行批量充值
- **批量状态变更**：批量拉黑或恢复用户
- **批量导出**：导出用户列表和统计数据

### 2. 高级筛选
- **注册时间筛选**：按用户注册时间筛选
- **消费习惯筛选**：按消费频次和金额筛选
- **地区筛选**：如果有地理信息，支持地区筛选

### 3. 数据分析
- **用户画像**：分析用户的消费行为
- **流失分析**：分析用户流失情况
- **价值分析**：按消费金额分析用户价值

### 4. 通信功能
- **消息推送**：向特定用户推送消息
- **公告发布**：发布系统公告
- **客服聊天**：集成客服聊天功能（预留）

## 安全考虑

### 1. 权限安全
- **操作权限**：每个操作都验证管理员权限
- **敏感操作**：重要操作需要额外身份验证
- **操作审计**：所有操作记录详细的审计日志

### 2. 数据安全
- **数据脱敏**：敏感用户信息适度脱敏
- **操作记录**：完整记录管理员操作历史
- **金额验证**：充值扣款金额进行合理性验证

### 3. 业务安全
- **防误操作**：危险操作有明确的确认机制
- **操作限制**：设置单次操作的金额上限
- **异常监控**：监控异常的管理操作

## 性能优化建议

### 1. 数据加载优化
- **分页加载**：用户列表分页加载
- **虚拟列表**：大量用户时使用虚拟滚动
- **数据缓存**：缓存用户列表数据

### 2. 搜索性能优化
- **搜索防抖**：避免频繁搜索请求
- **索引优化**：后端搜索使用合适的索引
- **结果缓存**：缓存常用搜索结果

### 3. 界面性能优化
- **懒加载**：用户头像等资源懒加载
- **组件复用**：列表项组件复用
- **内存管理**：及时清理不用的数据和事件监听

这个页面设计为管理员提供了全面的用户管理功能，支持高效的用户查找、灵活的余额管理和完善的状态控制，是系统管理的核心工具页面。