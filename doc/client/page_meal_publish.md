# 管理员发布餐页面 (meal_publish.js)

## 页面概述

管理员发布餐页面用于管理餐次的完整生命周期。管理员可以发布新餐次、编辑已发布餐次的信息、锁定餐次阻止新订单、完成餐次结算、以及取消餐次并进行退款处理。页面根据餐次当前状态显示不同的操作按钮和表单内容。

## 页面路径
- 文件位置：`client/pages/admin/meal_publish/meal_publish.js`
- 页面路径：`pages/admin/meal_publish/meal_publish`
- 权限要求：管理员身份 + 管理模式开启
- 入口：日历页面点击餐次进入

## 页面功能

### 主要职责
1. **餐次信息展示**：显示餐次基本信息和当前状态
2. **餐次发布**：创建并发布新餐次
3. **餐次编辑**：修改已发布餐次的配置
4. **状态管理**：锁定、完成、取消餐次
5. **订单概览**：查看当前餐次的订单统计

## 页面数据结构

### data 字段
```javascript
{
  meal: Object,            // 餐次详细信息
  addons: Array,           // 可用附加项列表
  loading: Boolean,        // 页面加载状态
  editing: Boolean,        // 是否处于编辑模式
  submitting: Boolean,     // 提交状态
  mealForm: {             // 餐次表单数据
    description: String,   // 餐次描述
    base_price_yuan: Number, // 基础价格（元）
    max_orders: Number,    // 最大订餐数量
    addon_config: Object   // 附加项配置 {addon_id: max_quantity}
  },
  orderStats: {           // 订单统计
    total_orders: Number,  // 总订单数
    total_amount: Number,  // 总金额
    active_orders: Number  // 有效订单数
  }
}
```

### meal 对象结构
```javascript
{
  meal_id: Number,        // 餐次ID
  date: String,          // 日期 YYYY-MM-DD
  slot: String,          // 时段 lunch/dinner
  description: String,    // 餐次描述
  base_price_cents: Number, // 基础价格（分）
  base_price_yuan: Number,  // 基础价格（元）
  addon_config: Object,   // 附加项配置
  max_orders: Number,     // 最大订餐数量
  current_orders: Number, // 当前订单数
  status: String,        // 状态：published/locked/completed/canceled
  updated_at: String     // 更新时间
}
```

## 核心功能模块

### 1. 页面状态判断
根据餐次状态显示不同内容：
- **未发布状态**：显示发布餐表单和发布按钮
- **已发布状态**：显示餐次信息，提供编辑、锁定、取消操作
- **锁定状态**：显示餐次信息，提供完成、取消锁定操作  
- **已完成状态**：仅显示餐次信息，只读模式

### 2. 餐次发布功能
- **餐次描述**：多行文本输入，支持菜品详情
- **基础价格**：数字输入框 + 快捷价格按钮(15元、18元、20元)
- **订餐上限**：数字输入框，默认50人
- **附加项配置**：多选可用附加项（如加鸡腿、不要米饭、少盐等）并设置每个附加项的最大可选数量
- **表单验证**：描述非空、价格正数、上限合理

### 3. 餐次编辑功能
- **编辑按钮**：已发布状态下显示编辑按钮
- **表单预填充**：加载现有餐次数据到表单
- **实时预览**：编辑时显示价格计算预览
- **保存更新**：调用更新接口保存修改

### 4. 状态管理功能
- **锁定餐次**：阻止新订单和订单修改，显示确认弹窗
- **完成餐次**：标记餐次已完成，不可再修改
- **取消锁定**：恢复到已发布状态，允许继续订餐
- **取消餐次**：取消餐次并自动退款，显示确认弹窗

### 5. 订单统计展示
- **订单数量**：显示 当前订单数/最大订单数
- **金额统计**：显示总收入金额
- **下单详情**：跳转到订单列表页面（过滤当前餐次）

## API 调用

参考 `doc/api.md` 中的餐次管理接口：

### 1. 获取餐次信息
- **接口**：`GET /meals/{date}/{slot}`
- **权限**：用户或管理员
- **返回**：餐次详细信息

### 2. 发布餐次
- **接口**：`POST /admin/meals`
- **权限**：管理员
- **参数**：
  ```javascript
  {
    date: String,              // YYYY-MM-DD
    slot: String,              // lunch/dinner
    description: String,       // 餐次描述
    base_price_cents: Number,  // 基础价格（分）
    addon_config: Object,      // 附加项配置
    max_orders: Number         // 最大订单数
  }
  ```

### 3. 更新餐次
- **接口**：`PUT /admin/meals/{meal_id}`
- **权限**：管理员
- **参数**：同发布餐次

### 4. 锁定餐次
- **接口**：`POST /admin/meals/{meal_id}/lock`
- **权限**：管理员

### 5. 完成餐次
- **接口**：`POST /admin/meals/{meal_id}/complete`
- **权限**：管理员

### 6. 取消餐次
- **接口**：`POST /admin/meals/{meal_id}/cancel`
- **权限**：管理员

### 7. 获取可用附加项
- **接口**：`GET /admin/addons?status=active`
- **权限**：管理员
- **返回**：活跃附加项列表

### 8. 获取餐次订单统计
- **接口**：`GET /admin/meals/{meal_id}/stats`
- **权限**：管理员
- **返回**：订单数量和金额统计

## 页面布局结构

### 1. 页面头部
- **标题**：发布餐次 / 编辑餐次（根据状态）
- **返回按钮**：左上角返回日历页面
- **日期时段**：显示当前餐次的日期和时段

### 2. 餐次信息区域
```
┌─────────────────────────────────────┐
│  📅 2024-11-27 午餐                  │
│  状态：已发布 🟢                     │
├─────────────────────────────────────┤
│  📝 餐次描述：                       │
│      红烧肉套餐，配白米饭和汤         │
│                                     │
│  💰 基础价格：¥18.00                 │
│  👥 订餐情况：25/50 人               │
│  📊 [查看下单详情] →                 │
└─────────────────────────────────────┘
```

### 3. 附加项配置区域（发布/编辑模式）
```
┌─────────────────────────────────────┐
│  🍖 附加项配置（可多选）               │
├─────────────────────────────────────┤
│  ☑️ 加鸡腿 ¥3.00    最多: [3] 份     │
│  ☑️ 加饮料 ¥2.00    最多: [1] 份     │
│  ☐ 不要米饭 ¥-1.00   最多: [1] 份    │
│  ☐ 少盐 ¥0.00       最多: [1] 份     │
│                                     │
│  预估总价范围：¥17.00 - ¥24.00      │
│  (含负价格附加项：不要米饭-¥1)        │
└─────────────────────────────────────┘
```

### 4. 操作按钮区域（根据状态显示）
```
未发布状态：
┌─────────────────────────────────────┐
│           [📝 发布餐次]              │
└─────────────────────────────────────┘

已发布状态：
┌─────────────────────────────────────┐
│  [✏️ 编辑]  [🔒 锁定]  [❌ 取消]     │
└─────────────────────────────────────┘

锁定状态：
┌─────────────────────────────────────┐
│     [✅ 完成]  [🔓 取消锁定]         │
└─────────────────────────────────────┘

已完成状态：
┌─────────────────────────────────────┐
│           餐次已完成 ✅              │
└─────────────────────────────────────┘
```

## 交互功能

### 1. 页面加载流程
```
页面加载 → 
  检查管理员权限 → 
    获取日期时段参数 → 
      查询餐次信息 → 
        加载附加项列表 → 
          渲染页面内容
```

### 2. 发布餐次流程
```
填写餐次信息 → 
  选择附加项配置 → 
    表单验证 → 
      调用发布接口 → 
        显示成功提示 → 
          刷新页面数据
```

### 3. 状态变更流程
```
点击状态操作按钮 → 
  显示确认弹窗 → 
    用户确认 → 
      调用相应接口 → 
        更新页面状态 → 
          显示操作结果
```

### 4. 附加项配置流程
```
选中附加项复选框 → 
  设置最大数量 → 
    实时计算价格范围 → 
      更新预估总价显示
```

## 权限控制

### 1. 页面访问控制
```javascript
onLoad() {
  if (!this.checkAdminPermission()) {
    wx.showToast({ title: '权限不足', icon: 'none' })
    wx.navigateBack()
    return
  }
  this.loadMealData()
}
```

### 2. 操作权限控制
- **编辑权限**：仅已发布状态可编辑
- **锁定权限**：仅已发布状态可锁定  
- **完成权限**：仅锁定状态可完成
- **取消权限**：已发布和锁定状态可取消

## 错误处理

### 1. 网络错误处理
- **加载失败**：显示重试按钮和错误信息
- **提交失败**：显示具体错误原因
- **权限错误**：自动返回上一页

### 2. 业务错误处理
- **餐次冲突**：显示"该时段已有餐次"
- **状态冲突**：显示"餐次状态已变更，请刷新"
- **订单约束**：显示"有活跃订单，无法执行操作"
- **余额不足**：显示具体退款失败原因

## 用户体验优化

### 1. 加载状态管理
- **骨架屏**：页面首次加载显示骨架屏
- **按钮Loading**：操作按钮显示loading状态
- **实时反馈**：操作成功后显示toast提示

### 2. 表单交互优化
- **快捷价格**：提供15/18/20元快捷按钮
- **数量选择**：附加项数量支持+/-按钮调节
- **实时预览**：价格范围实时计算显示
- **自动保存**：表单数据本地暂存

### 3. 确认交互
- **危险操作**：锁定、取消餐次显示确认弹窗
- **操作提示**：清晰的操作后果说明
- **状态指示**：用颜色和图标明确表示餐次状态

## 数据流管理

### 1. 页面状态管理
```javascript
// 根据餐次状态控制页面显示
updatePageMode() {
  const { status } = this.data.meal
  this.setData({
    showEditForm: status === 'published',
    showPublishForm: !status,
    showStatusButtons: ['published', 'locked'].includes(status),
    readonly: ['completed', 'canceled'].includes(status)
  })
}
```

### 2. 表单数据同步
```javascript
// 编辑模式时预填充表单
loadMealToForm() {
  const meal = this.data.meal
  this.setData({
    'mealForm.description': meal.description,
    'mealForm.base_price_yuan': meal.base_price_cents / 100,
    'mealForm.max_orders': meal.max_orders,
    'mealForm.addon_config': meal.addon_config || {}
  })
}
```

## 扩展功能预留

### 1. 批量操作
- **批量发布**：选择多个日期批量发布相同餐次
- **模板功能**：保存常用餐次配置为模板

### 2. 高级统计
- **收入分析**：显示附加项收入分布
- **趋势分析**：对比历史同期数据

### 3. 通知功能
- **状态推送**：餐次状态变更时推送通知
- **容量告警**：订单接近上限时提醒

## 安全考虑

### 1. 状态一致性
- **乐观锁**：基于updated_at字段防止并发修改
- **状态验证**：操作前验证餐次状态是否允许
- **事务完整性**：取消餐次时确保退款事务完整

### 2. 数据验证
- **金额验证**：价格必须为正数且合理范围内
- **日期验证**：不允许发布过期日期的餐次
- **容量验证**：最大订单数不能小于当前订单数

### 3. 权限校验
- **双重验证**：前端权限检查+后端接口权限验证
- **操作日志**：记录管理员的重要操作
- **敏感操作**：取消餐次等操作需要二次确认

这个页面设计涵盖了餐次管理的完整生命周期，通过清晰的状态管理和直观的界面设计，让管理员能够高效地管理餐次发布和运营。